<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <link rel="icon" href="/images/favicon-32x32.png"><title>é™é»˜ã®Blog</title><meta name="description" content="é™é»˜çš„Vuepress Blog">
    <link rel="preload" href="/assets/js/runtime~app.2c87fbe0.js" as="script"><link rel="preload" href="/assets/css/styles.b779b927.css" as="style"><link rel="preload" href="/assets/js/95615.aba5921d.js" as="script"><link rel="preload" href="/assets/js/app.4aafd1f6.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.b779b927.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">é™é»˜ã®Blog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="ğŸ“—Menu"><!--[--><!--]--> ğŸ“—Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="ğŸ“—Menu"><!--[--><!--]--> ğŸ“—Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item"></p><ul class=""><li><!--[--><a aria-current="page" href="/sentinel/01%20%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95.html#è®¡æ•°å™¨æ³•" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="è®¡æ•°å™¨æ³•"><!--[--><!--]--> è®¡æ•°å™¨æ³• <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/sentinel/01%20%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95.html#å®ç°" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="å®ç°"><!--[--><!--]--> å®ç° <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/sentinel/01%20%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95.html#æ»‘åŠ¨äº‹ä»¶çª—å£ç®—æ³•" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="æ»‘åŠ¨äº‹ä»¶çª—å£ç®—æ³•"><!--[--><!--]--> æ»‘åŠ¨äº‹ä»¶çª—å£ç®—æ³• <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/sentinel/01%20%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95.html#å®ç°-1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="å®ç°"><!--[--><!--]--> å®ç° <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/sentinel/01%20%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95.html#å‚è€ƒ" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="å‚è€ƒ"><!--[--><!--]--> å‚è€ƒ <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/sentinel/01%20%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95.html#æ¼æ¡¶ç®—æ³•" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="æ¼æ¡¶ç®—æ³•"><!--[--><!--]--> æ¼æ¡¶ç®—æ³• <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/sentinel/01%20%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95.html#å®ç°-2" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="å®ç°"><!--[--><!--]--> å®ç° <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/sentinel/01%20%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95.html#ä»¤ç‰Œæ¡¶ç®—æ³•" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ä»¤ç‰Œæ¡¶ç®—æ³•"><!--[--><!--]--> ä»¤ç‰Œæ¡¶ç®—æ³• <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/sentinel/01%20%E9%99%90%E6%B5%81%E7%AE%97%E6%B3%95.html#å®ç°-3" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="å®ç°"><!--[--><!--]--> å®ç° <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><p><a href="https://github.com/Q10Viking/learncode/tree/main/%E9%99%90%E6%B5%81/calculator/src/main/java/org/hzz" target="_blank" rel="noopener noreferrer">Source Code<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><h2 id="è®¡æ•°å™¨æ³•" tabindex="-1"><a class="header-anchor" href="#è®¡æ•°å™¨æ³•" aria-hidden="true">#</a> è®¡æ•°å™¨æ³•</h2><p>è®¡ç®—å™¨ç®—æ³•æ˜¯ä¸€ç§ç®€å•çš„é™æµç®—æ³•ï¼Œç”¨äºé™åˆ¶ç³»ç»Ÿåœ¨ä¸€å®šæ—¶é—´çª—å£å†…çš„è¯·æ±‚æ¬¡æ•°ï¼Œä»¥é˜²æ­¢ç³»ç»Ÿå› è¿‡å¤šè¯·æ±‚è€Œè¿‡è½½æˆ–å´©æºƒã€‚è¯¥ç®—æ³•é€šå¸¸åŒ…æ‹¬ä¸¤ä¸ªä¸»è¦å‚æ•°ï¼š<strong>é™åˆ¶é˜ˆå€¼å’Œæ—¶é—´çª—å£é—´éš”</strong>ã€‚</p><p><img src="/images/sentinel/image-20230418195859977.png" alt="image-20230418195859977"></p><ul><li>é™åˆ¶é˜ˆå€¼æ˜¯æŒ‡åœ¨ä¸€ä¸ªæ—¶é—´çª—å£å†…å…è®¸é€šè¿‡çš„æœ€å¤§è¯·æ±‚æ•°é‡ï¼Œè¶…è¿‡è¯¥é˜ˆå€¼çš„è¯·æ±‚å°†è¢«é™åˆ¶æˆ–æ‹’ç»ã€‚</li><li>æ—¶é—´çª—å£é—´éš”æ˜¯æŒ‡é™åˆ¶é˜ˆå€¼çš„è®¡æ•°å‘¨æœŸï¼Œå³åœ¨å¤šé•¿æ—¶é—´å†…è®¡ç®—è¯·æ±‚æ¬¡æ•°</li></ul><blockquote><p>è®¡ç®—å™¨ç®—æ³•çš„åŸºæœ¬åŸç†å¦‚ä¸‹ï¼š</p></blockquote><ol><li><p>åˆå§‹åŒ–ä¸€ä¸ªè®¡æ•°å™¨ï¼Œåˆå§‹å€¼ä¸º0ã€‚</p></li><li><p>æ¯å½“ç³»ç»Ÿæ¥æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚ï¼Œè®¡æ•°å™¨çš„å€¼åŠ 1ã€‚</p></li><li><p>åœ¨æ¯ä¸ªæ—¶é—´çª—å£çš„ç»“æŸæ—¶ï¼Œæ£€æŸ¥è®¡æ•°å™¨çš„å€¼æ˜¯å¦è¶…è¿‡äº†é™åˆ¶é˜ˆå€¼ã€‚</p></li><li><p>å¦‚æœè®¡æ•°å™¨çš„å€¼è¶…è¿‡äº†é™åˆ¶é˜ˆå€¼ï¼Œåˆ™é™åˆ¶æˆ–æ‹’ç»è¯¥è¯·æ±‚ã€‚</p></li><li><p>å¦‚æœè®¡æ•°å™¨çš„å€¼æœªè¶…è¿‡é™åˆ¶é˜ˆå€¼ï¼Œåˆ™ç»§ç»­å¤„ç†è¯¥è¯·æ±‚ã€‚</p></li><li><p>åœ¨æ–°çš„æ—¶é—´çª—å£å¼€å§‹æ—¶ï¼Œå°†è®¡æ•°å™¨é‡ç½®ä¸º0ï¼Œå¹¶é‡æ–°å¼€å§‹è®¡æ•°</p></li></ol><p>è®¡ç®—å™¨ç®—æ³•çš„ä¼˜ç‚¹æ˜¯ç®€å•ã€æ˜“äºå®ç°å’Œç†è§£ï¼Œé€‚ç”¨äºå•ä¸ªèŠ‚ç‚¹æˆ–å•ä¸ªå®ä¾‹çš„é™æµåœºæ™¯ã€‚ä½†åŒæ—¶ä¹Ÿæœ‰ä¸€äº›å±€é™æ€§ï¼Œä¾‹å¦‚æ— æ³•å¤„ç†ç¬æ—¶çªå‘è¯·æ±‚ã€ä¸æ”¯æŒåŠ¨æ€è°ƒæ•´é™åˆ¶é˜ˆå€¼ç­‰ã€‚</p><h3 id="å®ç°" tabindex="-1"><a class="header-anchor" href="#å®ç°" aria-hidden="true">#</a> å®ç°</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Calculator</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> limit<span class="token punctuation">;</span> <span class="token comment">// é™åˆ¶é˜ˆå€¼</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> interval<span class="token punctuation">;</span> <span class="token comment">// æ—¶é—´çª—å£é—´éš”</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> counter<span class="token punctuation">;</span> <span class="token comment">// è®¡æ•°å™¨</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> lastResetTime<span class="token punctuation">;</span> <span class="token comment">// ä¸Šæ¬¡é‡ç½®è®¡æ•°å™¨çš„æ—¶é—´</span>

    <span class="token keyword">public</span> <span class="token class-name">Calculator</span><span class="token punctuation">(</span><span class="token keyword">int</span> limit<span class="token punctuation">,</span> <span class="token keyword">long</span> interval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>limit <span class="token operator">=</span> limit<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>interval <span class="token operator">=</span> interval<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lastResetTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">// è¯·æ±‚è®¡æ•°å™¨åŠ 1</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">-</span> lastResetTime <span class="token operator">&gt;=</span> interval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å¦‚æœè·ç¦»ä¸Šæ¬¡é‡ç½®è®¡æ•°å™¨çš„æ—¶é—´è¶…è¿‡äº†æ—¶é—´çª—å£é—´éš”ï¼Œå°±é‡ç½®è®¡æ•°å™¨</span>
            counter<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lastResetTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        counter<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ¤æ–­è¯·æ±‚æ˜¯å¦è¶…è¿‡é™åˆ¶é˜ˆå€¼</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isExceeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> counter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> counter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><blockquote><p>æµ‹è¯•</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CalculatorTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Calculator</span> calculator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Calculator</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆ›å»ºä¸€ä¸ªé™æµå™¨ï¼Œé™åˆ¶é˜ˆå€¼ä¸º5ï¼Œæ—¶é—´çª—å£é—´éš”ä¸º1000ms</span>

        <span class="token comment">// å¯åŠ¨å¤šä¸ªçº¿ç¨‹æ¨¡æ‹Ÿè¯·æ±‚</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ¨¡æ‹Ÿè¯·æ±‚ï¼Œæ¯æ¬¡è¯·æ±‚è®¡æ•°å™¨åŠ 1</span>
                calculator<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>calculator<span class="token punctuation">.</span><span class="token function">isExceeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;é™æµ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                   log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;é€šè¿‡&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¨¡æ‹Ÿè¯·æ±‚é—´éš”</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * 17:33:33.272 [Thread-1] INFO org.hzz.CalculatorTest - é€šè¿‡
 * 17:33:33.272 [Thread-7] INFO org.hzz.CalculatorTest - é™æµ
 * 17:33:33.272 [Thread-5] INFO org.hzz.CalculatorTest - é™æµ
 * 17:33:33.271 [Thread-8] INFO org.hzz.CalculatorTest - é™æµ
 * 17:33:33.271 [Thread-9] INFO org.hzz.CalculatorTest - é™æµ
 * 17:33:33.272 [Thread-4] INFO org.hzz.CalculatorTest - é€šè¿‡
 * 17:33:33.271 [Thread-2] INFO org.hzz.CalculatorTest - é€šè¿‡
 * 17:33:33.272 [Thread-3] INFO org.hzz.CalculatorTest - é€šè¿‡
 * 17:33:33.272 [Thread-0] INFO org.hzz.CalculatorTest - é€šè¿‡
 * 17:33:33.272 [Thread-6] INFO org.hzz.CalculatorTest - é™æµ
 */</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h2 id="æ»‘åŠ¨äº‹ä»¶çª—å£ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#æ»‘åŠ¨äº‹ä»¶çª—å£ç®—æ³•" aria-hidden="true">#</a> æ»‘åŠ¨äº‹ä»¶çª—å£ç®—æ³•</h2><p>æ»‘åŠ¨æ—¶é—´çª—å£ï¼Œåˆç§°rolling windowã€‚ä¸ºäº†è§£å†³è®¡æ•°å™¨æ³•ç»Ÿè®¡ç²¾åº¦å¤ªä½çš„é—®é¢˜ï¼Œå¼•å…¥äº†æ»‘åŠ¨çª—å£ç®—æ³•ã€‚ä¸‹é¢è¿™å¼ å›¾ï¼Œå¾ˆå¥½åœ°è§£é‡Šäº†æ»‘åŠ¨çª—å£ç®—æ³•ï¼š</p><p><img src="D:\Github\q10viking.github.io\docs.vuepress\public\images\sentinel\image-20230418173826032.png" alt="image-20230418173826032"></p><p>å…¶åŸç†æ˜¯åŸºäºä¸€ä¸ªå›ºå®šå¤§å°çš„æ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°æ¥è¿›è¡Œé™æµã€‚æ—¶é—´çª—å£ä¼šæ ¹æ®æ—¶é—´ä¸æ–­æ»‘åŠ¨ï¼Œæ–°çš„è¯·æ±‚ä¼šè¿›å…¥æ—¶é—´çª—å£ï¼Œè€Œè¿‡æœŸçš„è¯·æ±‚ä¼šè¢«ç§»å‡ºæ—¶é—´çª—å£ã€‚</p><ol><li>æ—¶é—´çª—å£å¤§å°ï¼šæ—¶é—´çª—å£çš„å¤§å°å†³å®šäº†é™æµç®—æ³•çš„ç²’åº¦ï¼Œå³åœ¨å¤šé•¿çš„æ—¶é—´æ®µå†…è¿›è¡Œé™æµã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ—¶é—´çª—å£å¤§å°ä¸º1ç§’ï¼Œåˆ™æ¯ç§’å†…åªå…è®¸ä¸€å®šæ•°é‡çš„è¯·æ±‚é€šè¿‡ã€‚</li><li>æœ€å¤§è¯·æ±‚æ•°ï¼šæ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°é™åˆ¶äº†åœ¨æ—¶é—´çª—å£å†…å¯ä»¥é€šè¿‡çš„è¯·æ±‚æ•°é‡ã€‚å¦‚æœè¯·æ±‚çš„æ•°é‡è¶…è¿‡äº†æœ€å¤§è¯·æ±‚æ•°ï¼Œåˆ™ä¼šè¢«é™æµï¼Œæ‹’ç»é€šè¿‡ã€‚</li><li>æ—¶é—´çª—å£æ»‘åŠ¨ï¼šéšç€æ—¶é—´çš„æ¨ç§»ï¼Œæ—¶é—´çª—å£ä¼šä¸æ–­æ»‘åŠ¨ï¼Œè¿‡æœŸçš„è¯·æ±‚ä¼šè¢«ç§»å‡ºæ—¶é—´çª—å£ï¼Œæ–°çš„è¯·æ±‚ä¼šè¿›å…¥æ—¶é—´çª—å£ã€‚è¿™æ ·ï¼Œé™æµç®—æ³•ä¼šä¸æ–­åœ°æ ¹æ®æœ€è¿‘çš„è¯·æ±‚æµé‡æƒ…å†µè¿›è¡Œè°ƒæ•´</li></ol><h3 id="å®ç°-1" tabindex="-1"><a class="header-anchor" href="#å®ç°-1" aria-hidden="true">#</a> å®ç°</h3><p>ç®€å•çš„æ»‘åŠ¨æ—¶é—´çª—å£é™æµç®—æ³•çš„å®ç°æ€è·¯ï¼š</p><ol><li>ä½¿ç”¨ä¸€ä¸ªé˜Ÿåˆ—æ¥ä¿å­˜è¯·æ±‚çš„æ—¶é—´æˆ³ä¿¡æ¯ï¼Œé˜Ÿåˆ—çš„é•¿åº¦ä¸ºæ—¶é—´çª—å£çš„å¤§å°ã€‚</li><li>æ¯æ¬¡æœ‰æ–°çš„è¯·æ±‚åˆ°æ¥æ—¶ï¼Œå…ˆå°†å½“å‰è¯·æ±‚çš„æ—¶é—´æˆ³åŠ å…¥é˜Ÿåˆ—ã€‚</li><li>æ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰è¿‡æœŸçš„è¯·æ±‚ï¼Œå³é˜Ÿåˆ—å¤´éƒ¨çš„è¯·æ±‚æ˜¯å¦è¶…è¿‡äº†æ—¶é—´çª—å£çš„å¤§å°ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä»é˜Ÿåˆ—å¤´éƒ¨ç§»é™¤ã€‚</li><li>ç»Ÿè®¡é˜Ÿåˆ—ä¸­çš„è¯·æ±‚æ•°é‡ï¼Œå³å½“å‰æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ•°é‡ã€‚</li><li>æ£€æŸ¥å½“å‰æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ•°é‡æ˜¯å¦è¶…è¿‡äº†æœ€å¤§è¯·æ±‚æ•°ï¼Œå¦‚æœè¶…è¿‡äº†ï¼Œåˆ™é™æµï¼Œæ‹’ç»é€šè¿‡è¯·æ±‚ï¼›å¦åˆ™ï¼Œå…è®¸é€šè¿‡è¯·æ±‚ã€‚</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SlidingTimeWindowRateLimiter</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> windowSize<span class="token punctuation">;</span> <span class="token comment">// æ—¶é—´çª—å£å¤§å°ï¼Œå•ä½ï¼šç§’</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxRequests<span class="token punctuation">;</span> <span class="token comment">// æ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> requestQueue<span class="token punctuation">;</span> <span class="token comment">// è¯·æ±‚é˜Ÿåˆ—ï¼Œä¿å­˜è¯·æ±‚çš„æ—¶é—´æˆ³ä¿¡æ¯</span>
    <span class="token keyword">public</span> <span class="token class-name">SlidingTimeWindowRateLimiter</span><span class="token punctuation">(</span><span class="token keyword">int</span> windowSize<span class="token punctuation">,</span> <span class="token keyword">int</span> maxRequests<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>windowSize <span class="token operator">=</span> windowSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxRequests <span class="token operator">=</span> maxRequests<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>requestQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">allowRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å½“å‰æ—¶é—´çš„ç§’æ•°</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MICROSECONDS</span><span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// long now = System.currentTimeMillis() / 1000;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>requestQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> now <span class="token operator">-</span> requestQueue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> windowSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            requestQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç§»é™¤è¿‡æœŸçš„è¯·æ±‚</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> maxRequests<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            requestQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å°†å½“å‰è¯·æ±‚çš„æ—¶é—´æˆ³åŠ å…¥é˜Ÿåˆ—</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// å…è®¸é€šè¿‡è¯·æ±‚</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// è¶…è¿‡æœ€å¤§è¯·æ±‚æ•°ï¼Œé™æµ</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><blockquote><p>æµ‹è¯•</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SlidingTimeWindowRateLimiterTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> windowSize <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// æ—¶é—´çª—å£å¤§å°ï¼Œå•ä½ï¼šç§’</span>
        <span class="token keyword">int</span> maxRequests <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token comment">// æ—¶é—´çª—å£å†…å…è®¸çš„æœ€å¤§è¯·æ±‚æ•°</span>
        <span class="token class-name">SlidingTimeWindowRateLimiter</span> rateLimiter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SlidingTimeWindowRateLimiter</span><span class="token punctuation">(</span>windowSize<span class="token punctuation">,</span> maxRequests<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ¨¡æ‹Ÿè¯·æ±‚</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">15</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> finalI <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> allowed <span class="token operator">=</span> rateLimiter<span class="token punctuation">.</span><span class="token function">allowRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;è¯·æ±‚&quot;</span> <span class="token operator">+</span> finalI <span class="token operator">+</span> <span class="token string">&quot; æ˜¯å¦å…è®¸é€šè¿‡: &quot;</span> <span class="token operator">+</span> allowed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¯æ¬¡è¯·æ±‚é—´éš”0.5ç§’</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * 18:24:29.038 [Thread-11] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚12 æ˜¯å¦å…è®¸é€šè¿‡: true
 * 18:24:29.038 [Thread-12] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚13 æ˜¯å¦å…è®¸é€šè¿‡: true
 * 18:24:29.039 [Thread-2] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚3 æ˜¯å¦å…è®¸é€šè¿‡: false
 * 18:24:29.039 [Thread-3] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚4 æ˜¯å¦å…è®¸é€šè¿‡: false
 * 18:24:29.039 [Thread-9] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚10 æ˜¯å¦å…è®¸é€šè¿‡: true
 * 18:24:29.038 [Thread-13] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚14 æ˜¯å¦å…è®¸é€šè¿‡: true
 * 18:24:29.039 [Thread-1] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚2 æ˜¯å¦å…è®¸é€šè¿‡: false
 * 18:24:29.039 [Thread-5] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚6 æ˜¯å¦å…è®¸é€šè¿‡: false
 * 18:24:29.039 [Thread-4] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚5 æ˜¯å¦å…è®¸é€šè¿‡: false
 * 18:24:29.038 [Thread-6] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚7 æ˜¯å¦å…è®¸é€šè¿‡: true
 * 18:24:29.038 [Thread-10] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚11 æ˜¯å¦å…è®¸é€šè¿‡: true
 * 18:24:29.038 [Thread-14] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚15 æ˜¯å¦å…è®¸é€šè¿‡: true
 * 18:24:29.039 [Thread-7] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚8 æ˜¯å¦å…è®¸é€šè¿‡: true
 * 18:24:29.038 [Thread-0] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚1 æ˜¯å¦å…è®¸é€šè¿‡: true
 * 18:24:29.039 [Thread-8] INFO org.hzz.slidewindow.SlidingTimeWindowRateLimiterTest - è¯·æ±‚9 æ˜¯å¦å…è®¸é€šè¿‡: true
 */</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="å‚è€ƒ" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒ" aria-hidden="true">#</a> å‚è€ƒ</h3><p><a href="https://cloud.tencent.com/developer/article/1757728" target="_blank" rel="noopener noreferrer">Java å®ç°æ»‘åŠ¨æ—¶é—´çª—å£é™æµç®—æ³•ï¼Œä½ è§è¿‡å—ï¼Ÿ - è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><h2 id="æ¼æ¡¶ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#æ¼æ¡¶ç®—æ³•" aria-hidden="true">#</a> æ¼æ¡¶ç®—æ³•</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå›ºå®šå®¹é‡çš„æ¡¶ï¼Œæœ‰æ°´æµè¿›æ¥ï¼Œä¹Ÿæœ‰æ°´æµå‡ºå»ã€‚å¯¹äºæµè¿›æ¥çš„æ°´æ¥è¯´ï¼Œæˆ‘ä»¬æ— æ³•é¢„è®¡ä¸€å…±æœ‰å¤šå°‘æ°´ä¼šæµè¿›æ¥ï¼Œä¹Ÿæ— æ³•é¢„è®¡æ°´æµçš„é€Ÿåº¦ã€‚ä½†æ˜¯å¯¹äºæµå‡ºå»çš„æ°´æ¥è¯´ï¼Œè¿™ä¸ªæ¡¶å¯ä»¥å›ºå®šæ°´æµå‡ºçš„é€Ÿç‡ã€‚è€Œä¸”ï¼Œå½“æ¡¶æ»¡äº†ä¹‹åï¼Œå¤šä½™çš„æ°´å°†ä¼šæº¢å‡ºã€‚</p><p>æˆ‘ä»¬å°†ç®—æ³•ä¸­çš„æ°´æ¢æˆå®é™…åº”ç”¨ä¸­çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¼æ¡¶ç®—æ³•å¤©ç”Ÿå°±é™åˆ¶äº†è¯·æ±‚çš„é€Ÿåº¦ã€‚å½“ä½¿ç”¨äº†æ¼æ¡¶ç®—æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä¿è¯æ¥å£ä¼šä»¥ä¸€ä¸ªå¸¸é€Ÿé€Ÿç‡æ¥å¤„ç†è¯·æ±‚ã€‚æ‰€ä»¥æ¼æ¡¶ç®—æ³•å¤©ç”Ÿä¸ä¼šå‡ºç°ä¸´ç•Œé—®é¢˜ã€‚</p><p><img src="/images/sentinel/image-20230418183118586.png" alt="image-20230418183118586"></p><h3 id="å®ç°-2" tabindex="-1"><a class="header-anchor" href="#å®ç°-2" aria-hidden="true">#</a> å®ç°</h3><ol><li>æ¼æ¡¶æœ‰ä¸€ä¸ªå›ºå®šçš„å®¹é‡ï¼Œè¡¨ç¤ºæ¼æ¡¶èƒ½å¤Ÿå­˜å‚¨çš„æœ€å¤§è¯·æ±‚æ•°é‡ã€‚</li><li>æ¼æ¡¶ä»¥å›ºå®šçš„é€Ÿç‡æµå‡ºè¯·æ±‚ï¼Œè¡¨ç¤ºæ¼æ¡¶æ¯å•ä½æ—¶é—´å†…èƒ½å¤Ÿå¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚</li><li>å½“è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå…ˆæ£€æŸ¥æ¼æ¡¶ä¸­æ˜¯å¦è¿˜æœ‰ç©ºé—´ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¯·æ±‚è¢«ä¸¢å¼ƒï¼›å¦‚æœæœ‰ç©ºé—´ï¼Œåˆ™è¯·æ±‚è¢«æ”¾å…¥æ¼æ¡¶ä¸­ã€‚</li><li>æ¼æ¡¶æŒ‰ç…§å›ºå®šçš„é€Ÿç‡æµå‡ºè¯·æ±‚ï¼Œå¦‚æœæ¼æ¡¶ä¸­æœ‰è¯·æ±‚ï¼Œåˆ™æ¯å•ä½æ—¶é—´å†…ä¼šä»æ¼æ¡¶ä¸­æµå‡ºä¸€å®šæ•°é‡çš„è¯·æ±‚ã€‚</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LeakyBucket</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span> <span class="token comment">// æ¼æ¡¶çš„å®¹é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> rate<span class="token punctuation">;</span> <span class="token comment">// æ¼æ¡¶çš„æµå‡ºé€Ÿç‡</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> water<span class="token punctuation">;</span> <span class="token comment">// å½“å‰æ¼æ¡¶ä¸­çš„æ°´é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastTime<span class="token punctuation">;</span> <span class="token comment">// ä¸Šæ¬¡æ¼æ°´çš„æ—¶é—´æˆ³</span>

    <span class="token keyword">public</span> <span class="token class-name">LeakyBucket</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">,</span> <span class="token keyword">int</span> rate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rate <span class="token operator">=</span> rate<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>water <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lastTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¯·æ±‚æ¼æ¡¶ä¸­çš„æ°´ï¼Œè¿”å›æ˜¯å¦é€šè¿‡æ¼æ¡¶</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è®¡ç®—è·ç¦»ä¸Šæ¬¡æ¼æ°´çš„æ—¶é—´</span>
        <span class="token keyword">long</span> timeElapsed <span class="token operator">=</span> now <span class="token operator">-</span> lastTime<span class="token punctuation">;</span>
        <span class="token comment">// è®¡ç®—æ¼å‡ºçš„æ°´é‡</span>
        <span class="token keyword">int</span> waterOut <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>timeElapsed <span class="token operator">*</span> rate <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ›´æ–°æ¼æ¡¶ä¸­çš„æ°´é‡å’Œä¸Šæ¬¡æ¼æ°´çš„æ—¶é—´</span>
        water <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> water <span class="token operator">-</span> waterOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lastTime <span class="token operator">=</span> now<span class="token punctuation">;</span>

        <span class="token comment">// åˆ¤æ–­æ¼æ¡¶ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„å®¹é‡æ”¾å…¥æ–°çš„è¯·æ±‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>water <span class="token operator">&lt;</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            water<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// æ¼æ¡¶é€šè¿‡ï¼Œè¯·æ±‚è¢«å¤„ç†</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// æ¼æ¡¶å·²æ»¡ï¼Œè¯·æ±‚è¢«ä¸¢å¼ƒ</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LeakyBucket</span> bucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LeakyBucket</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¼æ¡¶å®¹é‡ä¸º10ï¼Œæµå‡ºé€Ÿç‡ä¸º2ä¸ªè¯·æ±‚/ç§’</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¨¡æ‹Ÿ20ä¸ªè¯·æ±‚</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è¯·æ±‚&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;ï¼š&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>result <span class="token operator">?</span> <span class="token string">&quot;é€šè¿‡&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;ä¸¢å¼ƒ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// æ¨¡æ‹Ÿæ¯éš”500æ¯«ç§’å‘èµ·ä¸€ä¸ªè¯·æ±‚</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><h2 id="ä»¤ç‰Œæ¡¶ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#ä»¤ç‰Œæ¡¶ç®—æ³•" aria-hidden="true">#</a> ä»¤ç‰Œæ¡¶ç®—æ³•</h2><p>åœ¨è¿™ä¸ªç®—æ³•ä¸­ï¼Œç³»ç»Ÿä¼šç»´æŠ¤ä¸€ä¸ªå›ºå®šå®¹é‡çš„ä»¤ç‰Œæ¡¶ï¼Œæ¯ä¸ªä»¤ç‰Œè¡¨ç¤ºç³»ç»Ÿå…è®¸å¤„ç†ä¸€ä¸ªè¯·æ±‚çš„æƒåˆ©ã€‚ä»¤ç‰ŒæŒ‰ç…§å›ºå®šçš„é€Ÿç‡ä»¥æ’å®šçš„é€Ÿåº¦å¾€æ¡¶ä¸­ç”Ÿæˆï¼Œè€Œè¯·æ±‚éœ€è¦ä»æ¡¶ä¸­å–èµ°ä¸€ä¸ªä»¤ç‰Œæ‰èƒ½è¢«å¤„ç†ã€‚</p><p>å½“ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾æ—¶ï¼Œç³»ç»Ÿé¦–å…ˆæ£€æŸ¥æ¡¶ä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œå¯ä¾›è¯·æ±‚å–èµ°ã€‚å¦‚æœæœ‰è¶³å¤Ÿçš„ä»¤ç‰Œï¼Œåˆ™è¯·æ±‚å¯ä»¥è¢«å¤„ç†ï¼Œå¹¶ä¸”ä»æ¡¶ä¸­å–èµ°ä¸€ä¸ªä»¤ç‰Œã€‚å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œï¼Œåˆ™è¯·æ±‚æ— æ³•è¢«å¤„ç†ï¼Œé™¤éæ¡¶ä¸­ç”Ÿæˆäº†æ–°çš„ä»¤ç‰Œã€‚è¿™æ ·å¯ä»¥å®ç°å¯¹è¯·æ±‚çš„æµé‡è¿›è¡Œæ§åˆ¶ï¼Œé™åˆ¶ç³»ç»Ÿåœ¨ä¸€å®šæ—¶é—´å†…å¯ä»¥å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œé˜²æ­¢ç³»ç»Ÿè¢«è¿‡å¤šçš„è¯·æ±‚å‹å®ã€‚</p><p><img src="/images/sentinel/image-20230418195803027.png" alt="image-20230418195803027"></p><h3 id="å®ç°-3" tabindex="-1"><a class="header-anchor" href="#å®ç°-3" aria-hidden="true">#</a> å®ç°</h3><ol><li>å®šä¹‰ä»¤ç‰Œæ¡¶çš„å®¹é‡ï¼šä»¤ç‰Œæ¡¶æœ‰ä¸€ä¸ªå›ºå®šçš„å®¹é‡ï¼Œè¡¨ç¤ºç³»ç»Ÿåœ¨ä»»æ„æ—¶åˆ»èƒ½å¤Ÿå¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°é‡ã€‚</li><li>å®šä¹‰ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ï¼šä»¤ç‰Œæ¡¶æœ‰ä¸€ä¸ªå›ºå®šçš„ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ï¼Œè¡¨ç¤ºç³»ç»Ÿæ¯ç§’é’Ÿç”Ÿæˆçš„ä»¤ç‰Œæ•°é‡ã€‚</li><li>åˆå§‹åŒ–ä»¤ç‰Œæ¡¶ï¼šåœ¨å¯åŠ¨æ—¶ï¼Œå°†ä»¤ç‰Œæ¡¶åˆå§‹åŒ–ä¸ºæ»¡æ¡¶çŠ¶æ€ï¼Œå³å®¹é‡å†…åŒ…å«æ‰€æœ‰çš„ä»¤ç‰Œã€‚</li><li>è¯·æ±‚ä»¤ç‰Œï¼šå½“ä¸€ä¸ªè¯·æ±‚åˆ°è¾¾æ—¶ï¼Œéœ€è¦ä»ä»¤ç‰Œæ¡¶ä¸­è·å–ä¸€ä¸ªä»¤ç‰Œï¼Œè¡¨ç¤ºä¸€ä¸ªè¯·æ±‚è¢«å…è®¸æ‰§è¡Œã€‚</li><li>åˆ¤æ–­ä»¤ç‰Œæ¡¶æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œï¼šå¦‚æœä»¤ç‰Œæ¡¶ä¸­æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œï¼Œåˆ™å…è®¸è¯·æ±‚æ‰§è¡Œï¼Œå¹¶ä»ä»¤ç‰Œæ¡¶ä¸­å‡å»ä¸€ä¸ªä»¤ç‰Œã€‚</li><li>åˆ¤æ–­ä»¤ç‰Œæ¡¶æ˜¯å¦ä¸ºç©ºï¼šå¦‚æœä»¤ç‰Œæ¡¶ä¸ºç©ºï¼Œåˆ™æ‹’ç»è¯·æ±‚æ‰§è¡Œï¼Œå› ä¸ºç³»ç»Ÿåœ¨å½“å‰æ—¶åˆ»æ— æ³•å¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚</li><li>ä»¤ç‰Œç”Ÿæˆï¼šä»¤ç‰Œæ¡¶ä¼šæ ¹æ®è®¾å®šçš„ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ï¼Œå®šæœŸï¼ˆå¦‚æ¯ç§’é’Ÿï¼‰ç”Ÿæˆä¸€å®šæ•°é‡çš„ä»¤ç‰Œï¼Œæ·»åŠ åˆ°ä»¤ç‰Œæ¡¶ä¸­ï¼Œä»¥ä¾›åç»­è¯·æ±‚ä½¿ç”¨ã€‚</li><li>æ§åˆ¶è¯·æ±‚é€Ÿç‡ï¼šé€šè¿‡è°ƒæ•´ä»¤ç‰Œç”Ÿæˆé€Ÿç‡å’Œä»¤ç‰Œæ¡¶çš„å®¹é‡ï¼Œå¯ä»¥æ§åˆ¶è¯·æ±‚çš„è®¿é—®é€Ÿç‡ï¼Œä»è€Œå®ç°é™æµçš„æ•ˆæœã€‚</li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenBucket</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> capacity<span class="token punctuation">;</span> <span class="token comment">// ä»¤ç‰Œæ¡¶å®¹é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span> rate<span class="token punctuation">;</span> <span class="token comment">// ç”Ÿæˆä»¤ç‰Œçš„é€Ÿç‡</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicLong</span> tokens<span class="token punctuation">;</span> <span class="token comment">// å½“å‰ä»¤ç‰Œæ•°é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastRefillTime<span class="token punctuation">;</span> <span class="token comment">// ä¸Šæ¬¡å¡«å……ä»¤ç‰Œçš„æ—¶é—´</span>

    <span class="token keyword">public</span> <span class="token class-name">TokenBucket</span><span class="token punctuation">(</span><span class="token keyword">long</span> capacity<span class="token punctuation">,</span> <span class="token keyword">double</span> rate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rate <span class="token operator">=</span> rate<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tokens <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span>capacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lastRefillTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è·å–ä»¤ç‰Œï¼Œè¿”å›trueè¡¨ç¤ºæˆåŠŸè·å–åˆ°ä»¤ç‰Œï¼Œè¿”å›falseè¡¨ç¤ºæœªè·å–åˆ°ä»¤ç‰Œ</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">refillTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¡«å……ä»¤ç‰Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tokens<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tokens<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å–èµ°ä¸€ä¸ªä»¤ç‰Œ</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œå¯ç”¨ï¼Œè¿”å›trueè¡¨ç¤ºæœ‰è¶³å¤Ÿçš„ä»¤ç‰Œï¼Œè¿”å›falseè¡¨ç¤ºä»¤ç‰Œä¸è¶³</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">checkToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">refillTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¡«å……ä»¤ç‰Œ</span>
        <span class="token keyword">return</span> tokens<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å¡«å……ä»¤ç‰Œ</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refillTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> elapsedTime <span class="token operator">=</span> <span class="token punctuation">(</span>currentTime <span class="token operator">-</span> lastRefillTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span><span class="token punctuation">;</span> <span class="token comment">// è®¡ç®—ç»è¿‡çš„æ—¶é—´ï¼ˆç§’ï¼‰</span>
        <span class="token keyword">long</span> tokensToAdd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>elapsedTime <span class="token operator">*</span> rate<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è®¡ç®—éœ€è¦æ·»åŠ çš„ä»¤ç‰Œæ•°é‡</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>tokensToAdd <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä½¿ç”¨CASåŸå­æ“ä½œæ›´æ–°ä»¤ç‰Œæ•°é‡</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> currentTokens <span class="token operator">=</span> tokens<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> newTokens <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>currentTokens <span class="token operator">+</span> tokensToAdd<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ä¸è¶…è¿‡ä»¤ç‰Œæ¡¶å®¹é‡</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tokens<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>currentTokens<span class="token punctuation">,</span> newTokens<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lastRefillTime <span class="token operator">=</span> currentTime<span class="token punctuation">;</span> <span class="token comment">// æ›´æ–°ä¸Šæ¬¡å¡«å……ä»¤ç‰Œçš„æ—¶é—´</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><blockquote><p>æµ‹è¯•</p></blockquote><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenBucketTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">THREAD_COUNT</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// æµ‹è¯•çº¿ç¨‹æ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">REQUESTS_PER_THREAD</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// æ¯ä¸ªçº¿ç¨‹å‘é€çš„è¯·æ±‚æ•°é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token constant">REQUEST_INTERVAL_MS</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span> <span class="token comment">// è¯·æ±‚é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CAPACITY</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// ä»¤ç‰Œæ¡¶å®¹é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> <span class="token constant">RATE</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token comment">// ä»¤ç‰Œç”Ÿæˆé€Ÿç‡</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TokenBucket</span> tokenBucket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenBucket</span><span class="token punctuation">(</span><span class="token constant">CAPACITY</span><span class="token punctuation">,</span> <span class="token constant">RATE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token constant">THREAD_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºå¤šä¸ªæµ‹è¯•çº¿ç¨‹</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">THREAD_COUNT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token constant">REQUESTS_PER_THREAD</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æ¨¡æ‹Ÿå‘é€è¯·æ±‚</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>tokenBucket<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Thread {} - Request {}: Got token&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Thread {} - Request {}: No token&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token constant">REQUEST_INTERVAL_MS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * 20:26:45.546 [pool-1-thread-2] INFO org.hzz.tokenbucket.TokenBucketTest - Thread 13 - Request 10: Got token
 * 20:26:45.546 [pool-1-thread-8] INFO org.hzz.tokenbucket.TokenBucketTest - Thread 19 - Request 10: Got token
 * 20:26:45.610 [pool-1-thread-10] INFO org.hzz.tokenbucket.TokenBucketTest - Thread 21 - Request 11: No token
 * 20:26:45.610 [pool-1-thread-9] INFO org.hzz.tokenbucket.TokenBucketTest - Thread 20 - Request 11: Got token
 * 20:26:45.610 [pool-1-thread-5] INFO org.hzz.tokenbucket.TokenBucketTest - Thread 16 - Request 11: No token
 * 20:26:45.610 [pool-1-thread-3] INFO org.hzz.tokenbucket.TokenBucketTest - Thread 14 - Request 11: No token
 * 20:26:45.610 [pool-1-thread-7] INFO org.hzz.tokenbucket.TokenBucketTest - Thread 18 - Request 11: Got token
 * 20:26:45.610 [pool-1-thread-8] INFO org.hzz.tokenbucket.TokenBucketTest - Thread 19 - Request 11: Got token
 * 20:26:45.610 [pool-1-thread-1] INFO org.hzz.tokenbucket.TokenBucketTest - Thread 12 - Request 11: No token
 */</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> â† <a href="/sentinel/" class="nav-link router-link-active" aria-label="Back To ç›®å½•"><!--[--><!--]--> Back To ç›®å½• <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.2c87fbe0.js" defer></script><script src="/assets/js/95615.aba5921d.js" defer></script><script src="/assets/js/app.4aafd1f6.js" defer></script>
  </body>
</html>
