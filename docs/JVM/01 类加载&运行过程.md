---
sidebarDepth: 3
sidebar: auto
prev:
  text: Back To ç›®å½•
  link: /JVM/
typora-root-url: ..\.vuepress\public
---



::: tip

[Source Code](https://github.com/Q10Viking/learncode/tree/main/jvm/_01_jvm_classload)

:::

## javaç¨‹åºå¯åŠ¨åº•å±‚å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

::: tip

åœ¨æ§åˆ¶å°è¾“å…¥ java org.hzz.Math

:::

![image-20220817175748092](/images/jvm/image-20220817175748092.png)

::: details Math.java

```java
public class Math {
    public static final int initData = 666;
    public static User user = new User();

    public int compute() {  //ä¸€ä¸ªæ–¹æ³•å¯¹åº”ä¸€å—æ ˆå¸§å†…å­˜åŒºåŸŸ
        int a = 1;
        int b = 2;
        int c = (a + b) * 10;
        return c;
    }

    public static void main(String[] args) {
        Math math = new Math();
        math.compute();
        System.out.println("Hello JVM");
    }
}
```

:::

```sh
D:\learncode\jvm\_01_jvm_classload\target\classes> java org.hzz.Math
Hello JVM
```

1. åˆ›å»ºjavaè™šæ‹Ÿæœºï¼ˆJVMï¼‰

2. JVMåˆ›å»ºå¼•å¯¼ç±»åŠ è½½å™¨

3. å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½å¹¶å®ä¾‹åŒ–sun.misc.Launcher  (`This class is used by the system to launch the main application.`)

4. åœ¨Launcheræ„é€ æ–¹æ³•å†…éƒ¨ï¼Œå…¶åˆ›å»ºäº†ä¸¤ä¸ªç±»åŠ è½½å™¨**ExtClassLoader,AppClassLoader**

::: details Launcher.java

   ```java
   /**
    * This class is used by the system to launch the main application.
   Launcher */
   public class Launcher {
       private static Launcher launcher = new Launcher();
       private ClassLoader loader;
       public Launcher() {
               // Create the extension class loader
               ClassLoader extcl;
               try {
                   extcl = ExtClassLoader.getExtClassLoader();
               } catch (IOException e) {
                   throw new InternalError(
                       "Could not create extension class loader", e);
               }
   
               // Now create the class loader to use to launch the application
               try {
                   loader = AppClassLoader.getAppClassLoader(extcl);
               } catch (IOException e) {
                   throw new InternalError(
                       "Could not create application class loader", e);
               }
               // Also set the context class loader for the primordial thread.
               Thread.currentThread().setContextClassLoader(loader);
           // ... 
       }
       // ...
       /*
        * Returns the class loader used to launch the main application.
        */
       public ClassLoader getClassLoader() {
           return loader;
       }
   }
   ```
:::

5. JVMé»˜è®¤ä½¿ç”¨Launcherçš„getClassLoader()æ–¹æ³•è¿”å›çš„ç±»åŠ è½½å™¨AppClassLoaderçš„å®ä¾‹åŠ è½½æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼ˆå¦‚Mathï¼‰
6. åŠ è½½å®ŒæˆåJVMä¼šæ‰§è¡ŒMathç±»çš„mainæ–¹æ³•

![img](/images/jvm/102280)

### Hotspotæºç JVMå¯åŠ¨mainæ–¹æ³•æµç¨‹

1. åˆ›å»ºjavaè™šæ‹Ÿæœºï¼ˆJVMï¼‰

2. JVMåˆ›å»ºå¼•å¯¼ç±»åŠ è½½å™¨

3. å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½å¹¶å®ä¾‹åŒ–sun.misc.Launcher  (`This class is used by the system to launch the main application.`)

4. åœ¨Launcheræ„é€ æ–¹æ³•å†…éƒ¨ï¼Œå…¶åˆ›å»ºäº†ä¸¤ä¸ªç±»åŠ è½½å™¨**ExtClassLoader,AppClassLoader**

![img](/images/jvm/106918.png)

## 

> éªŒè¯Launcheræ˜¯è¢«å¼•å¯¼ç±»åŠ è½½å™¨åŠ è½½çš„

```java
public class LauncherTest {
    public static void main(String[] args) {
        System.out.println(LauncherTest.class.getClassLoader());
        System.out.println(Launcher.class.getClassLoader());
    }
}
/**
 * sun.misc.Launcher$AppClassLoader@18b4aac2
 * null
 */
```



----------



## ç±»åŠ è½½å…¨è¿‡ç¨‹â­

> ç±»çš„å®Œå…¨åŠ è½½è¿‡ç¨‹ï¼š**åŠ è½½ >> éªŒè¯ >> å‡†å¤‡ >> è§£æ >> åˆå§‹åŒ–**ï¼Œï¼ˆåªæ‰§è¡Œä¸€éï¼‰

```java
protected Class<?> loadClass(String name, boolean resolve)
        throws ClassNotFoundException
    {
    }
```

![image-20210325020601096](/images/jvm/image-20210325020601096.png)



::: tip

**åŠ è½½**ï¼šåœ¨ç¡¬ç›˜ä¸ŠæŸ¥æ‰¾å¹¶é€šè¿‡IOè¯»å…¥å­—èŠ‚ç æ–‡ä»¶ï¼Œä½¿ç”¨åˆ°ç±»æ—¶æ‰ä¼šåŠ è½½ï¼Œä¾‹å¦‚è°ƒç”¨ç±»çš„main()æ–¹æ³•ï¼Œnewå¯¹è±¡ç­‰ç­‰ï¼Œåœ¨åŠ è½½é˜¶æ®µä¼šåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ª**ä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡**ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£

â¤ï¸æ³¨æ„ï¼šç»è¿‡å°½ç®¡è°ƒç”¨äº†loadClassï¼Œä½†æ˜¯å¦‚æœä¸ä½¿ç”¨ï¼Œå®ƒæ¨¡å¼æ˜¯æ‡’åŠ è½½çš„ï¼ˆ**å³ä¸ä¼šåˆå§‹åŒ–**ï¼‰ã€‚

:::

1. éªŒè¯ï¼šæ ¡éªŒclasså­—èŠ‚ç æ–‡ä»¶ç¬¦åˆjavaè§„èŒƒ

   1. å¦‚å¼€å¤´æ˜¯ä»¥ cafe babe

2. å‡†å¤‡ï¼š**é™æ€å˜é‡**åˆ†é…å†…å­˜ï¼Œ**åˆå§‹å€¼èµ‹å€¼ï¼Œèµ‹äºˆé»˜è®¤å€¼**

   1. int é»˜è®¤å€¼0ï¼Œboolean é»˜è®¤å€¼ false

   2. å¼•ç”¨ç±»å‹åˆ™null

3. è§£æ

   1. **é™æ€é“¾æ¥**ï¼Œ**å°†ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨**ï¼Œ**é™æ€æ–¹æ³•**æ›¿æ¢ä¸ºæŒ‡å‘æ•°æ®æ‰€å­˜çš„å†…å­˜åœ°å€æˆ–å¥æŸ„ï¼›æé«˜æ•ˆç‡ï¼Œ**ä¸ä¼šå˜ï¼ˆèƒ½å¤Ÿç¡®å®šå†…å­˜çš„åœ°å€ä½ç½®ï¼‰**,**ç¬¦å·å¼•ç”¨ï¼ˆå­—é¢ç¬¦å·é‡ï¼‰**å¦‚ï¼šmainæ–¹æ³•ï¼Œç±»åç§°
   2. **åŠ¨æ€é“¾æ¥**ï¼Œåœ¨**è¿è¡ŒæœŸé—´**å®Œæˆ**ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨**ï¼Œå¦‚å®ä¾‹æ–¹æ³•çš„è°ƒç”¨ï¼Œæ‰¾åˆ°å†…å­˜ä½ç½®ï¼Œ**ä¼šå˜**ï¼Œç›´åˆ°è¿è¡Œæ—¶æ‰çŸ¥é“æŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œå¦‚**å¤šæ€ï¼Œæ¥å£**çš„å½±å“ã€‚
   3. classå­—èŠ‚ç ä¸­Constant pool**å¸¸é‡æ± **(**å­—é¢ç¬¦å·é‡**)ï¼Œè¿™äº›æœ€ç»ˆä¼šè¢«åŠ è½½åˆ° JVMå†…å­˜ä¸­ï¼Œå°±ä¼šå­˜åœ¨åœ°å€
      1. å¸¸é‡æ± ä¸­ï¼š #12 ä¸º**æ ‡è¯†ç¬¦**  **å­—é¢ç¬¦å·é‡**

4. åˆå§‹åŒ–ï¼ˆâ¤ï¸ç±»é»˜è®¤æ˜¯æ‡’åŠ è½½ï¼Œå¦‚æœä¸ä½¿ç”¨è¯¥ç±»ï¼Œåˆå§‹åŒ–æ–¹æ³•ä¸ä¼šè¢«è§¦å‘â¤ï¸ï¼‰

   1. **é™æ€å˜é‡åˆå§‹åŒ–ä¸ºæŒ‡å®šçš„å€¼**ï¼›

      1. > static int a = 3;

   2. **æ‰§è¡Œé™æ€ä»£ç å—**ï¼›

      1. > static{ //... }

::: tip

ç±»è¢«åŠ è½½åˆ°**æ–¹æ³•åŒº**ä¸­åä¸»è¦åŒ…å« **è¿è¡Œæ—¶å¸¸é‡æ± ã€ç±»å‹ä¿¡æ¯ã€å­—æ®µä¿¡æ¯ã€æ–¹æ³•ä¿¡æ¯ã€ç±»åŠ è½½å™¨çš„å¼•ç”¨ã€å¯¹åº”classå®ä¾‹çš„å¼•ç”¨**ç­‰ä¿¡æ¯

:::

**ç±»åŠ è½½å™¨çš„å¼•ç”¨**ï¼šè¿™ä¸ªç±»åˆ°ç±»åŠ è½½å™¨å®ä¾‹çš„å¼•ç”¨

**å¯¹åº”classå®ä¾‹çš„å¼•ç”¨**ï¼šâ¤ï¸ç±»åŠ è½½å™¨åœ¨**åŠ è½½ç±»ä¿¡æ¯**æ”¾åˆ°æ–¹æ³•åŒºä¸­åï¼Œä¼šåˆ›å»º**ä¸€ä¸ªå¯¹åº”çš„Class ç±»å‹çš„å¯¹è±¡å®ä¾‹**æ”¾åˆ°å †(Heap)ä¸­â¤ï¸, ä½œä¸ºå¼€å‘äººå‘˜è®¿é—®æ–¹æ³•åŒºä¸­**ç±»å®šä¹‰**çš„å…¥å£å’Œåˆ‡å…¥ç‚¹



## ç±»çš„æ‡’åŠ è½½ï¼ˆæ‡’åˆå§‹åŒ–ï¼‰â¤ï¸

::: tip

ç±»çš„å®Œå…¨åŠ è½½è¿‡ç¨‹ï¼š**åŠ è½½ >> éªŒè¯ >> å‡†å¤‡ >> è§£æ >> åˆå§‹åŒ–**ï¼Œï¼ˆåªæ‰§è¡Œä¸€éï¼‰è€Œç±»çš„æ‡’åŠ è½½ä¸»è¦æ˜¯ä½“ç°åœ¨æ‡’åˆå§‹åŒ–ä¸Šã€‚

jaråŒ…æˆ–è€…waråŒ…é‡Œé¢çš„ç±»**ä¸æ˜¯ä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½çš„**ï¼Œä½¿ç”¨åˆ°æ—¶æ‰ä¼šè¢«åŠ è½½

â¤ï¸**ä¸»ç±»åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¦‚æœä½¿ç”¨åˆ°å…¶å®ƒç±»ï¼Œä¼šé€æ­¥åŠ è½½è¿™äº›ç±»,å¹¶ä¸”é»˜è®¤ä½¿ç”¨çš„ç±»åŠ è½½å™¨æ˜¯åŠ è½½è¯¥ä¸»ç±»æ—¶çš„ç±»åŠ è½½å™¨**â¤ï¸

:::

> ä¸‹é¢è¿™ä¸ªç¨‹åºéªŒè¯ï¼š1. ç±»åŠ è½½è¿‡ç¨‹åˆå§‹åŒ–çš„éªŒè¯  2. æ‡’åŠ è½½
>
> â¤ï¸å¯ä»¥çœ‹åˆ°é™æ€å˜é‡Aå’Œé™æ€ä»£ç å—æ‰§è¡Œäº†ï¼Œä½†æ˜¯Då’ŒCå¹¶æ²¡æœ‰è¢«åŠ è½½ã€‚â¤ï¸

```java
public class TestDynamicLoad {
    public static A a = new A();

    static {
        System.out.println("*************load TestDynamicLoad*******************");
    }

    public D d = new D();

    public static void main(String[] args) {
        System.out.println("*************main method****************************");
        B b = new B();
        C c = null;
    }
}

class A {
    static {
        System.out.println("*************load A*********************************");
    }
}

class B {
    static {
        System.out.println("*************load B*********************************");
    }
}

class C {
    static {
        System.out.println("*************load C*********************************");
    }
}

class D {
    static {
        System.out.println("*************load D*********************************");
    }
}
/**
 * *************load A*********************************
 * *************load TestDynamicLoad*******************
 * *************main method****************************
 * *************load B*********************************
 */
```



### ç±»åŠ è½½åˆå§‹åŒ–æ—¶æœºğŸ˜Š

::: tip

ç±»é»˜è®¤æ˜¯æ‡’åŠ è½½æœºåˆ¶ï¼Œåªæœ‰ä½¿ç”¨åˆ°äº†çš„æ—¶å€™æ‰ä¼šè¿›è¡ŒåŠ è½½ï¼Œä»è€Œè§¦å‘åˆå§‹åŒ–

**Javaç±»åŠ è½½ä¼šåˆå§‹åŒ–**çš„æƒ…å†µæœ‰ä¸”ä»…æœ‰ä»¥ä¸‹äº”ç§ï¼šï¼ˆä¹Ÿç§°ä¸ºä¸»åŠ¨å¼•ç”¨ï¼‰

:::

1. é€šè¿‡initæŒ‡ä»¤ï¼Œå¦‚new newInstance
2. getStaticï¼ˆè¯»å–ä¸€ä¸ªé™æ€å­—æ®µï¼‰
3. putstaticï¼ˆè®¾ç½®ä¸€ä¸ªé™æ€å­—æ®µï¼‰
4. invokeStaticï¼ˆè°ƒç”¨ä¸€ä¸ªç±»çš„é™æ€æ–¹æ³•ï¼‰è¿™å››æ¡æŒ‡ä»¤å­—èŠ‚ç å‘½ä»¤æ—¶
5. å­ç±»åˆå§‹åŒ–ä¼šå…ˆè°ƒç”¨çˆ¶ç±»

> â¤ï¸å¦‚ä¸‹é¢çš„ä»£ç å¹¶ä¸ä¼šæ‰§è¡ŒAç±»ä¸­çš„é™æ€ä»£ç å—ï¼Œè™½ç„¶ä½¿ç”¨äº†A.class.getName()ï¼ŒclassLoader.loadClass("org.hzz.dynamicload.a.A")ç­‰ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰çœŸæ­£è§¦å‘åŠ è½½ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆï¼ŒA.class.getName(),èƒ½è·å–åˆ°ä¿¡æ¯å‘¢ï¼Ÿå› ä¸ºA.classåªæ˜¯è¢«åŠ è½½åˆ°äº†æ–¹æ³•åŒºï¼ˆç±»ä¿¡æ¯ï¼‰ï¼Œè€Œä¸æ˜¯åœ¨å †çš„Classå¯¹è±¡â¤ï¸

```java
/**
 * ç±»Aå¹¶æ²¡æœ‰è¢«åŠ è½½
 */
public class TestA {
    public static void main(String[] args) throws Exception {
        ClassLoader classLoader = A.class.getClassLoader();
        System.out.println(A.class.getName());
        // ç±»åŠ è½½ æ˜¯ä¸€ä¸ªæ‡’åŠ è½½ï¼Œåªæœ‰ä½¿ç”¨åˆ°äº†æ‰ä¼šè¿›è¡ŒåŠ è½½
        Class<?> aClass = classLoader.loadClass("org.hzz.dynamicload.a.A");
        System.out.println(A.class == aClass);
        System.out.println(A.class);
        // åˆå§‹åŒ–
        //aClass.newInstance();
        // A.hello();
    }
}

/**
 * org.hzz.dynamicload.a.A
 * true
 * class org.hzz.dynamicload.a.A
 */
class A {
    static {
        System.out.println("A init success");
    }

    public static void hello() {
    }
}
```



### Class.forName

::: tip

æ›´èƒ½éªŒè¯ç±»æ‡’åŠ è½½ï¼ˆæ‡’åˆå§‹åŒ–çš„ä¾‹å­ï¼‰

:::

```java
public class TestB {
    public static void main(String[] args) throws ClassNotFoundException {
        Class b0 = B.class;  // æ‡’åŠ è½½ï¼Œä¸ä¼šåˆå§‹åŒ–
        // æ‡’åŠ è½½ï¼Œä¸ä¼šåˆå§‹åŒ–B
        Class<?> b1 = Class.forName("org.hzz.B",false,TestB.class.getClassLoader());
        System.out.println(b1 == b0); // true
        // ä¼šåˆå§‹åŒ–
        Class<?> b2 = Class.forName("org.hzz.B");
        System.out.println(b1 == b2); // true
    }
}
/**è¾“å‡º
 * true
 * B init success
 * true
 */
class B{
    static {
        System.out.println("B init success");
    }
}
```



## Hotspotæºç JVMå¯åŠ¨mainæ–¹æ³•æµç¨‹

![img](/images/jvm/106918.png)

## IDEA æŸ¥çœ‹sunåŒ…æºç 

::: tip

ç›®æ ‡åœ¨IDEAä¸­sun.misc.Launcher.classå˜æˆäº†sun.misc.Launcher.java

:::

```sh
# å°†openjdkçš„ä»£ç ä¸‹è½½åˆ°æœ¬åœ°ç›®å½•E:\openjdk\jdk8\
git clone https://github.com/openjdk-mirror/jdk.git
# æŸ¥çœ‹æ‰€æœ‰åˆ†æ”¯
git branch -r
# é€‰æ‹©origin/jdk8u/jdk8u/master åˆ†æ”¯
git checkout origin/jdk8u/jdk8u/master
```

![image-20220817183845957](/images/jvm/image-20220817183845957.png)

IDEAä¸­æŒ‡å®šæºç è·¯å¾„

![image-20220817190108274](/images/jvm/image-20220817190108274.png)



### å‚è€ƒ

[ç”¨IDEAè°ƒè¯•JDKæºç  (å«é˜…è¯»è°ƒè¯•æºç çš„æŠ€å·§)](https://blog.csdn.net/qq_42322103/article/details/104369824?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-104369824-blog-123503216.t5_layer_targeting_s_randoms&spm=1001.2101.3001.4242.2&utm_relevant_index=4)

[idea æŸ¥çœ‹javaæºç _IDEAæŸ¥çœ‹Javaçš„sunåŒ…ä¸‹çš„æºç ](https://blog.csdn.net/weixin_34779181/article/details/114514893)

