---
sidebarDepth: 3
sidebar: auto
prev:
  text: Back To ç›®å½•
  link: /java/
typora-root-url: ..\.vuepress\public
---



[Source Code](https://github.com/Q10Viking/learncode/tree/main/javabasic/src/org/hzz/serialize)

## å…‹éš†

### èƒŒæ™¯

æ™®é€šçš„å¯¹è±¡å¤åˆ¶ï¼Œå­˜åœ¨çš„é—®é¢˜ï¼Œå¦‚ä¸‹ä»£ç 

```java
public class CloneTest {
    public static void main(String[] args) {
        // ç­‰å·èµ‹å€¼ï¼ˆ åŸºæœ¬ç±»å‹ï¼‰
        int number = 6;
        int number2 = number;
        // ä¿®æ”¹ number2 çš„å€¼
        number2 = 9;
        System.out.println("numberï¼š" + number);
        System.out.println("number2ï¼š" + number2);
        // ç­‰å·èµ‹å€¼ï¼ˆå¯¹è±¡ï¼‰
        Dog dog = new Dog();
        dog.name = "æ—ºè´¢";
        dog.age = 5;
        Dog dog2 = dog;
        // ä¿®æ”¹ dog2 çš„å€¼
        dog2.name = "å¤§é»„";
        dog2.age = 3;
        System.out.println(dog.name + "ï¼Œ" + dog.age + "å²");
        System.out.println(dog2.name + "ï¼Œ" + dog2.age + "å²");
    }
}
/**
 * numberï¼š6
 * number2ï¼š9
 * å¤§é»„ï¼Œ3å²
 * å¤§é»„ï¼Œ3å²
 */
```

> å¯ä»¥çœ‹åˆ°å†dog2ä¸­ä¿®æ”¹åå­—ç›´æ¥å½±å“åˆ°äº†dogå¯¹è±¡ï¼Œè¿™æ˜¯å› ä¸ºä»–ä»¬å¼•ç”¨çš„éƒ½æ˜¯å †ä¸ŠåŒä¸€ä¸ªå¯¹è±¡

![](/images/java/21bdbb00-c95b-11e9-80ba-3b9ebd4a5c21.png)

## æµ…æ‹·è´

ä¸¤æ­¥éª¤

1. å®ç°`Cloneable`æ¥å£ï¼Œè¿™åªæ˜¯ä¸€ä¸ªæ ‡è®°æ¥å£ï¼Œé‡Œé¢å¹¶æ²¡æœ‰æ–¹æ³•ã€‚æ³¨æ„ï¼šå®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå¿…é¡»è¦è¦†ç›–Objectçš„cloneæ–¹æ³•

   ```java
   public interface Cloneable {
   }
   ```

2. è¦†ç›–Objectä¸­çš„cloneæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é»˜è®¤æ˜¯protectedç±»å‹ï¼Œæˆ‘ä»¬å°†å®ƒæ”¹ä¸ºpublicï¼Œä¸€è¾¹å¤–ç•Œèƒ½å¤Ÿè®¿é—®ã€‚æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å®ç°`Cloneable`æ¥å£ï¼Œjvmä¼šæŠ›å‡ºå¼‚å¸¸`CloneNotSupportedException`

   ```java
   public class Object{
       // æ˜¯ä¸€ä¸ªnativeæ–¹æ³•
       protected native Object clone() throws CloneNotSupportedException;
   }
   ```

   

> å®ç°

```java
@Data
@AllArgsConstructor
public class User implements Cloneable{
    public String name;
    public int age;

    // é‡å†™cloneæ–¹æ³•
    @Override
    public User clone() throws CloneNotSupportedException {
        return (User)super.clone();
    }
}
```

> æµ‹è¯•

```java
public class ShallowClone {
    public static void main(String[] args) throws CloneNotSupportedException {
       User user = new User("å¼ ä¸‰", 18);
       User user2 = user.clone();
       user2.setName("Q10Viking");
        System.out.println(user);
        System.out.println(user2);
    }
}
/**
 * User(name=å¼ ä¸‰, age=18)
 * User(name=Q10Viking, age=18)
 */
```



### å­˜åœ¨çš„é—®é¢˜

å¦‚æœå¯¹è±¡çš„å±æ€§è¿˜å¼•ç”¨äº†å…¶ä»–å¯¹è±¡ï¼Œé‚£ä¹ˆæµ…æ‹·è´åªä¼šå¤åˆ¶è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨åœ°å€ã€‚

```java
@Data
@AllArgsConstructor
public class User implements Cloneable{
    private String name;
    private City city;

    @Override
    public User clone() throws CloneNotSupportedException {
        return (User)super.clone();
    }
}

@Data
@AllArgsConstructor
public class City {
    private String name;
}
```

> æµ‹è¯•

```java
public class ShallowProblemTest {
    public static void main(String[] args) throws CloneNotSupportedException {
        User user = new User("å¼ ä¸‰", new City("åŒ—äº¬"));
        User user2 = user.clone();

        user2.setName("Q10Viking");
        user2.getCity().setName("å¹¿å·");

        System.out.println(user);
        System.out.println(user2);
    }
}
/**
 * User(name=å¼ ä¸‰, city=City(name=å¹¿å·))
 * User(name=Q10Viking, city=City(name=å¹¿å·))
 */
```

> å¯ä»¥user2æ”¹å˜Cityï¼Œå½±å“åˆ°äº†userçš„city,ä½†æ˜¯nameä¸å—å½±å“

## æ·±æ‹·è´

æ·±å…‹éš†å°±æ˜¯å¤åˆ¶æ•´ä¸ªå¯¹è±¡ä¿¡æ¯ï¼ŒåŒ…å«å€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹,è§£å†³æµ…æ‹·è´çš„é—®é¢˜

**æ·±å…‹éš†çš„å®ç°æ–¹å¼** é€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ç§ã€‚

  * åºåˆ—åŒ–å®ç°æ·±å…‹éš†ï¼šå…ˆå°†åŸå¯¹è±¡åºåˆ—åŒ–åˆ°å†…å­˜çš„å­—èŠ‚æµä¸­ï¼Œå†ä»å­—èŠ‚æµä¸­ååºåˆ—åŒ–å‡ºåˆšåˆšå­˜å‚¨çš„å¯¹è±¡ï¼Œè¿™ä¸ªæ–°å¯¹è±¡å’ŒåŸå¯¹è±¡å°±ä¸å­˜åœ¨ä»»ä½•åœ°å€ä¸Šçš„å…±äº«ï¼Œè¿™æ ·å°±å®ç°äº†æ·±å…‹éš†ã€‚
  * æ‰€æœ‰å¼•ç”¨ç±»å‹éƒ½å®ç°å…‹éš†ï¼šè¦å¤åˆ¶å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ç±»å‹éƒ½è¦å®ç°å…‹éš†ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½æ˜¯å¤åˆ¶çš„æ–°å¯¹è±¡ï¼Œä»è€Œå®ç°äº†æ·±å…‹éš†ã€‚



### å¼•ç”¨å¯¹è±¡å®ç°äº†Cloneableæ¥å£

1. å¼•ç”¨å¯¹è±¡è¦å®ç°Cloneæ¥å£ï¼Œå¹¶ä¸”è¦†ç›–Objectçš„cloneæ–¹æ³•
2. åœ¨çˆ¶å¯¹è±¡ä¸­ï¼Œè¿˜éœ€è¦æ‰‹åŠ¨å¯¹å¼•ç”¨å¯¹è±¡è¿›è¡Œclone.

```java
@Data
@AllArgsConstructor
public class City implements Cloneable{
    private String name;

    @Override
    public City clone() throws CloneNotSupportedException {
        return (City)super.clone();
    }
}


@Data
@AllArgsConstructor
public class User implements Cloneable{
    private String name;
    private City city;

    @Override
    public User clone() throws CloneNotSupportedException {
        User user =  (User)super.clone();
        user.setCity(city.clone());
        return user;
    }
}
```

> æµ‹è¯•

```java
public class DeepCloneTest {
    public static void main(String[] args) throws CloneNotSupportedException {
        User user = new User("å¼ ä¸‰", new City("åŒ—äº¬"));
        User user2 = user.clone();

        user2.setName("Q10Viking");
        user2.getCity().setName("å¹¿å·");
        System.out.println(user);
        System.out.println(user2);
    }
}
/**
 * User(name=å¼ ä¸‰, city=City(name=åŒ—äº¬))
 * User(name=Q10Viking, city=City(name=å¹¿å·))
 */
```



> å¦‚æœå±æ€§æ¯”è¾ƒå¤šï¼Œé‚£ä¹ˆè¿™ç§æ–¹å¼å¤„ç†èµ·æ¥ä¼šç›¸å½“ç¹çï¼Œé‚£ä¹ˆè¿˜æœ‰ç¬¬äºŒç§æ–¹å¼ï¼Œé€šè¿‡åºåˆ—çš„æ–¹å¼



### åºåˆ—åŒ–å®ç°æ·±æ‹·è´

å…ˆå°†è¦æ‹·è´å¯¹è±¡å†™å…¥åˆ°å†…å­˜ä¸­çš„å­—èŠ‚æµä¸­ï¼Œç„¶åå†ä»è¿™ä¸ªå­—èŠ‚æµä¸­è¯»å‡ºåˆšåˆšå­˜å‚¨çš„ä¿¡æ¯ï¼Œä½œä¸ºä¸€ä¸ªæ–°å¯¹è±¡è¿”å›ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–°å¯¹è±¡å’ŒåŸå¯¹è±¡å°±ä¸å­˜åœ¨ä»»ä½•åœ°å€ä¸Šçš„å…±äº«ï¼Œè‡ªç„¶å®ç°äº†æ·±æ‹·è´ã€‚

- å¯¹è±¡è¦å®ç°åºåˆ—åŒ–æ¥å£ï¼ŒåŒ…æ‹¬å¼•ç”¨çš„å¯¹è±¡ä¹Ÿè¦å®ç°åºåˆ—åŒ–æ¥å£

```java
@Data
@AllArgsConstructor
public class User implements Serializable {
    private String name;
    private City city;
}


@Data
@AllArgsConstructor
public class City implements Serializable{
    private String name;
}
```



> æµ‹è¯•

```java
public class DeepCloneTest {
    public static void main(String[] args) throws CloneNotSupportedException {
        User user = new User("å¼ ä¸‰", new City("åŒ—äº¬"));
        User user2 = CloneUtils.clone(user);

        user2.setName("Q10Viking");
        user2.getCity().setName("å¹¿å·");
        System.out.println(user);
        System.out.println(user2);
    }
}
/**
 * User(name=å¼ ä¸‰, city=City(name=åŒ—äº¬))
 * User(name=Q10Viking, city=City(name=å¹¿å·))
 */
```

> ä½¿ç”¨ByteArrayOutputStreamä¸ObjectOutputStreamç­‰ç±»å®ç°åºåˆ—åŒ–å·¥å…·

```java
public class CloneUtils {
    public static <T extends Serializable> T clone(T obj) {
        T cloneObj = null;
        try {
            //å†™å…¥å­—èŠ‚æµ
            ByteArrayOutputStream bo = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(bo);
            oos.writeObject(obj);
            oos.close();
            //åˆ†é…å†…å­˜,å†™å…¥åŸå§‹å¯¹è±¡,ç”Ÿæˆæ–°å¯¹è±¡
            ByteArrayInputStream bi = new ByteArrayInputStream(bo.toByteArray());//è·å–ä¸Šé¢çš„è¾“å‡ºå­—èŠ‚æµ
            ObjectInputStream oi = new ObjectInputStream(bi);
            //è¿”å›ç”Ÿæˆçš„æ–°å¯¹è±¡
            cloneObj = (T) oi.readObject();
            oi.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
        return cloneObj;
    }
}
```



## åºåˆ—åŒ–å’Œååºåˆ—åŒ–

> å†…å­˜ä¸­çš„æ•°æ®å¯¹è±¡åªæœ‰è½¬æ¢æˆäºŒè¿›åˆ¶æµæ‰èƒ½è¿›è¡Œæ•°æ®æŒä¹…åŒ–æˆ–è€…ç½‘ç»œä¼ è¾“ï¼Œå°†å¯¹è±¡è½¬æ¢æˆäºŒè¿›åˆ¶æµçš„è¿‡ç¨‹å«åšåºåˆ—åŒ–ï¼ˆSerializationï¼‰ï¼›ç›¸åï¼ŒæŠŠäºŒè¿›åˆ¶æµæ¢å¤ä¸ºæ•°æ®å¯¹è±¡çš„è¿‡ç¨‹å°±ç§°ä¹‹ä¸ºååºåˆ—åŒ–ï¼ˆDeserializationï¼‰
>
> ```java
> Serializableæ¥å£ä¸ObjectInputStreamå’ŒObjectOutputStreamæœ‰å…³
> ```



[Intellij IDEA å¦‚ä½•è‡ªåŠ¨ç”Ÿæˆ serialVersionUID-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)](https://cloud.tencent.com/developer/article/1697377) æ ¹æ®æç¤ºè®¾ç½®åä¹‹åï¼Œéœ€è¦é‡å¯idea.

> å…ˆæŠŠå¯¹è±¡åºåˆ—åŒ–åˆ°ç£ç›˜ï¼Œå†ä»ç£ç›˜ä¸­ååºåˆ—åŒ–å‡ºå¯¹è±¡

```java
@Data
@AllArgsConstructor
public class Mobile implements Serializable {
    private static final long serialVersionUID = -5527474321867536114L;
    private String name;
}
```



```java
public class SerializableTest {
    public static void main(String[] args) throws IOException, ClassNotFoundException {
        Mobile mobile = new Mobile("iPhone");

        System.out.println(mobile);
        // åˆ›å»ºè¾“å‡ºæµï¼ˆåºåˆ—åŒ–å†…å®¹åˆ°ç£ç›˜ï¼‰
        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream("test.out"));
        // åºåˆ—åŒ–å¯¹è±¡
        oos.writeObject(mobile);
        oos.flush();
        oos.close();

        // åˆ›å»ºè¾“å…¥æµï¼ˆä»ç£ç›˜ååºåˆ—åŒ–ï¼‰
        ObjectInputStream ois = new ObjectInputStream(new FileInputStream("test.out"));
        // ååºåˆ—åŒ–
        Mobile mobile1 = (Mobile) ois.readObject();
        ois.close();
        System.out.println(mobile);
    }
}
/**
 * Mobile(name=iPhone)
 * Mobile(name=iPhone)
 */
```

![image-20230515220516992](/images/java/image-20230515220516992.png)

### serialVersionUIDçš„ä½œç”¨

å¦‚æœæ˜¾ç¤ºå®šä¹‰äº† serialVersionUID å€¼ä¹‹åï¼Œå¯ä»¥ä½¿åºåˆ—åŒ–å’Œååºåˆ—åŒ–å‘åå…¼å®¹ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœ serialVersionUIDçš„å€¼ç›¸åŒï¼Œä¿®æ”¹å¯¹è±¡çš„å­—æ®µï¼ˆåˆ é™¤æˆ–å¢åŠ ï¼‰ï¼Œç¨‹åºä¸ä¼šæŠ¥é”™ï¼Œä¹‹åç»™æ²¡æœ‰çš„å­—æ®µèµ‹å€¼ä¸º nullï¼Œè€Œå¦‚æœæ²¡æœ‰æŒ‡å®š serialVersionUIDçš„å€¼ï¼Œå¦‚æœä¿®æ”¹å¯¹è±¡çš„å­—æ®µï¼Œç¨‹åºå°±ä¼šæŠ¥é”™

ä¸Šé¢æˆ‘ä»¬ç”Ÿæˆäº†`test.out`æ–‡ä»¶ï¼Œå¯¹åº”çš„æ˜¯è¿™ä¸ªå¯¹è±¡

```java
@Data
@AllArgsConstructor
public class Mobile implements Serializable {
    private static final long serialVersionUID = -5527474321867536114L;
    private String name;
}
```

ç°åœ¨æˆ‘ä»¬å†ååºåˆ—åŒ–ï¼Œåªä¸è¿‡ï¼Œæˆ‘ä»¬å¤šæ·»åŠ ä¸€ä¸ªå­—æ®µ

```java
@Data
@AllArgsConstructor
public class Mobile implements Serializable {
    private static final long serialVersionUID = -5527474321867536114L;
    private String name;
    private Double price;
}
```

> æµ‹è¯•ï¼š å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¤šæ·»åŠ äº†ä¸€ä¸ªå­—æ®µï¼Œå¯ä»¥ååºåˆ—æˆåŠŸï¼Œåªä¸è¿‡æ–°å­—æ®µä¸ºnull

```java
public class SerializableTest2 {
    public static void main(String[] args) throws IOException, ClassNotFoundException {
        // åˆ›å»ºè¾“å…¥æµï¼ˆä»ç£ç›˜ååºåˆ—åŒ–ï¼‰
        ObjectInputStream ois = new ObjectInputStream(new FileInputStream("test.out"));
        // ååºåˆ—åŒ–
        Mobile mobile = (Mobile) ois.readObject();
        ois.close();
        System.out.println(mobile);
    }
}
/**
 * Mobile(name=iPhone, price=null)
 */
```

----------

è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œåªä¸è¿‡è¿™æ¬¡æˆ‘ä»¬æŠŠserialVersionUIDåˆ é™¤æ‰ï¼Œå†ååºåˆ—åŒ–

```java
@Data
@AllArgsConstructor
public class Mobile implements Serializable {
    // æ³¨é‡Šæ‰
    // private static final long serialVersionUID = -5527474321867536114L;
    private String name;
    private Double price;
}
```

å¯ä»¥çœ‹åˆ°ï¼ŒæŠ¥å¼‚å¸¸ï¼Œå› ä¸ºç±»çš„serialVersionUIDä¸å­˜å‚¨çš„åºåˆ—åŒ–ä¸ä¸€è‡´ã€‚

```sh
Exception in thread "main" java.io.InvalidClassException: org.hzz.serialize.Mobile; local class incompatible: stream classdesc serialVersionUID = -5527474321867536114, local class serialVersionUID = -1401851042268655216
```



### åºåˆ—åŒ–æ—¶æŸäº›æˆå‘˜ä¸éœ€è¦åºåˆ—åŒ–(transient)å…³é”®å­—ğŸ˜Š

```java
public transient int num;
```





### Ideaè‡ªåŠ¨ç”ŸæˆserialVersionUIDâ¤ï¸

[Intellij IDEA å¦‚ä½•è‡ªåŠ¨ç”Ÿæˆ serialVersionUID-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)](https://cloud.tencent.com/developer/article/1697377) æ ¹æ®æç¤ºè®¾ç½®åä¹‹åï¼Œéœ€è¦é‡å¯idea.

ç‚¹å‡» Settings â†’ Inspections â†’ æœç´¢ Serialization issues â†’ å‹¾é€‰ `Serializable class without 'SerialVersionUID'` ä¿å­˜è®¾ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](/images/java/60afa9d0-c95c-11e9-a43e-c98246251c8a.png)

ç½®å®Œä¹‹åï¼Œå…‰æ ‡æ”¾åˆ°ç±»åä¸Šï¼Œç‚¹å‡»æç¤ºï¼Œç”Ÿæˆ serialVersionUIDï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆè®°å¾—é‡å¯IDEAï¼‰

![](/images/java/8d290240-c95c-11e9-a43e-c98246251c8a)



### æ¶‰åŠçš„java apiğŸ˜˜

åœ¨ Java ä¸­åºåˆ—åŒ–ç”± java.io.ObjectOutputStreamç±»å®Œæˆï¼Œè¯¥ç±»æ˜¯ä¸€ä¸ªç­›é€‰å™¨æµï¼Œå®ƒå°è£…åœ¨è¾ƒä½çº§åˆ«çš„å­—èŠ‚æµä¸­ï¼Œä»¥å¤„ç†åºåˆ—åŒ–æœºåˆ¶ã€‚è¦é€šè¿‡åºåˆ—åŒ–æœºåˆ¶å­˜å‚¨ä»»ä½•å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ObjectOutputStream.writeObject(savethisobject) æ–¹æ³•ï¼Œå¦‚æœè¦ååºåˆ—åŒ–è¯¥å¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨ObjectInputStream.readObject() æ–¹æ³•ï¼ŒreadObject() æ–¹æ³•ä¼šè¯»å–å­—èŠ‚ï¼Œå¹¶æŠŠè¿™äº›å­—èŠ‚è½¬æ¢ä¸ºå¯¹è±¡å†è¿”å›



## å¸¸è§çš„åºåˆ—åŒ–

- ä¸Šé¢çš„å°±æ˜¯JavaåŸç”Ÿçš„åºåˆ—åŒ–ï¼Œæ¯”è¾ƒç¬¨é‡
- gRPCä½¿ç”¨çš„protobuf
- jsonæ ¼å¼fastjson(é˜¿é‡Œå·´å·´å…¬å¸å¼€æº)å’Œgson(googleå…¬å¸å¼€æº)
  - ç›®å‰fastjsonå‡çº§åˆ°äº†fastjson2ï¼Œæ€§èƒ½æ›´åŠ æé«˜[å†è§ Fastjsonï¼Fastjson 2 æ­£å¼å‘å¸ƒ](https://blog.csdn.net/youanyyou/article/details/124418024)



> å¦‚fastjson2æ¥ä½¿ç”¨

```java
@Data
@AllArgsConstructor
public class Goods {
    private String name;
    private Double price;
}
```

```java
public class FastJson2Demo {
    public static void main(String[] args) {
        Goods goods = new Goods("iPhone", null);
        System.out.println(goods);

        // åºåˆ—åŒ–
        String goodsJson = JSON.toJSONString(goods);
        System.out.println(goodsJson);
        // ååºåˆ—åŒ–
        Goods goods1 = JSON.parseObject(goodsJson, Goods.class);
        System.out.println(goods1);
    }
}
/**
 * Goods(name=iPhone, price=null)
 * {"name":"iPhone"}
 * Goods(name=iPhone, price=null)
 */
```

