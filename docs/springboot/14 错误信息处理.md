---
sidebarDepth: 3
sidebar: auto
prev:
  text: Back To ç›®å½•
  link: /springboot/
typora-root-url: ..\.vuepress\public
---



[Source Code](https://github.com/Q10Viking/learncode/tree/main/ddd/multi-layers)

## @ControllerAdviceåˆ†æ

> å¼‚å¸¸å¤„ç†æ˜¯é’ˆå¯¹Controllerå±‚çš„ï¼Œå°¤å…¶æ˜¯å‚æ•°æ£€éªŒå¼‚å¸¸ï¼Œä½“ç°æ›´åŠ æ˜æ˜¾

```java
ControllerAdviceBean#findAnnotatedBeansï¼Œä¼šä»å®¹å™¨ä¸­æ‰¾å‡ºæ‰€æœ‰æ ‡æ³¨äº†@ControllerAdviceçš„bean
ç„¶åæ‰¾åˆ°è¿™ä¸ªç±»ä¸Šæ ‡æ³¨äº†@ExceptionHandlerçš„æ³¨è§£ï¼Œå°†å¼‚å¸¸ä¸è¿™ä¸ªæ–¹æ³•å½¢æˆæ˜ å°„Map,å­˜å‚¨åœ¨ExceptionHandlerMethodResolverç±»

å½“controlleræŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™å°±èƒ½æ ¹æ®å¼‚å¸¸æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ï¼Œè¿›è¡Œåå°„è°ƒç”¨æ‰§è¡Œã€‚
```





## æ¨¡æ¿ç±»ResponseEntityExceptionHandler

> Spring webæ¨¡å—æä¾›äº†ä¸€ä¸ªæ¨¡æ¿ï¼Œé‚£å°±æ˜¯æŠ½è±¡ç±»`ResponseEntityExceptionHandler`
>
> é‡Œé¢æœ‰ä¸€ä¸ªæ–¹æ³•å®šä¹‰äº†å¸¸è§çš„å¼‚å¸¸å¤„ç†

```java
@ExceptionHandler({
			HttpRequestMethodNotSupportedException.class,
			HttpMediaTypeNotSupportedException.class,
			HttpMediaTypeNotAcceptableException.class,
			MissingPathVariableException.class,
			MissingServletRequestParameterException.class,
			ServletRequestBindingException.class,
			ConversionNotSupportedException.class,
			TypeMismatchException.class,
			HttpMessageNotReadableException.class,
			HttpMessageNotWritableException.class,
			MethodArgumentNotValidException.class,
			MissingServletRequestPartException.class,
			BindException.class,
			NoHandlerFoundException.class,
			AsyncRequestTimeoutException.class
		})
	@Nullable
	public final ResponseEntity<Object> handleException(Exception ex, WebRequest request) throws Exception {
		HttpHeaders headers = new HttpHeaders();

		if (ex instanceof HttpRequestMethodNotSupportedException) {
			HttpStatus status = HttpStatus.METHOD_NOT_ALLOWED;
			return handleHttpRequestMethodNotSupported((HttpRequestMethodNotSupportedException) ex, headers, status, request);
		}
		else if (ex instanceof HttpMediaTypeNotSupportedException) {
			HttpStatus status = HttpStatus.UNSUPPORTED_MEDIA_TYPE;
			return handleHttpMediaTypeNotSupported((HttpMediaTypeNotSupportedException) ex, headers, status, request);
		}
		else if (ex instanceof HttpMediaTypeNotAcceptableException) {
			HttpStatus status = HttpStatus.NOT_ACCEPTABLE;
			return handleHttpMediaTypeNotAcceptable((HttpMediaTypeNotAcceptableException) ex, headers, status, request);
		}
		else if (ex instanceof MissingPathVariableException) {
			HttpStatus status = HttpStatus.INTERNAL_SERVER_ERROR;
			return handleMissingPathVariable((MissingPathVariableException) ex, headers, status, request);
		}
		else if (ex instanceof MissingServletRequestParameterException) {
			HttpStatus status = HttpStatus.BAD_REQUEST;
			return handleMissingServletRequestParameter((MissingServletRequestParameterException) ex, headers, status, request);
		}
		else if (ex instanceof ServletRequestBindingException) {
			HttpStatus status = HttpStatus.BAD_REQUEST;
			return handleServletRequestBindingException((ServletRequestBindingException) ex, headers, status, request);
		}
		else if (ex instanceof ConversionNotSupportedException) {
			HttpStatus status = HttpStatus.INTERNAL_SERVER_ERROR;
			return handleConversionNotSupported((ConversionNotSupportedException) ex, headers, status, request);
		}
		else if (ex instanceof TypeMismatchException) {
			HttpStatus status = HttpStatus.BAD_REQUEST;
			return handleTypeMismatch((TypeMismatchException) ex, headers, status, request);
		}
		else if (ex instanceof HttpMessageNotReadableException) {
			HttpStatus status = HttpStatus.BAD_REQUEST;
			return handleHttpMessageNotReadable((HttpMessageNotReadableException) ex, headers, status, request);
		}
		else if (ex instanceof HttpMessageNotWritableException) {
			HttpStatus status = HttpStatus.INTERNAL_SERVER_ERROR;
			return handleHttpMessageNotWritable((HttpMessageNotWritableException) ex, headers, status, request);
		}
		else if (ex instanceof MethodArgumentNotValidException) {
			HttpStatus status = HttpStatus.BAD_REQUEST;
			return handleMethodArgumentNotValid((MethodArgumentNotValidException) ex, headers, status, request);
		}
		else if (ex instanceof MissingServletRequestPartException) {
			HttpStatus status = HttpStatus.BAD_REQUEST;
			return handleMissingServletRequestPart((MissingServletRequestPartException) ex, headers, status, request);
		}
		else if (ex instanceof BindException) {
			HttpStatus status = HttpStatus.BAD_REQUEST;
			return handleBindException((BindException) ex, headers, status, request);
		}
		else if (ex instanceof NoHandlerFoundException) {
			HttpStatus status = HttpStatus.NOT_FOUND;
			return handleNoHandlerFoundException((NoHandlerFoundException) ex, headers, status, request);
		}
		else if (ex instanceof AsyncRequestTimeoutException) {
			HttpStatus status = HttpStatus.SERVICE_UNAVAILABLE;
			return handleAsyncRequestTimeoutException((AsyncRequestTimeoutException) ex, headers, status, request);
		}
		else {
			// Unknown exception, typically a wrapper with a common MVC exception as cause
			// (since @ExceptionHandler type declarations also match first-level causes):
			// We only deal with top-level MVC exceptions here, so let's rethrow the given
			// exception for further processing through the HandlerExceptionResolver chain.
			throw ex;
		}
	}
```



### ä½¿ç”¨ğŸ‘ğŸ‘ğŸ‘

```java
@RestControllerAdvice
@Slf4j
public class ExceptionHandler extends ResponseEntityExceptionHandler {

    /**
     * ç”±äºåœ¨jsonçš„æ—¶å€™ï¼Œå–çš„æ˜¯bodyï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦é‡å†™handleExceptionInternalæ–¹æ³•
     * é»˜è®¤çš„æ˜¯ç›´æ¥è®¾ç½®ä¸ºäº†null
     * jsonåçš„æ•ˆæœ
     * {
     * 	"code": "405",
     * 	"msg": "Allow:\"GET\"",
     * 	"error": "405 method not allowed"
     * }
     */
    @Override
    protected ResponseEntity<Object> handleExceptionInternal(Exception ex, Object body, HttpHeaders headers, HttpStatus status, WebRequest request) {
        if(body == null){
            body = Result.error(
                    status.toString().replaceAll("_"," ").toLowerCase(),
                    ""+status.value(),
                    headers.toString().substring(1, headers.toString().length()-1));
        }
        return super.handleExceptionInternal(ex, body, headers, status, request);
    }


    /**---------------------ä»¥ä¸‹ä¸ºå®šåˆ¶çš„å¼‚å¸¸-------------------------------------------*/

    /**
     * å‚æ•°æ ¡éªŒå¼‚å¸¸
     */
    @Override
    protected ResponseEntity<Object> handleMethodArgumentNotValid(MethodArgumentNotValidException exception, HttpHeaders headers, HttpStatus status, WebRequest request) {
        log.info("æ ¡éªŒå¤±è´¥");
        Map<String, Object> objectBody = new LinkedHashMap<>();
        objectBody.put("Current Timestamp", new Date());
        objectBody.put("Status", status.value());

        // Get all errors
        List<String> exceptionalErrors = exception.getBindingResult()
                .getFieldErrors()
                .stream()
                .map(x -> x.getField()+":"+x.getDefaultMessage())
                .collect(Collectors.toList());

        objectBody.put("Errors", exceptionalErrors);

        return new ResponseEntity<>(objectBody, status);
    }
}
```



> å‚æ•°æ ¡éªŒå¼‚å¸¸æ£€è½¦

```java
@PostMapping("/save")
public Result<String> save( @Valid @RequestBody UserDTO userDTO) {
    userService.save(userDTO);
    return Result.success("æ–°å¢ç”¨æˆ·æˆåŠŸ");
}
```

![image-20230522004103055](/images/springboot/image-20230522004103055.png)



> é»˜è®¤çš„æµ‹è¯•ï¼Œæ¯”å¦‚å…è®¸çš„æ–¹æ³•æ˜¯get,ä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨äº†postæ–¹æ³•

```java
@GetMapping("/hello")
public Result<String> hello() {
    return Result.success("hello111");
}
```

![image-20230522004245186](/images/springboot/image-20230522004245186.png)

## ä¸ä½¿ç”¨æ¨¡æ¿

> å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿è‡ªå·±å®šä¹‰ä¸€ä¸ªç±»ï¼Œåœ¨ç±»çš„æ–¹æ³•ä¸Šæ ‡æ³¨@ExceptionHandleræ³¨è§£

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(Exception.class)
    public Result<String> handleException(Exception e, WebRequest request){
        String requestURI = ((ServletWebRequest) request).getRequest().getRequestURI();
        StringBuilder msgBuilder = new StringBuilder();
        msgBuilder.append("æ‚¨è¯·æ±‚çš„URI:"+requestURI+"å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¼‚å¸¸ä¿¡æ¯åœ¨dataä¸­ï¼š");
        msgBuilder.append("å¦‚æœè¿™ä¸æ˜¯æ‚¨çš„è¯·æ±‚ï¼Œè¯·å¿½ç•¥ã€‚");
        msgBuilder.append("å¦‚æœæ˜¯æ‚¨çš„è¯·æ±‚ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚Q10Vikingï¼ŒæœåŠ¡å™¨å‘ç”Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ï¼hzz");

        return Result.error(e.toString(), ""+HttpStatus.INTERNAL_SERVER_ERROR.value(),msgBuilder.toString());
    }
}
```





## æ¨¡æ¿å¯¹æ¯”ä¼˜ç¼ºç‚¹

::: tip

é¦–å…ˆï¼Œæˆ‘å»ºè®®æ˜¯ä½¿ç”¨æ¨¡æ¿çš„,è™½ç„¶ç½‘ä¸Šæœç´ ï¼Œå¤§å¤šæ˜¯ä¸é€‚ç”¨æ¨¡æ¿çš„ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨æ¨¡æ¿çš„æ—¶å€™ï¼Œéœ€è¦å¤„ç†ä¸€ä¸‹bodyæ”¹ä¸ºæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„æ•°æ®æ ¼å¼ï¼Œå› ä¸ºjsonåºåˆ—åŒ–çš„æ—¶å€™å–çš„æ˜¯ResponseEntityçš„body.

è€Œspringæä¾›çš„è¿™ä¸ªæ¨¡æ¿ï¼Œé»˜è®¤bodyæ˜¯è®¾ç½®ä¸ºnullçš„

:::



1. æ¨¡æ¿

   1. ä¼˜ç‚¹ï¼šé»˜è®¤handleräº†è®¸å¤šspringå¸¸è§çš„å¼‚å¸¸
   2. ç¼ºç‚¹éœ€è¦æˆ‘ä»¬è‡ªå·±å¤„ç†ä¸€ä¸‹bodyï¼Œä»¥åŠExceptionå…¨å±€å¼‚å¸¸ï¼Œæ¨¡æ¿æ²¡æœ‰å¸®æˆ‘ä»¬å¤„ç†ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±ä¹Ÿå¤„ç†ä¸€ä¸‹ä½¿ç”¨@ExceptionHandler(Exception.class)

   

2. ä¸ä½¿ç”¨æ¨¡æ¿ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦è‡ªå·±å…¨éƒ¨@ExceptionHandler(å…³å¿ƒçš„å¼‚å¸¸.class)
   1. æ—¢ç„¶ä½¿ç”¨è¿™ä¸ªæ³¨è§£ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ”¾å…¥åˆ°å®ç°æ¨¡æ¿çš„ç±»ä¸­ï¼Œæ‰€ä»¥è¿˜æ˜¯å»ºè®®ä½¿ç”¨æ¨¡æ¿



> åŸºäºä»¥ä¸Šåˆ†æï¼Œæˆ‘å»ºè®®æ˜¯ä½¿ç”¨æ¨¡æ¿çš„



### æ€»ç»“â¤ï¸

```java
import lombok.extern.slf4j.Slf4j;
import org.hzz.domain.common.Result;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.HttpRequestMethodNotSupportedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.context.request.ServletWebRequest;
import org.springframework.web.context.request.WebRequest;
import org.springframework.web.servlet.mvc.method.annotation.ResponseEntityExceptionHandler;

import java.util.Date;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@RestControllerAdvice
@Slf4j
public class ExceptionHandler extends ResponseEntityExceptionHandler {

    /**
     * ç”±äºåœ¨jsonçš„æ—¶å€™ï¼Œå–çš„æ˜¯bodyï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦é‡å†™handleExceptionInternalæ–¹æ³•
     * é»˜è®¤çš„æ˜¯ç›´æ¥è®¾ç½®ä¸ºäº†null
     * jsonåçš„æ•ˆæœ
     * {
     * 	"code": "405",
     * 	"msg": "Allow:\"GET\"",
     * 	"error": "405 method not allowed"
     * }
     */
    @Override
    protected ResponseEntity<Object> handleExceptionInternal(Exception ex, Object body, HttpHeaders headers, HttpStatus status, WebRequest request) {
        if(body == null){
            body = Result.error(
                    status.toString().replaceAll("_"," ").toLowerCase(),
                    ""+status.value(),
                    headers.toString().substring(1, headers.toString().length()-1));
        }
        return super.handleExceptionInternal(ex, body, headers, status, request);
    }


    /**---------------------ä»¥ä¸‹ä¸ºå®šåˆ¶çš„å¼‚å¸¸-------------------------------------------*/

    /**
     * å‚æ•°æ ¡éªŒå¼‚å¸¸
     */
    @Override
    protected ResponseEntity<Object> handleMethodArgumentNotValid(MethodArgumentNotValidException exception, HttpHeaders headers, HttpStatus status, WebRequest request) {
        log.info("æ ¡éªŒå¤±è´¥");
        Map<String, Object> objectBody = new LinkedHashMap<>();
        objectBody.put("Current Timestamp", new Date());
        objectBody.put("Status", status.value());

        // Get all errors
        List<String> exceptionalErrors = exception.getBindingResult()
                .getFieldErrors()
                .stream()
                .map(x -> x.getField()+":"+x.getDefaultMessage())
                .collect(Collectors.toList());

        objectBody.put("Errors", exceptionalErrors);

        return new ResponseEntity<>(objectBody, status);
    }

    /**---------------------ä»¥ä¸‹æ˜¯æ‰©å±•çš„å¼‚å¸¸--------------------------------------*/
    @org.springframework.web.bind.annotation.ExceptionHandler(Exception.class)
    public Result<String> handleMySelfException(Exception e, WebRequest request){
        String requestURI = ((ServletWebRequest) request).getRequest().getRequestURI();
        StringBuilder msgBuilder = new StringBuilder();
        msgBuilder.append("æ‚¨è¯·æ±‚çš„URI:"+requestURI+"å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¼‚å¸¸ä¿¡æ¯åœ¨dataä¸­ï¼š");
        msgBuilder.append("å¦‚æœè¿™ä¸æ˜¯æ‚¨çš„è¯·æ±‚ï¼Œè¯·å¿½ç•¥ã€‚");
        msgBuilder.append("å¦‚æœæ˜¯æ‚¨çš„è¯·æ±‚ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚Q10Vikingï¼ŒæœåŠ¡å™¨å‘ç”Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ï¼hzz");

        return Result.error(e.toString(), ""+HttpStatus.INTERNAL_SERVER_ERROR.value(),msgBuilder.toString());
    }
}

```



> æµ‹è¯•æ‰©å±•å¼‚å¸¸

```java
@GetMapping("/exception")
public Result<String> exception() {
    throw new RuntimeException("æµ‹è¯•å¼‚å¸¸");
}
```

![image-20230522005402215](/images/springboot/image-20230522005402215.png)



   

