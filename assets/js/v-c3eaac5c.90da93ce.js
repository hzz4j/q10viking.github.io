"use strict";(self.webpackChunkq10viking_github_io=self.webpackChunkq10viking_github_io||[]).push([[78864],{2146:(n,s,a)=>{a.r(s),a.d(s,{data:()=>t});const t={key:"v-c3eaac5c",path:"/seata/03%20Seata%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8BAT%E6%A8%A1%E5%BC%8F.html",title:"",lang:"zh-CN",frontmatter:{sidebarDepth:3,sidebar:"auto",prev:{text:"Back To 目录",link:"/seata/"},"typora-root-url":"..\\.vuepress\\public"},excerpt:"",headers:[{level:2,title:"Seata Server（TC）环境搭建",slug:"seata-server-tc-环境搭建",children:[{level:3,title:"下载seata server",slug:"下载seata-server",children:[]},{level:3,title:"建表(db模式)",slug:"建表-db模式",children:[]},{level:3,title:"seata配置nacos",slug:"seata配置nacos",children:[]},{level:3,title:"上传配置至Nacos配置中心",slug:"上传配置至nacos配置中心",children:[]},{level:3,title:"启动",slug:"启动",children:[]},{level:3,title:"支持的启动参数",slug:"支持的启动参数",children:[]},{level:3,title:"访问界面",slug:"访问界面",children:[]}]},{level:2,title:"Seata Client快速开始",slug:"seata-client快速开始",children:[{level:3,title:"环境准备",slug:"环境准备",children:[]},{level:3,title:"依赖",slug:"依赖",children:[]},{level:3,title:"微服务对应数据库中添加undo_log表(仅AT模式)",slug:"微服务对应数据库中添加undo-log表-仅at模式",children:[]},{level:3,title:"微服务application.yml中添加seata配",slug:"微服务application-yml中添加seata配",children:[]},{level:3,title:"在全局事务发起者中添加@GlobalTransactional注",slug:"在全局事务发起者中添加-globaltransactional注",children:[]},{level:3,title:"测试",slug:"测试",children:[]}]},{level:2,title:"小结",slug:"小结",children:[]},{level:2,title:"Seata版本",slug:"seata版本",children:[]}],filePathRelative:"seata/03 Seata快速开始AT模式.md"}},97741:(n,s,a)=>{a.r(s),a.d(s,{default:()=>R});var t=a(20641);const e=(0,t.Fv)('<div class="custom-container tip"><p class="custom-container-title">TIP</p><p>Seata分TC、TM和RM三个角色，TC（Server端）为单独服务端部署，TM和RM（Client端）由业务系统集成</p></div><h2 id="seata-server-tc-环境搭建" tabindex="-1"><a class="header-anchor" href="#seata-server-tc-环境搭建" aria-hidden="true">#</a> <strong>Seata Server（TC）环境搭建</strong></h2><p><strong>Server端存储模式（store.mode）支持三种：</strong></p><ul><li>file：单机模式，全局事务会话信息内存中读写并持久化本地文件root.data，性能较高</li><li>db：高可用模式，全局事务会话信息通过db共享，相应性能差些</li><li>redis：1.3及以上版本支持,性能较高,存在事务信息丢失风险,请提前配置适合当前场景的redis持久化配置</li></ul><blockquote><p><strong>db存储模式+Nacos(注册&amp;配置中心)方式部署</strong></p></blockquote><h3 id="下载seata-server" tabindex="-1"><a class="header-anchor" href="#下载seata-server" aria-hidden="true">#</a> 下载seata server</h3>',6),p={href:"https://github.com/seata/seata/releases",target:"_blank",rel:"noopener noreferrer"},o=(0,t.Lk)("p",null,[(0,t.Lk)("img",{src:"/images/seata/image-20230420183959655.png",alt:"image-20230420183959655"})],-1),c=(0,t.Lk)("blockquote",null,[(0,t.Lk)("p",null,"tar -zxvf seata-server-1.5.2.tar.gz")],-1),l=(0,t.Lk)("h3",{id:"建表-db模式",tabindex:"-1"},[(0,t.Lk)("a",{class:"header-anchor",href:"#建表-db模式","aria-hidden":"true"},"#"),(0,t.eW)(),(0,t.Lk)("strong",null,"建表(db模式)")],-1),u={href:"https://github.com/seata/seata/tree/v1.5.2/script/server/db",target:"_blank",rel:"noopener noreferrer"},r=(0,t.Fv)('<p><img src="/images/seata/image-20230420110315652.png" alt="image-20230420110315652"></p><details class="custom-container details"><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- -------------------------------- The script used when storeMode is &#39;db&#39; --------------------------------</span>\n<span class="token comment">-- the table to store GlobalSession data</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>global_table<span class="token punctuation">`</span></span>\n<span class="token punctuation">(</span>\n    <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>                       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span>            <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span>                    <span class="token keyword">TINYINT</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>application_id<span class="token punctuation">`</span></span>            <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>transaction_service_group<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>transaction_name<span class="token punctuation">`</span></span>          <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>timeout<span class="token punctuation">`</span></span>                   <span class="token keyword">INT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>begin_time<span class="token punctuation">`</span></span>                <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>application_data<span class="token punctuation">`</span></span>          <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span>                <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span>              <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>\n    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_status_gmt_modified<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_transaction_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>\n\n<span class="token comment">-- the table to store BranchSession data</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>branch_table<span class="token punctuation">`</span></span>\n<span class="token punctuation">(</span>\n    <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span>         <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>               <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span>    <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>resource_group_id<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>resource_id<span class="token punctuation">`</span></span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>branch_type<span class="token punctuation">`</span></span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span>            <span class="token keyword">TINYINT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span>         <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>application_data<span class="token punctuation">`</span></span>  <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span>        <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span>      <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_xid<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>\n\n<span class="token comment">-- the table to store lock data</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>lock_table<span class="token punctuation">`</span></span>\n<span class="token punctuation">(</span>\n    <span class="token identifier"><span class="token punctuation">`</span>row_key<span class="token punctuation">`</span></span>        <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>            <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span>      <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>resource_id<span class="token punctuation">`</span></span>    <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>table_name<span class="token punctuation">`</span></span>     <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>pk<span class="token punctuation">`</span></span>             <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span>         <span class="token keyword">TINYINT</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;0&#39;</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;0:locked ,1:rollbacking&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_create<span class="token punctuation">`</span></span>     <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>gmt_modified<span class="token punctuation">`</span></span>   <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>\n    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>row_key<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_status<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_branch_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n    <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>idx_xid_and_branch_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span> <span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>\n\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span>\n<span class="token punctuation">(</span>\n    <span class="token identifier"><span class="token punctuation">`</span>lock_key<span class="token punctuation">`</span></span>       <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>lock_value<span class="token punctuation">`</span></span>     <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>expire<span class="token punctuation">`</span></span>         <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>\n    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>lock_key<span class="token punctuation">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4<span class="token punctuation">;</span>\n\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;AsyncCommitting&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;RetryCommitting&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;RetryRollbacking&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>distributed_lock<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>lock_key<span class="token punctuation">,</span> lock_value<span class="token punctuation">,</span> expire<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;TxTimeoutCheck&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39; &#39;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div></details><p><img src="/images/seata/image-20230420110540320.png" alt="image-20230420110540320"></p><h3 id="seata配置nacos" tabindex="-1"><a class="header-anchor" href="#seata配置nacos" aria-hidden="true">#</a> seata配置nacos</h3>',4),i={href:"https://seata.io/zh-cn/docs/user/configuration/nacos.html",target:"_blank",rel:"noopener noreferrer"},k=(0,t.Fv)('<p>注册中心可以说是微服务架构中的”通讯录“，它记录了服务和服务地址的映射关系。在分布式架构中，服务会注册到注册中心，当服务需要调用其它服务时，就到注册中心找到服务的地址，进行调用。比如Seata Client端(TM,RM)，发现Seata Server(TC)集群的地址,彼此通信。</p><p>注意：Seata的注册中心是作用于Seata自身的，和Spring Cloud的注册中心无关</p><p><img src="/images/seata/54137.png" alt="img"></p><p><strong>配置将Seata Server注册到Nacos，修改conf/application.yml文件</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">seata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">config</span><span class="token punctuation">:</span>\n    <span class="token comment"># support: nacos, consul, apollo, zk, etcd3</span>\n    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos\n    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>\n      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.135.1<span class="token punctuation">:</span><span class="token number">8848</span>\n      <span class="token key atrule">group</span> <span class="token punctuation">:</span> <span class="token string">&quot;SEATA_GROUP&quot;</span>\n      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> c3f112d8<span class="token punctuation">-</span>1c5e<span class="token punctuation">-</span>419e<span class="token punctuation">-</span>9c83<span class="token punctuation">-</span>b0b26b987a42\n      <span class="token key atrule">dataId</span><span class="token punctuation">:</span> seataServer.properties\n      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos\n      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos\n  <span class="token key atrule">registry</span><span class="token punctuation">:</span>\n    <span class="token comment"># support: nacos, eureka, redis, zk, consul, etcd3, sofa</span>\n    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos\n    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>\n      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server\n      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.135.1<span class="token punctuation">:</span><span class="token number">8848</span>\n      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP\n      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> c3f112d8<span class="token punctuation">-</span>1c5e<span class="token punctuation">-</span>419e<span class="token punctuation">-</span>9c83<span class="token punctuation">-</span>b0b26b987a42\n      <span class="token key atrule">data-id</span><span class="token punctuation">:</span> seataServer.properties\n      <span class="token key atrule">cluster</span><span class="token punctuation">:</span> default\n      <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos\n      <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos\n  <span class="token key atrule">store</span><span class="token punctuation">:</span>\n    <span class="token comment"># support: file 、 db 、 redis</span>\n    <span class="token key atrule">mode</span><span class="token punctuation">:</span> db\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><blockquote><p>配置成功后nacos的显示效果</p></blockquote><p><img src="/images/seata/image-20230420200742678.png" alt="image-20230420200742678"></p><p><img src="/images/seata/image-20230420200720491.png" alt="image-20230420200720491"></p><h3 id="上传配置至nacos配置中心" tabindex="-1"><a class="header-anchor" href="#上传配置至nacos配置中心" aria-hidden="true">#</a> <strong>上传配置至Nacos配置中心</strong></h3>',9),b={href:"https://github.com/seata/seata/blob/v1.5.2/script/config-center/config.txt",target:"_blank",rel:"noopener noreferrer"},m=(0,t.Fv)('<p>获取/seata/script/config-center/config.txt，修改为db存储模式，并修改mysql连接配置</p><blockquote><p>使用mysql8</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>上传方式在：nacos配置中心自己创建一个配置，然后粘贴上去\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></blockquote><p><img src="/images/seata/image-20230420195417525.png" alt="image-20230420195417525"></p><p>在store.mode=db，由于seata是通过jdbc的executeBatch来批量插入全局锁的，根据MySQL官网的说明，连接参数中的rewriteBatchedStatements为true时，在执行executeBatch，并且操作类型为insert时，jdbc驱动会把对应的SQL优化成<code>insert into () values (), ()</code>的形式来提升批量插入的性能。 根据实际的测试，该参数设置为true后，对应的批量插入性能为原来的10倍多，因此在数据源为MySQL时，建议把该参数设置为true。</p><hr><p>配置事务分组， 要与client配置的事务分组一致</p><ul><li>事务分组：seata的资源逻辑，可以按微服务的需要，在应用程序（客户端）对自行定义事务分组，每组取一个名字。</li><li>集群：seata-server服务端一个或多个节点组成的集群cluster。 应用程序（客户端）使用时需要指定事务逻辑分组与Seata服务端集群的映射关系。</li></ul><p>​ <img src="/images/seata/53977.png" alt="0"></p><p>事务分组如何找到后端Seata集群（TC）？</p><ol><li>首先应用程序（客户端）中配置了事务分组（GlobalTransactionScanner 构造方法的txServiceGroup参数）。若应用程序是SpringBoot则通过seata.tx-service-group 配置。</li><li>应用程序（客户端）会通过用户配置的配置中心去寻找service.vgroupMapping .[事务分组配置项]，取得配置项的值就是TC集群的名称。若应用程序是SpringBoot则通过seata.service.vgroup-mapping.事务分组名=集群名称 配置</li><li>拿到集群名称程序通过一定的前后缀+集群名称去构造服务名，各配置中心的服务名实现不同（前提是Seata-Server已经完成服务注册，且Seata-Server向注册中心报告cluster名与应用程序（客户端）配置的集群名称一致）</li><li>拿到服务名去相应的注册中心去拉取相应服务名的服务列表，获得后端真实的TC服务列表（即Seata-Server集群节点列表）</li></ol><hr><p><strong>在nacos配置中心中新建配置，dataId为seataServer.properties</strong>，配置内容为上面修改后的config.txt中的配置信息</p><blockquote><p>从v1.4.2版本开始，seata已支持从一个Nacos dataId中获取所有配置信息,你只需要额外添加一个dataId配置项。</p></blockquote><p>​ <img src="/images/seata/54003.png" alt="0"></p><details class="custom-container details"><div class="language-properties ext-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment">#For details about configuration items, see https://seata.io/zh-cn/docs/user/configurations.html</span>\n<span class="token comment">#Transport configuration, for client and server</span>\n<span class="token key attr-name">transport.type</span><span class="token punctuation">=</span><span class="token value attr-value">TCP</span>\n<span class="token key attr-name">transport.server</span><span class="token punctuation">=</span><span class="token value attr-value">NIO</span>\n<span class="token key attr-name">transport.heartbeat</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>\n<span class="token key attr-name">transport.enableTmClientBatchSendRequest</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n<span class="token key attr-name">transport.enableRmClientBatchSendRequest</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>\n<span class="token key attr-name">transport.enableTcServerBatchSendResponse</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n<span class="token key attr-name">transport.rpcRmRequestTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span>\n<span class="token key attr-name">transport.rpcTmRequestTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span>\n<span class="token key attr-name">transport.rpcTcRequestTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">30000</span>\n<span class="token key attr-name">transport.threadFactory.bossThreadPrefix</span><span class="token punctuation">=</span><span class="token value attr-value">NettyBoss</span>\n<span class="token key attr-name">transport.threadFactory.workerThreadPrefix</span><span class="token punctuation">=</span><span class="token value attr-value">NettyServerNIOWorker</span>\n<span class="token key attr-name">transport.threadFactory.serverExecutorThreadPrefix</span><span class="token punctuation">=</span><span class="token value attr-value">NettyServerBizHandler</span>\n<span class="token key attr-name">transport.threadFactory.shareBossWorker</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n<span class="token key attr-name">transport.threadFactory.clientSelectorThreadPrefix</span><span class="token punctuation">=</span><span class="token value attr-value">NettyClientSelector</span>\n<span class="token key attr-name">transport.threadFactory.clientSelectorThreadSize</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>\n<span class="token key attr-name">transport.threadFactory.clientWorkerThreadPrefix</span><span class="token punctuation">=</span><span class="token value attr-value">NettyClientWorkerThread</span>\n<span class="token key attr-name">transport.threadFactory.bossThreadSize</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>\n<span class="token key attr-name">transport.threadFactory.workerThreadSize</span><span class="token punctuation">=</span><span class="token value attr-value">default</span>\n<span class="token key attr-name">transport.shutdown.wait</span><span class="token punctuation">=</span><span class="token value attr-value">3</span>\n<span class="token key attr-name">transport.serialization</span><span class="token punctuation">=</span><span class="token value attr-value">seata</span>\n<span class="token key attr-name">transport.compressor</span><span class="token punctuation">=</span><span class="token value attr-value">none</span>\n\n<span class="token comment">#Transaction routing rules configuration, only for the client</span>\n<span class="token key attr-name">service.vgroupMapping.default_tx_group</span><span class="token punctuation">=</span><span class="token value attr-value">default</span>\n<span class="token comment">#If you use a registry, you can ignore it</span>\n<span class="token key attr-name">service.default.grouplist</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1:8091</span>\n<span class="token key attr-name">service.enableDegrade</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n<span class="token key attr-name">service.disableGlobalTransaction</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n\n<span class="token comment">#Transaction rule configuration, only for the client</span>\n<span class="token key attr-name">client.rm.asyncCommitBufferLimit</span><span class="token punctuation">=</span><span class="token value attr-value">10000</span>\n<span class="token key attr-name">client.rm.lock.retryInterval</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>\n<span class="token key attr-name">client.rm.lock.retryTimes</span><span class="token punctuation">=</span><span class="token value attr-value">30</span>\n<span class="token key attr-name">client.rm.lock.retryPolicyBranchRollbackOnConflict</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>\n<span class="token key attr-name">client.rm.reportRetryCount</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>\n<span class="token key attr-name">client.rm.tableMetaCheckEnable</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>\n<span class="token key attr-name">client.rm.tableMetaCheckerInterval</span><span class="token punctuation">=</span><span class="token value attr-value">60000</span>\n<span class="token key attr-name">client.rm.sqlParserType</span><span class="token punctuation">=</span><span class="token value attr-value">druid</span>\n<span class="token key attr-name">client.rm.reportSuccessEnable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n<span class="token key attr-name">client.rm.sagaBranchRegisterEnable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n<span class="token key attr-name">client.rm.sagaJsonParser</span><span class="token punctuation">=</span><span class="token value attr-value">fastjson</span>\n<span class="token key attr-name">client.rm.tccActionInterceptorOrder</span><span class="token punctuation">=</span><span class="token value attr-value">-2147482648</span>\n<span class="token key attr-name">client.tm.commitRetryCount</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>\n<span class="token key attr-name">client.tm.rollbackRetryCount</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>\n<span class="token key attr-name">client.tm.defaultGlobalTransactionTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">60000</span>\n<span class="token key attr-name">client.tm.degradeCheck</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n<span class="token key attr-name">client.tm.degradeCheckAllowTimes</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>\n<span class="token key attr-name">client.tm.degradeCheckPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">2000</span>\n<span class="token key attr-name">client.tm.interceptorOrder</span><span class="token punctuation">=</span><span class="token value attr-value">-2147482648</span>\n<span class="token key attr-name">client.undo.dataValidation</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>\n<span class="token key attr-name">client.undo.logSerialization</span><span class="token punctuation">=</span><span class="token value attr-value">jackson</span>\n<span class="token key attr-name">client.undo.onlyCareUpdateColumns</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>\n<span class="token key attr-name">server.undo.logSaveDays</span><span class="token punctuation">=</span><span class="token value attr-value">7</span>\n<span class="token key attr-name">server.undo.logDeletePeriod</span><span class="token punctuation">=</span><span class="token value attr-value">86400000</span>\n<span class="token key attr-name">client.undo.logTable</span><span class="token punctuation">=</span><span class="token value attr-value">undo_log</span>\n<span class="token key attr-name">client.undo.compress.enable</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>\n<span class="token key attr-name">client.undo.compress.type</span><span class="token punctuation">=</span><span class="token value attr-value">zip</span>\n<span class="token key attr-name">client.undo.compress.threshold</span><span class="token punctuation">=</span><span class="token value attr-value">64k</span>\n<span class="token comment">#For TCC transaction mode</span>\n<span class="token key attr-name">tcc.fence.logTableName</span><span class="token punctuation">=</span><span class="token value attr-value">tcc_fence_log</span>\n<span class="token key attr-name">tcc.fence.cleanPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">1h</span>\n\n<span class="token comment">#Log rule configuration, for client and server</span>\n<span class="token key attr-name">log.exceptionRate</span><span class="token punctuation">=</span><span class="token value attr-value">100</span>\n\n<span class="token comment">#Transaction storage configuration, only for the server. The file, DB, and redis configuration values are optional.</span>\n<span class="token key attr-name">store.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span>\n<span class="token key attr-name">store.lock.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span>\n<span class="token key attr-name">store.session.mode</span><span class="token punctuation">=</span><span class="token value attr-value">db</span>\n<span class="token comment">#Used for password encryption</span>\n<span class="token key attr-name">store.publicKey</span><span class="token punctuation">=</span>\n\n<span class="token comment">#If `store.mode,store.lock.mode,store.session.mode` are not equal to `file`, you can remove the configuration block.</span>\n<span class="token key attr-name">store.file.dir</span><span class="token punctuation">=</span><span class="token value attr-value">file_store/data</span>\n<span class="token key attr-name">store.file.maxBranchSessionSize</span><span class="token punctuation">=</span><span class="token value attr-value">16384</span>\n<span class="token key attr-name">store.file.maxGlobalSessionSize</span><span class="token punctuation">=</span><span class="token value attr-value">512</span>\n<span class="token key attr-name">store.file.fileWriteBufferCacheSize</span><span class="token punctuation">=</span><span class="token value attr-value">16384</span>\n<span class="token key attr-name">store.file.flushDiskMode</span><span class="token punctuation">=</span><span class="token value attr-value">async</span>\n<span class="token key attr-name">store.file.sessionReloadReadSize</span><span class="token punctuation">=</span><span class="token value attr-value">100</span>\n\n<span class="token comment">#These configurations are required if the `store mode` is `db`. If `store.mode,store.lock.mode,store.session.mode` are not equal to `db`, you can remove the configuration block.</span>\n<span class="token key attr-name">store.db.datasource</span><span class="token punctuation">=</span><span class="token value attr-value">druid</span>\n<span class="token key attr-name">store.db.dbType</span><span class="token punctuation">=</span><span class="token value attr-value">mysql</span>\n<span class="token key attr-name">store.db.driverClassName</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.cj.jdbc.Driver</span>\n<span class="token key attr-name">store.db.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://192.168.135.130:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true</span>\n<span class="token key attr-name">store.db.user</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>\n<span class="token key attr-name">store.db.password</span><span class="token punctuation">=</span><span class="token value attr-value">Root.123456</span>\n<span class="token key attr-name">store.db.minConn</span><span class="token punctuation">=</span><span class="token value attr-value">5</span>\n<span class="token key attr-name">store.db.maxConn</span><span class="token punctuation">=</span><span class="token value attr-value">30</span>\n<span class="token key attr-name">store.db.globalTable</span><span class="token punctuation">=</span><span class="token value attr-value">global_table</span>\n<span class="token key attr-name">store.db.branchTable</span><span class="token punctuation">=</span><span class="token value attr-value">branch_table</span>\n<span class="token key attr-name">store.db.distributedLockTable</span><span class="token punctuation">=</span><span class="token value attr-value">distributed_lock</span>\n<span class="token key attr-name">store.db.queryLimit</span><span class="token punctuation">=</span><span class="token value attr-value">100</span>\n<span class="token key attr-name">store.db.lockTable</span><span class="token punctuation">=</span><span class="token value attr-value">lock_table</span>\n<span class="token key attr-name">store.db.maxWait</span><span class="token punctuation">=</span><span class="token value attr-value">5000</span>\n\n<span class="token comment">#These configurations are required if the `store mode` is `redis`. If `store.mode,store.lock.mode,store.session.mode` are not equal to `redis`, you can remove the configuration block.</span>\n<span class="token key attr-name">store.redis.mode</span><span class="token punctuation">=</span><span class="token value attr-value">single</span>\n<span class="token key attr-name">store.redis.single.host</span><span class="token punctuation">=</span><span class="token value attr-value">127.0.0.1</span>\n<span class="token key attr-name">store.redis.single.port</span><span class="token punctuation">=</span><span class="token value attr-value">6379</span>\n<span class="token key attr-name">store.redis.sentinel.masterName</span><span class="token punctuation">=</span>\n<span class="token key attr-name">store.redis.sentinel.sentinelHosts</span><span class="token punctuation">=</span>\n<span class="token key attr-name">store.redis.maxConn</span><span class="token punctuation">=</span><span class="token value attr-value">10</span>\n<span class="token key attr-name">store.redis.minConn</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>\n<span class="token key attr-name">store.redis.maxTotal</span><span class="token punctuation">=</span><span class="token value attr-value">100</span>\n<span class="token key attr-name">store.redis.database</span><span class="token punctuation">=</span><span class="token value attr-value">0</span>\n<span class="token key attr-name">store.redis.password</span><span class="token punctuation">=</span>\n<span class="token key attr-name">store.redis.queryLimit</span><span class="token punctuation">=</span><span class="token value attr-value">100</span>\n\n<span class="token comment">#Transaction rule configuration, only for the server</span>\n<span class="token key attr-name">server.recovery.committingRetryPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span>\n<span class="token key attr-name">server.recovery.asynCommittingRetryPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span>\n<span class="token key attr-name">server.recovery.rollbackingRetryPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span>\n<span class="token key attr-name">server.recovery.timeoutRetryPeriod</span><span class="token punctuation">=</span><span class="token value attr-value">1000</span>\n<span class="token key attr-name">server.maxCommitRetryTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">-1</span>\n<span class="token key attr-name">server.maxRollbackRetryTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">-1</span>\n<span class="token key attr-name">server.rollbackRetryTimeoutUnlockEnable</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n<span class="token key attr-name">server.distributedLockExpireTime</span><span class="token punctuation">=</span><span class="token value attr-value">10000</span>\n<span class="token key attr-name">server.xaerNotaRetryTimeout</span><span class="token punctuation">=</span><span class="token value attr-value">60000</span>\n<span class="token key attr-name">server.session.branchAsyncQueueSize</span><span class="token punctuation">=</span><span class="token value attr-value">5000</span>\n<span class="token key attr-name">server.session.enableBranchAsyncRemove</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n<span class="token key attr-name">server.enableParallelRequestHandle</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n\n<span class="token comment">#Metrics configuration, only for the server</span>\n<span class="token key attr-name">metrics.enabled</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>\n<span class="token key attr-name">metrics.registryType</span><span class="token punctuation">=</span><span class="token value attr-value">compact</span>\n<span class="token key attr-name">metrics.exporterList</span><span class="token punctuation">=</span><span class="token value attr-value">prometheus</span>\n<span class="token key attr-name">metrics.exporterPrometheusPort</span><span class="token punctuation">=</span><span class="token value attr-value">9898</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br></div></div></details><hr><h3 id="启动" tabindex="-1"><a class="header-anchor" href="#启动" aria-hidden="true">#</a> 启动</h3><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>  <span class="token comment"># 需要进入bin目录下执行，否则找不到SpringBootApplication等类</span>\n  <span class="token builtin class-name">cd</span> /usr/local/seata/bin\n  seata-server.sh \n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="支持的启动参数" tabindex="-1"><a class="header-anchor" href="#支持的启动参数" aria-hidden="true">#</a> 支持的启动参数</h3><table><thead><tr><th>参数</th><th>全写</th><th>作用</th><th>备注</th></tr></thead><tbody><tr><td>-h</td><td>--host</td><td>指定在注册中心注册的 IP</td><td>不指定时获取当前的 IP，外部访问部署在云环境和容器中的 server 建议指定</td></tr><tr><td>-p</td><td>--port</td><td>指定 server 启动的端口</td><td>默认为 8091</td></tr><tr><td>-m</td><td>--storeMode</td><td>事务日志存储方式</td><td>支持file,db,redis，默认为 file 注:redis需seata-server 1.3版本及以上</td></tr><tr><td>-n</td><td>--serverNode</td><td>用于指定seata-server节点ID</td><td>如 1,2,3..., 默认为 1</td></tr><tr><td>-e</td><td>--seataEnv</td><td>指定 seata-server 运行环境</td><td>如 dev, test 等, 服务启动时会使用 registry-dev.conf 这样的配置</td></tr></tbody></table><p>比如：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 需要进入bin目录下执行，否则找不到SpringBootApplication等类</span>\n<span class="token builtin class-name">cd</span> /usr/local/seata/bin\n<span class="token comment"># 制定ip</span>\n./seata-server.sh <span class="token parameter variable">-h</span> <span class="token number">192.168</span>.135.130 <span class="token parameter variable">-p</span> <span class="token number">8091</span>\nseata-server.sh <span class="token parameter variable">-p</span> <span class="token number">8091</span> <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-m</span> db \n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="访问界面" tabindex="-1"><a class="header-anchor" href="#访问界面" aria-hidden="true">#</a> 访问界面</h3>',23),d={href:"http://192.168.135.130:7091/",target:"_blank",rel:"noopener noreferrer"},v=(0,t.Lk)("p",null,[(0,t.Lk)("img",{src:"/images/seata/image-20230420164849463.png",alt:"image-20230420164849463"})],-1),y=(0,t.Lk)("h2",{id:"seata-client快速开始",tabindex:"-1"},[(0,t.Lk)("a",{class:"header-anchor",href:"#seata-client快速开始","aria-hidden":"true"},"#"),(0,t.eW)(),(0,t.Lk)("strong",null,"Seata Client快速开始")],-1),g={href:"https://github.com/Q10Viking/learncode/tree/main/seata/learnSeata/MicroServices",target:"_blank",rel:"noopener noreferrer"},h=(0,t.Fv)('<div class="custom-container tip"><p class="custom-container-title">TIP</p><p><strong>Spring Cloud Alibaba整合Seata AT模式实战</strong></p></div><p><strong>业务场景</strong></p><p>用户下单，整个业务逻辑由三个微服务构成：</p><ul><li>库存服务：对给定的商品扣除库存数量。</li><li>订单服务：根据采购需求创建订单。</li><li>帐户服务：从用户帐户中扣除余额。</li></ul><p><img src="/images/seata/54076.png" alt="https://note.youdao.com/yws/public/resource/c480b9d259db401acff9fdd30a770d64/xmlnote/174DF4D5850D46D4A11920DF78129626/54076"></p><h3 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备" aria-hidden="true">#</a> <strong>环境准备</strong></h3>',6),f={href:"https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E",target:"_blank",rel:"noopener noreferrer"},T=(0,t.Fv)('<ul><li>父pom指定微服务版本</li></ul><table><thead><tr><th>Spring Cloud Alibaba Version</th><th>Spring Cloud Version</th><th>Spring Boot Version</th><th>Seata Version</th><th>nacos</th></tr></thead><tbody><tr><td>2.2.9.RELEASE</td><td>Spring Cloud Hoxton.SR12</td><td>2.3.12.RELEASE</td><td>1.5.2</td><td>2.1.0</td></tr></tbody></table><ul><li>启动Seata Server(TC)端，Seata Server使用nacos作为配置中心和注册中心</li><li>启动nacos服务</li></ul><h3 id="依赖" tabindex="-1"><a class="header-anchor" href="#依赖" aria-hidden="true">#</a> 依赖</h3><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-seata<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="微服务对应数据库中添加undo-log表-仅at模式" tabindex="-1"><a class="header-anchor" href="#微服务对应数据库中添加undo-log表-仅at模式" aria-hidden="true">#</a> 微服务对应数据库中添加undo_log表(仅AT模式)</h3>',6),w={href:"https://github.com/seata/seata/blob/1.5.2/script/client/at/db/mysql.sql",target:"_blank",rel:"noopener noreferrer"},S=(0,t.Fv)('<div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- for AT mode you must to init this sql for you business database. the seata server not need it.</span>\n<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>undo_log<span class="token punctuation">`</span></span>\n<span class="token punctuation">(</span>\n    <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span>     <span class="token keyword">BIGINT</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;branch transaction id&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span>           <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;global transaction id&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>context<span class="token punctuation">`</span></span>       <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;undo_log context,such as serialization&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>rollback_info<span class="token punctuation">`</span></span> <span class="token keyword">LONGBLOB</span>     <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;rollback info&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>log_status<span class="token punctuation">`</span></span>    <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;0:normal status,1:defense status&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>log_created<span class="token punctuation">`</span></span>   <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;create datetime&#39;</span><span class="token punctuation">,</span>\n    <span class="token identifier"><span class="token punctuation">`</span>log_modified<span class="token punctuation">`</span></span>  <span class="token keyword">DATETIME</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&#39;modify datetime&#39;</span><span class="token punctuation">,</span>\n    <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>ux_undo_log<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>xid<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>branch_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span>\n<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>\n  <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1</span>\n  <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COMMENT</span> <span class="token operator">=</span><span class="token string">&#39;AT transaction mode undo table&#39;</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="微服务application-yml中添加seata配" tabindex="-1"><a class="header-anchor" href="#微服务application-yml中添加seata配" aria-hidden="true">#</a> 微服务application.yml中添加seata配</h3><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">seata</span><span class="token punctuation">:</span>\n  <span class="token key atrule">application-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.application.name<span class="token punctuation">}</span>\n  <span class="token key atrule">tx-service-group</span><span class="token punctuation">:</span> default_tx_group\n  <span class="token key atrule">registry</span><span class="token punctuation">:</span>\n    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos\n    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>\n      <span class="token key atrule">application</span><span class="token punctuation">:</span> seata<span class="token punctuation">-</span>server\n      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.135.1<span class="token punctuation">:</span><span class="token number">8848</span>\n      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> c3f112d8<span class="token punctuation">-</span>1c5e<span class="token punctuation">-</span>419e<span class="token punctuation">-</span>9c83<span class="token punctuation">-</span>b0b26b987a42\n      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP\n  <span class="token key atrule">config</span><span class="token punctuation">:</span>\n    <span class="token key atrule">type</span><span class="token punctuation">:</span> nacos\n    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>\n      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.135.1<span class="token punctuation">:</span><span class="token number">8848</span>\n      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> c3f112d8<span class="token punctuation">-</span>1c5e<span class="token punctuation">-</span>419e<span class="token punctuation">-</span>9c83<span class="token punctuation">-</span>b0b26b987a42\n      <span class="token key atrule">group</span><span class="token punctuation">:</span> SEATA_GROUP\n      <span class="token key atrule">data-id</span><span class="token punctuation">:</span> seataServer.properties\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="在全局事务发起者中添加-globaltransactional注" tabindex="-1"><a class="header-anchor" href="#在全局事务发起者中添加-globaltransactional注" aria-hidden="true">#</a> 在全局事务发起者中添加@GlobalTransactional注</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>\n    <span class="token comment">//@Transactional</span>\n    <span class="token annotation punctuation">@GlobalTransactional</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;createOrder&quot;</span><span class="token punctuation">)</span>\n    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">saveOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderVo</span> orderVo<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>sqlSessionFactory<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;=============用户下单=================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前 XID: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RootContext</span><span class="token punctuation">.</span><span class="token function">getXID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 保存订单</span>\n        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        order<span class="token punctuation">.</span><span class="token function">setCommodityCode</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getCommodityCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        order<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        order<span class="token punctuation">.</span><span class="token function">setMoney</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        order<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">INIT</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">Integer</span> saveOrderRecord <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;保存订单{}&quot;</span><span class="token punctuation">,</span> saveOrderRecord <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&quot;成功&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">//扣减库存</span>\n        storageFeignService<span class="token punctuation">.</span><span class="token function">deduct</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getCommodityCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderVo<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">//扣减余额   服务降级  throw</span>\n        <span class="token class-name">Boolean</span> debit<span class="token operator">=</span> accountFeignService<span class="token punctuation">.</span><span class="token function">debit</span><span class="token punctuation">(</span>orderVo<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderVo<span class="token punctuation">.</span><span class="token function">getMoney</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">//        if(!debit){</span>\n<span class="token comment">//            // 解决 feign整合sentinel降级导致SeaTa失效的处理</span>\n<span class="token comment">//            throw new RuntimeException(&quot;账户服务异常降级了&quot;);</span>\n<span class="token comment">//        }</span>\n\n        <span class="token comment">//更新订单</span>\n        <span class="token class-name">Integer</span> updateOrderRecord <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;更新订单id:{} {}&quot;</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> updateOrderRecord <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&quot;成功&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">return</span> order<span class="token punctuation">;</span>\n\n    <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>\n<span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">debit</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> money<span class="token punctuation">)</span><span class="token punctuation">{</span>\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;=============用户账户扣款=================&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;当前 XID: {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">RootContext</span><span class="token punctuation">.</span><span class="token function">getXID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token function">checkBalance</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;开始扣减用户 {} 余额&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">Integer</span> record <span class="token operator">=</span> accountMapper<span class="token punctuation">.</span><span class="token function">reduceBalance</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">ERROR_USER_ID</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token comment">// 模拟异常</span>\n        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;account branch exception&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;扣减用户 {} 余额结果:{}&quot;</span><span class="token punctuation">,</span> userId<span class="token punctuation">,</span> record <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">&quot;操作成功&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;扣减余额失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="测试" tabindex="-1"><a class="header-anchor" href="#测试" aria-hidden="true">#</a> 测试</h3><p><img src="/images/seata/image-20230420212526253.png" alt="image-20230420212526253"></p><h2 id="小结" tabindex="-1"><a class="header-anchor" href="#小结" aria-hidden="true">#</a> 小结</h2><p><img src="/images/seata/image-20230420212644627.png" alt="image-20230420212644627"></p><blockquote><p>全局事务ID与分支事务ID</p></blockquote><p><img src="/images/seata/image-20230420211158758.png" alt="image-20230420211158758"></p><p><img src="/images/seata/image-20230420211241807.png" alt="image-20230420211241807"></p><h2 id="seata版本" tabindex="-1"><a class="header-anchor" href="#seata版本" aria-hidden="true">#</a> Seata版本</h2><blockquote><p>1.5.1的版本它依赖的jar包都集成到了seata-server.jar包中，使用mysql8不方便添加lib.没有lib目录</p><p>1.5.2的版本，有lib目录，依赖的包都在lib目录下，并且有mysql8的jar包</p></blockquote><p><img src="/images/seata/image-20230420182419565.png" alt="image-20230420182419565"></p>',16),E={},R=(0,a(66262).A)(E,[["render",function(n,s){const a=(0,t.g2)("OutboundLink");return(0,t.uX)(),(0,t.CE)(t.FK,null,[e,(0,t.Lk)("p",null,[(0,t.Lk)("a",p,[(0,t.eW)("Releases · seata/seata (github.com)"),(0,t.bF)(a)])]),o,c,l,(0,t.Lk)("p",null,[(0,t.eW)("创建数据库seata，执行sql脚本，"),(0,t.Lk)("a",u,[(0,t.eW)("https://github.com/seata/seata/tree/v1.5.2/script/server/db"),(0,t.bF)(a)])]),r,(0,t.Lk)("p",null,[(0,t.Lk)("a",i,[(0,t.eW)("nacos (seata.io)"),(0,t.bF)(a)])]),k,(0,t.Lk)("p",null,[(0,t.Lk)("a",b,[(0,t.eW)("seata/config.txt at v1.5.2 · seata/seata (github.com)"),(0,t.bF)(a)])]),m,(0,t.Lk)("p",null,[(0,t.Lk)("a",d,[(0,t.eW)("http://192.168.135.130:7091/"),(0,t.bF)(a)])]),v,y,(0,t.Lk)("p",null,[(0,t.Lk)("a",g,[(0,t.eW)("Source Code"),(0,t.bF)(a)])]),h,(0,t.Lk)("p",null,[(0,t.Lk)("a",f,[(0,t.eW)("版本说明 · alibaba/spring-cloud-alibaba Wiki (github.com)"),(0,t.bF)(a)])]),T,(0,t.Lk)("p",null,[(0,t.Lk)("a",w,[(0,t.eW)("seata/mysql.sql at 1.5.2 · seata/seata (github.com)"),(0,t.bF)(a)])]),S],64)}]])},66262:(n,s)=>{s.A=(n,s)=>{const a=n.__vccOpts||n;for(const[n,t]of s)a[n]=t;return a}}}]);