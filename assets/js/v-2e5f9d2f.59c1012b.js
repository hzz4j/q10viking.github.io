"use strict";(self.webpackChunkq10viking_github_io=self.webpackChunkq10viking_github_io||[]).push([[44785],{74754:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-2e5f9d2f",path:"/RocketMQ/24%20%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0.html",title:"",lang:"zh-CN",frontmatter:{sidebarDepth:3,sidebar:"auto",prev:{text:"Back To 目录",link:"/RocketMQ/"},"typora-root-url":"..\\.vuepress\\public"},excerpt:"",headers:[{level:2,title:"架构设计",slug:"架构设计",children:[]},{level:2,title:"延迟消息转存",slug:"延迟消息转存",children:[{level:3,title:"消息到期处理",slug:"消息到期处理",children:[]}]},{level:2,title:"总结",slug:"总结",children:[]}],filePathRelative:"RocketMQ/24 延迟消息如何实现.md"}},81785:(n,s,a)=>{a.r(s),a.d(s,{default:()=>t});const p=(0,a(20641).Fv)('<h2 id="架构设计" tabindex="-1"><a class="header-anchor" href="#架构设计" aria-hidden="true">#</a> 架构设计</h2><p><img src="/images/RocketMQ/fcb7a451739cdcf22efc8f2add972228.png" alt="img"></p><h2 id="延迟消息转存" tabindex="-1"><a class="header-anchor" href="#延迟消息转存" aria-hidden="true">#</a> 延迟消息转存</h2><p>当 <code>producer</code> 发送延迟消息的时候，broker 肯定必须要等到消息到期了，才能让 <code>consumer</code> 消费消息。</p><p>也就是说，消息在 <code>broker</code> 端必须做额外的处理，才能避免。</p><p><img src="/images/RocketMQ/image-20240326215506125.png" alt="image-20240326215506125"></p><h4 id="topic、queueid-转存" tabindex="-1"><a class="header-anchor" href="#topic、queueid-转存" aria-hidden="true">#</a> topic、queueId 转存</h4><p><code>broker</code> 在消息准备写入 <code>commitlog</code> 之前，会将消息 <code>topic</code> 重设为 <strong><code>SCHEDULE_TOPIC_XXXX</code></strong>, <code>queueId</code> 重设为 <code>delayLevel - 1</code>。 再将原始的 <code>topic</code>, <code>queueId</code> 写入到消息的 <code>properties</code> 中，以便消息到期时，能够恢复原消息的 <code>topic</code>, <code>queueId</code>。</p><p>代码位置：<strong><code>DefaultMessageStore#putMessage(final MessageExtBrokerInner msg)</code></strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommitLog</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">PutMessageResult</span> <span class="token function">putMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">MessageExtBrokerInner</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n        msg<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">//TODO 将发送的延迟消息转存到另外的 SCHEDULE_TOPIC_XXXX topic 中</span>\n        topic <span class="token operator">=</span> <span class="token class-name">ScheduleMessageService</span><span class="token punctuation">.</span><span class="token constant">SCHEDULE_TOPIC</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// TODO 将延迟等级 -1 作为我们的 queueId</span>\n        queueId <span class="token operator">=</span> <span class="token class-name">ScheduleMessageService</span><span class="token punctuation">.</span><span class="token function">delayLevel2QueueId</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// Backup real topic, queueId</span>\n        <span class="token comment">// TODO 备份我们的原始 topic, 以及原始 queueId</span>\n        <span class="token comment">// TODO REAL_TOPIC, REAL_QID</span>\n        <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_TOPIC</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">MessageAccessor</span><span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token class-name">MessageConst</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_REAL_QUEUE_ID</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        msg<span class="token punctuation">.</span><span class="token function">setPropertiesString</span><span class="token punctuation">(</span><span class="token class-name">MessageDecoder</span><span class="token punctuation">.</span><span class="token function">messageProperties2String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        msg<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        msg<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span>queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token punctuation">}</span>\n   <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>经过以上处理后，<code>Consumer</code> 就无法立即消费到刚发送的延迟消息。</p><h4 id="consumequeue-子条目-tagscode-重置" tabindex="-1"><a class="header-anchor" href="#consumequeue-子条目-tagscode-重置" aria-hidden="true">#</a> ConsumeQueue 子条目 tagsCode 重置</h4><p><code>Broker</code> 在将 <code>CommitLog</code> 转存到 <code>ConsumeQueue</code> 时，如果发现是延迟消息，会将 <code>tagsCode</code> 设置为 消息的到期时间。</p><p>代码位置：<strong><code>CommitLog#checkMessageAndReturnSize</code></strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CommitLog</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">public</span> <span class="token class-name">DispatchRequest</span> <span class="token function">checkMessageAndReturnSize</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span></span>ByteBuffer</span> byteBuffer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> checkCRC<span class="token punctuation">,</span>\n\n    <span class="token keyword">final</span> <span class="token keyword">boolean</span> readBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n    <span class="token comment">//TODO 如果是延迟消息，那么会将消息的到期时间，存储为 tagsCode</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>delayLevel <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n            tagsCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">computeDeliverTimestamp</span><span class="token punctuation">(</span>delayLevel<span class="token punctuation">,</span>\n\n            storeTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token punctuation">}</span>\n\n    <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="消息到期处理" tabindex="-1"><a class="header-anchor" href="#消息到期处理" aria-hidden="true">#</a> 消息到期处理</h3><p><code>Broker</code> 如何感知到消息已经到期，可以让 <code>Consumer</code> 消费，这是重点。下面，来看看 <code>RocketMQ</code> 的取巧处理。</p><p>我们知道，<code>Broker</code> 端可以通过配置 <code>messageDelayLevel</code> 来改变 <code>RocketMQ</code> 默认延迟等级配置。</p><p>下面就是 <code>RocketMQ</code> 默认的配置</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>messageDelayLevel<span class="token operator">=</span><span class="token number">1</span>s <span class="token number">5</span>s <span class="token number">10</span>s <span class="token number">30</span>s <span class="token number">1</span>m <span class="token number">2</span>m <span class="token number">3</span>m <span class="token number">4</span>m <span class="token number">5</span>m <span class="token number">6</span>m <span class="token number">7</span>m <span class="token number">8</span>m <span class="token number">9</span>m <span class="token number">10</span>m <span class="token number">20</span>m <span class="token number">30</span>m <span class="token number">1</span>h <span class="token number">2</span>h\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h4 id="解析-messagedelaylevel-配置" tabindex="-1"><a class="header-anchor" href="#解析-messagedelaylevel-配置" aria-hidden="true">#</a> 解析 messageDelayLevel 配置</h4><p><code>Broker</code> 启动时，会解析 <code>messageDelayLevel</code> 配置</p><p>代码位置: <strong><code>ScheduleMessageService#parseDelayLevel()</code></strong></p><p>主要的逻辑如下：</p><p>解析 <code>messageDelayLevel</code> 并将值放入 <code>delayLevelTable</code> map 中。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduleMessageService</span> <span class="token keyword">extends</span> <span class="token class-name">ConfigManager</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">parseDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> timeUnitTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        timeUnitTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;s&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        timeUnitTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;m&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        timeUnitTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;h&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        timeUnitTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">,</span> <span class="token number">1000L</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token class-name">String</span> levelString <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n\n            <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> levelArray <span class="token operator">=</span> levlString<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> levelArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n                <span class="token class-name">String</span> value <span class="token operator">=</span> levelArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n                <span class="token class-name">String</span> ch <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                <span class="token class-name">Long</span> tu <span class="token operator">=</span> timeUnitTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                <span class="token keyword">int</span> level <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>\n\n                <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxDelayLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n                    <span class="token keyword">this</span><span class="token punctuation">.</span>maxDelayLevel <span class="token operator">=</span> level<span class="token punctuation">;</span>\n\n                <span class="token punctuation">}</span>\n\n                <span class="token keyword">long</span> num <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n                <span class="token keyword">long</span> delayTimeMillis <span class="token operator">=</span> tu <span class="token operator">*</span> num<span class="token punctuation">;</span>\n\n                <span class="token keyword">this</span><span class="token punctuation">.</span>delayLevelTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> delayTimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token punctuation">}</span>\n\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;parseDelayLevel exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;levelString String = {}&quot;</span><span class="token punctuation">,</span> levelString<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><h4 id="timer启动" tabindex="-1"><a class="header-anchor" href="#timer启动" aria-hidden="true">#</a> Timer启动</h4><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span>started<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token string">&quot;ScheduleMessageTimerThread&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 获取配置的延迟等级</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delayLevelTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token class-name">Integer</span> level <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token class-name">Long</span> timeDelay <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token comment">// 每个延迟等级的消费偏移</span>\n            <span class="token class-name">Long</span> offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offsetTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                offset <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n            <span class="token comment">// 初始化延迟调度任务</span>\n\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>timeDelay <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeliverDelayedMessageTimerTask</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">FIRST_DELAY_TIME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p><code>offsetTable</code> 是在 <code>Broker</code> 启动的时候，从 <code>${storePath}/store/config/delayOffset.json</code> 解析出来的。该文件存储的内容是一个 <code>json</code>, 存放着每个延迟等级对应的 的消费偏移。大致如下</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n  <span class="token property">&quot;offsetTable&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token operator">:</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token operator">:</span><span class="token number">1</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="如何保证有序性" tabindex="-1"><a class="header-anchor" href="#如何保证有序性" aria-hidden="true">#</a> 如何保证有序性</h4><p>在设计延迟队列时，一般需要保证存储的数据是有序的，这样才能减少遍历访问条数。</p><p>Java 的 <code>DelayQueue</code> 依赖小顶堆做排序，Redisson 的 DelayQueue 依赖 <code>zset</code> 做数据排序。</p><p>在 RocketMQ 中，只支持固定时间的延迟。<strong>RocketMQ 按照不同延迟分 18 个队列来保证数据有序，即在一个队列中，先入队列的永远比后入队列的先到期</strong></p><h4 id="deliverdelayedmessagetimertask" tabindex="-1"><a class="header-anchor" href="#deliverdelayedmessagetimertask" aria-hidden="true">#</a> DeliverDelayedMessageTimerTask</h4><p><code>Timer</code> 中的任务是 <code>DeliverDelayedMessageTimerTask</code>, 接下来看下该类的 <code>run()</code> 方法实现逻辑。</p><p><code>run()</code> 执行的逻辑如下</p><ol><li>根据 延迟队列的 消费偏移，从对应队列中获取消息</li><li>根据 <code>ConsumeQueue</code> 子条目中的 <code>tagsCode</code> 拿到消息存储时的时间戳</li><li>将 <code>tagsCode</code> 与当前时间对比，如果小于等于当前时间，则将延迟消息恢复为原消息，供 <code>Consumer</code> 消费</li><li>继续调度下一个延迟消息</li></ol><p><img src="/images/RocketMQ/3fe0d2dacc930454c88b75a9d51d148b.png" alt="img"></p><h4 id="消费偏移持久化" tabindex="-1"><a class="header-anchor" href="#消费偏移持久化" aria-hidden="true">#</a> 消费偏移持久化</h4><p>如果 RocketMQ 宕机，如何保证下次启动仍然能够从上次的 offset 消费呢？</p><p>RocketMQ 维护了一个每隔 10s 运行一次的 Timer，目的是将每个队列的消费情况写入文件，等到下次重启时，可以从上次消费位置进行消费。</p><p>因为不是实时同步，有一定的时间间隔，所以，有可能会出现重复消息的情况。我们需要在消费端做幂等处理，避免重复消费。</p><p>代码位置：<strong><code>ScheduleMessageService#start()</code></strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduleMessageService</span> <span class="token keyword">extends</span> <span class="token class-name">ConfigManager</span> <span class="token punctuation">{</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>started<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 默认每隔 10s，执行一次持久化</span>\n            <span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token annotation punctuation">@Override</span>\n                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                        <span class="token keyword">if</span> <span class="token punctuation">(</span>started<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token class-name">ScheduleMessageService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;scheduleAtFixedRate flush exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    <span class="token punctuation">}</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushDelayOffsetInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><ul><li><strong>RocketMQ 支持 18 个时间等级的延迟消息</strong></li><li><strong>在存储层面，RocketMQ 通过修改 topic 保证不被提前消费，生成 18 个队列保证消息的有序性</strong></li><li><strong>基于 Timer 机制实现轮询 consume queue 逻辑</strong></li><li><strong>固定时间等级的可用性比较差，需要改造才能用于业务开发</strong></li></ul>',47),e={},t=(0,a(66262).A)(e,[["render",function(n,s){return p}]])},66262:(n,s)=>{s.A=(n,s)=>{const a=n.__vccOpts||n;for(const[n,p]of s)a[n]=p;return a}}}]);