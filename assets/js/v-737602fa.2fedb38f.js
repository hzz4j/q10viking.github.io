"use strict";(self.webpackChunkq10viking_github_io=self.webpackChunkq10viking_github_io||[]).push([[8688],{66457:(n,s,a)=>{a.r(s),a.d(s,{data:()=>t});const t={key:"v-737602fa",path:"/springboot/08%20%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE.html",title:"",lang:"zh-CN",frontmatter:{sidebarDepth:3,sidebar:"auto",prev:{text:"Back To 目录",link:"/springboot/"},"typora-root-url":"..\\.vuepress\\public"},excerpt:"",headers:[{level:2,title:"SpringBoot自动配置的原理",slug:"springboot自动配置的原理",children:[]},{level:2,title:"自动配置类",slug:"自动配置类",children:[]},{level:2,title:"条件注解",slug:"条件注解",children:[{level:3,title:"具体原理",slug:"具体原理",children:[]}]},{level:2,title:"starter机制",slug:"starter机制",children:[]},{level:2,title:"顺序问题",slug:"顺序问题",children:[]},{level:2,title:"加载配置类",slug:"加载配置类",children:[{level:3,title:"读取SpringBoot的imports和spring.factories文件",slug:"读取springboot的imports和spring-factories文件",children:[]},{level:3,title:"解析",slug:"解析",children:[]},{level:3,title:"过滤",slug:"过滤",children:[]}]}],filePathRelative:"springboot/08 自动配置.md"}},63337:(n,s,a)=>{a.r(s),a.d(s,{default:()=>b});var t=a(20641);const p=(0,t.Fv)('<h2 id="springboot自动配置的原理" tabindex="-1"><a class="header-anchor" href="#springboot自动配置的原理" aria-hidden="true">#</a> SpringBoot自动配置的原理</h2><p>SpringBoot集成第三方的组件，都是有@EnableXXX,@import</p><p>延迟，分组的特性DeferredImportSelector+Condition来处理springboot约定配置的许多bean,以及解决顺序问题</p><p>DeferredImportSelector还有一个Group，会调用process方法来处理spring.factories文件</p><p>Spring.factories 配置中的类筛选，根据key,<strong>再根据starter场景启动器,以及配置的Condition</strong>，使得类变成bean放入到容器中生效</p><p>看配置类的定制方式，来自己覆盖，或者根据全局配置文件</p><hr><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>依赖的类报红效果，maven 的optional 设置为true,不会传递</p></div><h2 id="自动配置类" tabindex="-1"><a class="header-anchor" href="#自动配置类" aria-hidden="true">#</a> 自动配置类</h2>',9),o={href:"https://github.com/Q10Viking/learncode/tree/main/springboot/_02-springboot-start-analysis",target:"_blank",rel:"noopener noreferrer"},e=(0,t.Fv)('<ol><li>ServletWebServerFactoryAutoConfiguration：配置了Servlet Web场景中所需要的一些Bean</li><li>TransactionAutoConfiguration：配置了事务场景中所需要的一些Bean</li><li>AopAutoConfiguration：配置了AOP场景中所需要的一些Bean</li><li>RabbitAutoConfiguration：配置了Rabbitmq场景中所需要的一些Bean</li></ol><p>使用这种结构后，SpringBoot就能让程序员更为方便的来控制<strong>某个Bean或某些Bean要不要生效</strong>，如果某个自动配置类不生效，那该配置类中所定义的Bean则都不会生效</p><p><img src="/images/springboot/image-20230407191749448.png" alt="image-20230407191749448"></p><h2 id="条件注解" tabindex="-1"><a class="header-anchor" href="#条件注解" aria-hidden="true">#</a> 条件注解</h2><blockquote><p>SpringBoot控制某个自动配置类或某个Bean生不生效</p></blockquote><ol><li>ConditionalOnBean：是否存在某个某类或某个名字的Bean</li><li>ConditionalOnMissingBean：是否缺失某个某类或某个名字的Bean</li><li>ConditionalOnSingleCandidate：是否符合指定类型的Bean只有一个</li><li>ConditionalOnClass：是否存在某个类</li><li>ConditionalOnMissingClass：是否缺失某个类</li><li>ConditionalOnExpression：指定的表达式返回的是true还是false</li><li>ConditionalOnJava：判断Java版本</li><li>ConditionalOnJndi：JNDI指定的资源是否存在</li><li>ConditionalOnWebApplication：当前应用是一个Web应用</li><li>ConditionalOnNotWebApplication：当前应用不是一个Web应用</li><li>ConditionalOnProperty：Environment中是否存在某个属性</li><li>ConditionalOnResource：指定的资源是否存在</li><li>ConditionalOnWarDeployment：当前项目是不是以War包部署的方式运行</li><li>ConditionalOnCloudPlatform：是不是在某个云平台上</li></ol><p>当然我们也可以利用@Conditional来自定义条件注解。</p><p>条件注解是可以写在类上和方法上的，如果某个条件注解写在了自动配置类上，那该自动配置类会不会生效就要看当前条件能不能符合，或者条件注解写在某个@Bean修饰的方法上，那这个Bean生不生效就看当前条件符不符合。</p><h3 id="具体原理" tabindex="-1"><a class="header-anchor" href="#具体原理" aria-hidden="true">#</a> 具体原理</h3><ol><li>Spring在解析某个自动配置类时，会先检查该自动配置类上是否有条件注解，如果有，则进一步判断该条件注解所指定的条件当前能不能满足，如果满足了则继续解析该配置类，如果不满足则不进行解析了，也就是配置类所定义的Bean都得不到解析，也就是相当于没有这些Bean了。</li><li>同理，Spring在解析某个@Bean的方法时，也会先判断方法上是否有条件注解，然后进行解析，如果不满足条件，则该Bean不会生效</li></ol><blockquote><p>我们可以发现，SpringBoot的自动配置，实际上就是SpringBoot的源码中预先写好了一些配置类，预先定义好了一些Bean，我们在用SpringBoot时，这些配置类就已经在我们项目的依赖中了，而这些自动配置类或自动配置Bean到底生不生效，就看具体所指定的条件了。</p></blockquote><h2 id="starter机制" tabindex="-1"><a class="header-anchor" href="#starter机制" aria-hidden="true">#</a> starter机制</h2><blockquote><p>SpringBoot中的Starter和自动配置又有什么关系呢？</p></blockquote><p>其实首先要明白一个Starter，就是一个Maven依赖，当我们在项目的pom.xml文件中添加某个Starter依赖时，其实就是简单的添加了很多其他的依赖，比如：</p><ol><li>spring-boot-starter-web：引入了spring-boot-starter、spring-boot-starter-json、spring-boot-starter-tomcat等和Web开发相关的依赖包</li><li>spring-boot-starter-tomcat：引入了tomcat-embed-core、tomcat-embed-el、tomcat-embed-websocket等和Tomcat相关的依赖包</li></ol><p><img src="/images/springboot/image-20230407192558680.png" alt="image-20230407192558680"></p><p>如果硬要把Starter机制和自动配置联系起来，那就是通过@ConditionalOnClass这个条件注解，因为这个条件注解的作用就是用来判断当前应用的依赖中是否存在某个类或某些类，比如：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">Servlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Tomcat</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">UpgradeProtocol</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">ServletWebServerFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> search <span class="token operator">=</span> <span class="token class-name">SearchStrategy</span><span class="token punctuation">.</span><span class="token constant">CURRENT</span><span class="token punctuation">)</span>\n<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EmbeddedTomcat</span> <span class="token punctuation">{</span>\n\n    <span class="token annotation punctuation">@Bean</span>\n    <span class="token class-name">TomcatServletWebServerFactory</span> <span class="token function">tomcatServletWebServerFactory</span><span class="token punctuation">(</span>\n        <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TomcatConnectorCustomizer</span><span class="token punctuation">&gt;</span></span> connectorCustomizers<span class="token punctuation">,</span>\n        <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TomcatContextCustomizer</span><span class="token punctuation">&gt;</span></span> contextCustomizers<span class="token punctuation">,</span>\n        <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TomcatProtocolHandlerCustomizer</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> protocolHandlerCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">TomcatServletWebServerFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TomcatServletWebServerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        factory<span class="token punctuation">.</span><span class="token function">getTomcatConnectorCustomizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>connectorCustomizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        factory<span class="token punctuation">.</span><span class="token function">getTomcatContextCustomizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>contextCustomizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        factory<span class="token punctuation">.</span><span class="token function">getTomcatProtocolHandlerCustomizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>protocolHandlerCustomizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>上面代码中就用到了@ConditionalOnClass，用来判断项目中是否存在Servlet.class、Tomcat.class、UpgradeProtocol.class这三个类，如果存在就满足当前条件，如果项目中引入了spring-boot-starter-tomcat，那就有这三个类，如果没有spring-boot-starter-tomcat那就可能没有这三个类（除非你自己单独引入了Tomcat相关的依赖）。</p><p>而如果不想用Tomcat，那就得这么写：</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>\n    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-jetty<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>\n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>得把spring-boot-starter-tomcat给排除掉，再添加上spring-boot-starter-jetty的依赖，这样Tomcat的Bean就不会生效，Jetty的Bean就能生效，从而项目中用的就是Jetty。</p><p><img src="/images/springboot/image-20230407194901783.png" alt="image-20230407194901783"></p><h2 id="顺序问题" tabindex="-1"><a class="header-anchor" href="#顺序问题" aria-hidden="true">#</a> 顺序问题</h2><p>@ConditionalOnMissingBean的作用是用来判断某个Bean是否缺失，如果<strong>不存在</strong>某个Bean，那就<strong>符合该条件</strong>，理解起来比较简单，但是细细想一下就会存在一个问题，就是顺序问题，还是拿上面的代码举例：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token class-name">Servlet</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Tomcat</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">UpgradeProtocol</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">ServletWebServerFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> search <span class="token operator">=</span> <span class="token class-name">SearchStrategy</span><span class="token punctuation">.</span><span class="token constant">CURRENT</span><span class="token punctuation">)</span>\n<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EmbeddedTomcat</span> <span class="token punctuation">{</span>\n\n    <span class="token annotation punctuation">@Bean</span>\n    <span class="token class-name">TomcatServletWebServerFactory</span> <span class="token function">tomcatServletWebServerFactory</span><span class="token punctuation">(</span>\n        <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TomcatConnectorCustomizer</span><span class="token punctuation">&gt;</span></span> connectorCustomizers<span class="token punctuation">,</span>\n        <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TomcatContextCustomizer</span><span class="token punctuation">&gt;</span></span> contextCustomizers<span class="token punctuation">,</span>\n        <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TomcatProtocolHandlerCustomizer</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> protocolHandlerCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">TomcatServletWebServerFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TomcatServletWebServerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        factory<span class="token punctuation">.</span><span class="token function">getTomcatConnectorCustomizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>connectorCustomizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        factory<span class="token punctuation">.</span><span class="token function">getTomcatContextCustomizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>contextCustomizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        factory<span class="token punctuation">.</span><span class="token function">getTomcatProtocolHandlerCustomizers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n            <span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>protocolHandlerCustomizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> factory<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>这个代码中就用到了@ConditionalOnMissingBean，意思是如果当前不存在ServletWebServerFactory类型的Bean，那就符合条件，结合整体代码，意思就是，：</p><ol><li>如果用户自己<strong>没有定义</strong>ServletWebServerFactory类型的Bean，那代码中所定义的Bean就会<strong>生效</strong>，</li><li>如果用户自己定义了ServletWebServerFactory类型的Bean，那代码中定义的Bean就不生效</li></ol><p>所以这个注解是非常重要的，SpringBoot利用这个注解来决定到底用用户自己的Bean，还是用SpringBoot自动配置的。</p><p>关键问题在于，不管是自动配置类中定义的Bean，还是用户定义的Bean，都是需要解析的，而且是有一个顺序的。</p><p>如果是：</p><ol><li>先解析的SpringBoot自动配置类，比如上面的EmbeddedTomcat类</li><li>再解析程序员定义的Bean</li></ol><p>那@ConditionalOnMissingBean的判断结果是有问题的，因为是先解析的EmbeddedTomcat，在解析的时候是没有发现程序员所定义的Bean的，就会认为符合@ConditionalOnMissingBean的条件，而实际上程序员是定义了的，只是还没有解析到，所以这就需要SpringBoot把这个顺序控制好，控制为：</p><ol><li>先解析用户的定义的Bean，也就是解析用户定义的配置类（包含了扫描和@Bean的解析）</li><li>再解析SpringBoot中的自动配置类</li></ol><p>不管是用户定义的配置类还是自动配置类，都是配置类（简单理解就是加了@Configuration注解）。SpringBoot启动时，最核心的也就是创建一个Spring容器，而创建Spring容器的过程中会注解做几件事情：</p><ol><li>把SpringApplication.run(MyApplication.class)传入进来的MyApplication类做为配置类进行解析</li><li>由于MyApplication类上定义了@SpringBootApplication，相当于定义了@SpringBootConfiguration、@EnableAutoConfiguration、@ComponentScan注解</li><li>所以SpringBoot会进一步解析这些注解</li></ol><ul><li><ol><li>@EnableAutoConfiguration：通过@import注解导入AutoConfigurationImportSelector这个配置类，因为它实现了DeferredImportSelector接口，所以Spring会在把其他配置类都解析完之后才解析AutoConfigurationImportSelector（Spring Framework中的知识）</li><li>@ComponentScan：扫描，扫描时会扫描到用户所定义的配置类，并解析用户的配置类，注意：扫描是扫描不到SpringBoot的自动配置的类，因为扫描的包路径不匹配，SpringBoot的包都是org.springframework.boot.xxxx，用户都是自己的包路径。</li></ol></li></ul><p>通过上述过程我们发现，Spring会在最后才来解析AutoConfigurationImportSelector这个配置类，而这个类的作用就是用来解析SpringBoot的自动配置类，那既然无法扫描到SpringBoot中的自动配置类，那怎么知道SpringBoot中有哪些自动配置类呢，这就需要spring.factories文件，默认情况下，SpringBoot会提供一个spring.factories文件，并把所有自动配置类的名字记录在这个文件中，到时候启动过程中解析这个文件就知道有哪些自动配置类了，并且这件事也是发生在解析完用户的配置类之后的。</p><hr><h2 id="加载配置类" tabindex="-1"><a class="header-anchor" href="#加载配置类" aria-hidden="true">#</a> 加载配置类</h2>',40),c={href:"https://www.processon.com/view/link/642fcfc5242fb51ae706088b",target:"_blank",rel:"noopener noreferrer"},l=(0,t.Fv)('<div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootConfiguration</span>\n<span class="token annotation punctuation">@EnableAutoConfiguration</span>\n<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>excludeFilters <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token annotation punctuation">@Filter</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FilterType</span><span class="token punctuation">.</span><span class="token constant">CUSTOM</span><span class="token punctuation">,</span> classes <span class="token operator">=</span> <span class="token class-name">TypeExcludeFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n\t\t<span class="token annotation punctuation">@Filter</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">FilterType</span><span class="token punctuation">.</span><span class="token constant">CUSTOM</span><span class="token punctuation">,</span> classes <span class="token operator">=</span> <span class="token class-name">AutoConfigurationExcludeFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>\n<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">SpringBootApplication</span> <span class="token punctuation">{</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>如果我们这么用就能自己控制要不要用@EnableAutoConfiguration这个注解，如果用就表示开启自动配置，如果不用就表示不开启自动配置，那开启和不开启自动配置到底该怎么理解呢？</p><p>我们前面分析过，SpringBoot的自动配置就是SpringBoot帮助程序员配置一些Bean，从而让程序员在用SpringBoot时可以少去配置很多Bean，所以如果我们开启了自动配置，那最终Spring容器中就有SpringBoot帮我们配置的Bean，如果没有开启自动配置，那Spring容器中就没有这些Bean，就需要程序员去配置。</p><p>那我们来看看@EnableAutoConfiguration这个注解是如何工作的？先看源码定义</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@AutoConfigurationPackage</span>\n<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">AutoConfigurationImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\t<span class="token comment">//\t非常核心</span>\n<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableAutoConfiguration</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>AutoConfigurationImportSelector实现了DeferredImportSelector这个接口，Spring容器在启动时，会在解析完其他所有程序员定义的配置类之后，来调用AutoConfigurationImportSelector中的selectImports方法，然后把该方法返回的类名对应的类作为配置类进行解析。</p><p>该方法会利用SpringFactoriesLoader找到所有的META-INF/spring.factories文件中key为EnableAutoConfiguration.class的value值，也就是众多自动配置类的类名。</p><h3 id="读取springboot的imports和spring-factories文件" tabindex="-1"><a class="header-anchor" href="#读取springboot的imports和spring-factories文件" aria-hidden="true">#</a> 读取SpringBoot的imports和spring.factories文件</h3><blockquote><p>存放的都是自动配置类</p></blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>org.springframework.boot.autoconfigure.AutoConfiguration.imports\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p><img src="/images/springboot/image-20230407142412446.png" alt="image-20230407142412446"></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration\norg.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration\norg.springframework.boot.autoconfigure.jooq.JooqAutoConfiguration\norg.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="解析" tabindex="-1"><a class="header-anchor" href="#解析" aria-hidden="true">#</a> 解析</h3>',13),i={href:"https://q10viking.github.io/FileSystem/06%20%E8%AF%BB%E6%96%87%E4%BB%B6.html",target:"_blank",rel:"noopener noreferrer"},u=(0,t.Fv)('<h3 id="过滤" tabindex="-1"><a class="header-anchor" href="#过滤" aria-hidden="true">#</a> 过滤</h3><p><img src="/images/springboot/image-20230407202837845.png" alt="image-20230407202837845"></p><blockquote><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>META-INF/spring-autoconfigure-metadata.properties\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></blockquote><p><img src="/images/springboot/image-20230407202736639.png" alt="image-20230407202736639"></p><p>其实过滤很很简单，看看组装的在不在这个文件中有没有value.</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>\n<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">String</span> defaultValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token class-name">String</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>className <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> value <span class="token operator">:</span> defaultValue<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token comment">// className-&gt; org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration</span>\n<span class="token comment">// defaultValue-&gt; ConditionalOnClass</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>springboot的application.properties中配置<code>debug=true</code>,可以看到匹配的类型</p></div><p><img src="/images/springboot/image-20230408153841606.png" alt="image-20230408153841606"></p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>手写过滤，在看源码的过程中，发现它的这种设计非常巧妙，用来两个线程来处理过滤，打算模拟实现一下</p></div>',9),r={href:"https://github.com/Q10Viking/learncode/tree/main/javafile/_03-read-properties-file-filter",target:"_blank",rel:"noopener noreferrer"},k=(0,t.Fv)('<p>起一个线程去执行，然后主线程继续执行任务，然后等待第一个线程执行完毕，主线程再继续执行</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>将任务分成两份\n0 1 2 3 4 \n\n0 1\n2 3 4 \n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> configurations<span class="token punctuation">,</span> <span class="token class-name">Properties</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> match <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span>configurations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">int</span> split <span class="token operator">=</span> configurations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>\n\n    <span class="token comment">// 子线程执行，在构造方法中</span>\n    <span class="token class-name">OutcomesResolver</span> first <span class="token operator">=</span> <span class="token function">createOutcomesResolver</span><span class="token punctuation">(</span>configurations<span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> split<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">OutcomesResolver</span> second <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StandardOutcomesResolver</span><span class="token punctuation">(</span>configurations<span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span> split<span class="token punctuation">,</span> configurations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 主线程执行</span>\n    <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> secondHalf <span class="token operator">=</span> second<span class="token punctuation">.</span><span class="token function">resolveOutcomes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// 等待子线程执行完毕</span>\n    <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> firstHalf <span class="token operator">=</span> first<span class="token punctuation">.</span><span class="token function">resolveOutcomes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>firstHalf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> match<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> firstHalf<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>secondHalf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> match<span class="token punctuation">,</span> split<span class="token punctuation">,</span> secondHalf<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> match<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n\n<span class="token keyword">public</span> <span class="token class-name">OutcomesResolver</span> <span class="token function">createOutcomesResolver</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> configurations<span class="token punctuation">,</span> <span class="token class-name">Properties</span> metadata<span class="token punctuation">,</span>\n                                               <span class="token class-name">String</span> key<span class="token punctuation">,</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span><span class="token punctuation">{</span>\n    <span class="token class-name">OutcomesResolver</span> outcomesResolver <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">StandardOutcomesResolver</span><span class="token punctuation">(</span>configurations<span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> key<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadedOutcomesResolver</span><span class="token punctuation">(</span>outcomesResolver<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadedOutcomesResolver</span> <span class="token keyword">implements</span> <span class="token class-name">OutcomesResolver</span><span class="token punctuation">{</span>\n    <span class="token keyword">private</span> final Thread thread<span class="token punctuation">;</span>\n    <span class="token keyword">private</span> volatile boolean<span class="token punctuation">[</span><span class="token punctuation">]</span> outcomes<span class="token punctuation">;</span>\n    <span class="token keyword">public</span> <span class="token function">ThreadedOutcomesResolver</span><span class="token punctuation">(</span><span class="token parameter">OutcomesResolver outcomesResolver</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>outcomes <span class="token operator">=</span> outcomesResolver<span class="token punctuation">.</span><span class="token function">resolveOutcomes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>thread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n\n    @Override\n    <span class="token keyword">public</span> boolean<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">resolveOutcomes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            thread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> outcomes<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div>',4),m={},b=(0,a(66262).A)(m,[["render",function(n,s){const a=(0,t.g2)("OutboundLink"),m=(0,t.g2)("common-progresson-snippet");return(0,t.uX)(),(0,t.CE)(t.FK,null,[p,(0,t.Lk)("p",null,[(0,t.Lk)("a",o,[(0,t.eW)("Source Code"),(0,t.bF)(a)])]),e,(0,t.Lk)("p",null,[(0,t.Lk)("a",c,[(0,t.eW)("Link"),(0,t.bF)(a)])]),(0,t.bF)(m,{src:"https://www.processon.com/view/link/642fcfc5242fb51ae706088b"}),l,(0,t.Lk)("p",null,[(0,t.eW)("参考："),(0,t.Lk)("a",i,[(0,t.eW)("读文件-Q10Viking"),(0,t.bF)(a)])]),u,(0,t.Lk)("p",null,[(0,t.Lk)("a",r,[(0,t.eW)("Source Code"),(0,t.bF)(a)])]),k],64)}]])},66262:(n,s)=>{s.A=(n,s)=>{const a=n.__vccOpts||n;for(const[n,t]of s)a[n]=t;return a}}}]);