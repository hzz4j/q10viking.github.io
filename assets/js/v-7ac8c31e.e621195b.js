"use strict";(self.webpackChunkq10viking_github_io=self.webpackChunkq10viking_github_io||[]).push([[66677],{67959:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-7ac8c31e",path:"/zk/14%20zk%E5%AE%9E%E7%8E%B0%E7%BB%9F%E4%B8%80%E5%91%BD%E5%90%8D%E6%9C%8D%E5%8A%A1.html",title:"",lang:"zh-CN",frontmatter:{sidebarDepth:3,sidebar:"auto",prev:{text:"Back To 目录",link:"/zk/"},"typora-root-url":"..\\.vuepress\\public"},excerpt:"",headers:[{level:2,title:"分布式API目录",slug:"分布式api目录",children:[]},{level:2,title:"分布式节点的命名",slug:"分布式节点的命名",children:[]},{level:2,title:"分布式的ID生成器",slug:"分布式的id生成器",children:[]},{level:2,title:"基于Zookeeper实现分布式ID生成器",slug:"基于zookeeper实现分布式id生成器",children:[]},{level:2,title:"基于Zookeeper实现SnowFlakeID算法",slug:"基于zookeeper实现snowflakeid算法",children:[{level:3,title:"实现",slug:"实现",children:[]},{level:3,title:"测试",slug:"测试",children:[]}]}],filePathRelative:"zk/14 zk实现统一命名服务.md"}},47705:(n,s,a)=>{a.r(s),a.d(s,{default:()=>u});var p=a(20641);const e=(0,p.Fv)('<div class="custom-container tip"><p class="custom-container-title">TIP</p><p>命名服务是为系统中的资源提供标识能力。ZooKeeper的命名服务主要是利用ZooKeeper节点的树形分层结构和子节点的顺序维护能力，来为分布式系统中的资源命名</p></div><h2 id="分布式api目录" tabindex="-1"><a class="header-anchor" href="#分布式api目录" aria-hidden="true">#</a> 分布式API目录</h2><p>为分布式系统中各种API接口服务的名称、链接地址，提供类似JNDI（Java命名和目录接口）中的文件系统的功能。借助于ZooKeeper的树形分层结构就能提供分布式的API调用功能。</p><p>著名的Dubbo分布式框架就是应用了ZooKeeper的分布式的JNDI功能。在Dubbo中，使用ZooKeeper维护的全局服务接口API的地址列表。大致的思路为：</p><ul><li>服务提供者（Service Provider）在启动的时候，向ZooKeeper上的指定节点/dubbo/${serviceName}/providers写入自己的API地址，这个操作就相当于服务的公开。</li><li>服务消费者（Consumer）启动的时候，订阅节点/dubbo/{serviceName}/providers下的服务提供者的URL地址，获得所有服务提供者的API。</li></ul><p><img src="/images/zk/45745.png" alt="https://note.youdao.com/yws/public/resource/5a0db3f32e7cf39f309b3581014ae965/xmlnote/8616B14BA3EA4BCE84AD597C5DAAC933/45745"></p><hr><h2 id="分布式节点的命名" tabindex="-1"><a class="header-anchor" href="#分布式节点的命名" aria-hidden="true">#</a> 分布式节点的命名</h2><p>一个分布式系统通常会由很多的节点组成，节点的数量不是固定的，而是不断动态变化的。比如说，当业务不断膨胀和流量洪峰到来时，大量的节点可能会动态加入到集群中。而一旦流量洪峰过去了，就需要下线大量的节点。再比如说，由于机器或者网络的原因，一些节点会主动离开集群。</p><p>如何为大量的动态节点命名呢？一种简单的办法是可以通过配置文件，手动为每一个节点命名。但是，如果节点数据量太大，或者说变动频繁，手动命名则是不现实的，这就需要用到分布式节点的命名服务。</p><p>可用于生成集群节点的编号的方案：</p><p>（1）使用数据库的自增ID特性，用数据表存储机器的MAC地址或者IP来维护。</p><p>（2）使用ZooKeeper持久顺序节点的顺序特性来维护节点的NodeId编号。</p><p>在第2种方案中，集群节点命名服务的基本流程是：</p><ul><li>启动节点服务，连接ZooKeeper，检查命名服务根节点是否存在，如果不存在，就创建系统的根节点。</li><li>在根节点下创建一个临时顺序ZNode节点，取回ZNode的编号把它作为分布式系统中节点的NODEID。</li><li>如果临时节点太多，可以根据需要删除临时顺序ZNode节点。</li></ul><h2 id="分布式的id生成器" tabindex="-1"><a class="header-anchor" href="#分布式的id生成器" aria-hidden="true">#</a> 分布式的ID生成器</h2><p>在分布式系统中，分布式ID生成器的使用场景非常之多：</p><ul><li>大量的数据记录，需要分布式ID。</li><li>大量的系统消息，需要分布式ID。</li><li>大量的请求日志，如restful的操作记录，需要唯一标识，以便进行后续的用户行为分析和调用链路分析。</li><li>分布式节点的命名服务，往往也需要分布式ID。</li><li>。。。</li></ul><p>传统的数据库自增主键已经不能满足需求。在分布式系统环境中，迫切需要一种全新的唯一ID系统，这种系统需要满足以下需求：</p><p>（1）全局唯一：不能出现重复ID。</p><p>（2）高可用：ID生成系统是基础系统，被许多关键系统调用，一旦宕机，就会造成严重影响。</p><p>有哪些分布式的ID生成器方案呢？大致如下：</p><ol><li>Java的UUID。</li><li>分布式缓存Redis生成ID：利用Redis的原子操作INCR和INCRBY，生成全局唯一的ID。</li><li>Twitter的SnowFlake算法。</li><li>ZooKeeper生成ID：利用ZooKeeper的顺序节点，生成全局唯一的ID。</li><li>MongoDb的ObjectId:MongoDB是一个分布式的非结构化NoSQL数据库，每插入一条记录会自动生成全局唯一的一个“_id”字段值，它是一个12字节的字符串，可以作为分布式系统中全局唯一的ID。</li></ol><h2 id="基于zookeeper实现分布式id生成器" tabindex="-1"><a class="header-anchor" href="#基于zookeeper实现分布式id生成器" aria-hidden="true">#</a> 基于Zookeeper实现分布式ID生成器</h2><p>在ZooKeeper节点的四种类型中，其中有以下两种类型具备自动编号的能力</p><ul><li>PERSISTENT_SEQUENTIAL持久化顺序节点。</li><li>EPHEMERAL_SEQUENTIAL临时顺序节点。</li></ul><p>ZooKeeper的每一个节点都会为它的第一级子节点维护一份顺序编号，会记录每个子节点创建的先后顺序，这个顺序编号是分布式同步的，也是全局唯一的。</p><p>可以通过创建ZooKeeper的临时顺序节点的方法，生成全局唯一的ID</p>',28),t={href:"https://github.com/Q10Viking/learncode/tree/main/zookeeper/lock/src/main/java/org/hzz/lock/zk/id",target:"_blank",rel:"noopener noreferrer"},o=(0,p.Fv)('<div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>\n@Slf4j\npublic class IDMaker <span class="token punctuation">{</span>\n\n    private final ZooKeeper zooKeeper<span class="token punctuation">;</span>\n    private final String path <span class="token operator">=</span> <span class="token string">&quot;/idmaker/id-&quot;</span><span class="token punctuation">;</span>\n\n    public <span class="token function-name function">IDMaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n        while<span class="token punctuation">(</span><span class="token operator">!</span>ZookeeperFactory.isStarted<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">{</span><span class="token punctuation">}</span>\n        zooKeeper <span class="token operator">=</span> ZookeeperFactory.getZookeeper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        try <span class="token punctuation">{</span>\n            zooKeeper.create<span class="token punctuation">(</span><span class="token string">&quot;/idmaker&quot;</span>, null,\n                    ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.CONTAINER, null<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>KeeperException <span class="token operator">|</span> InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            log.info<span class="token punctuation">(</span><span class="token string">&quot;idmaker container exists&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n\n    public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws InterruptedException <span class="token punctuation">{</span>\n        Executor executor <span class="token operator">=</span> <span class="token builtin class-name">command</span> -<span class="token operator">&gt;</span> <span class="token punctuation">{</span>\n            Thread thread <span class="token operator">=</span> new Thread<span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            thread.start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span><span class="token punctuation">;</span>\n\n        IDMaker idMaker <span class="token operator">=</span> new IDMaker<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        for<span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i++<span class="token punctuation">)</span><span class="token punctuation">{</span>\n            executor.execute<span class="token punctuation">((</span><span class="token punctuation">)</span>-<span class="token operator">&gt;</span><span class="token punctuation">{</span>\n                String <span class="token function">id</span> <span class="token operator">=</span> idMaker.makeId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                log.info<span class="token punctuation">(</span><span class="token string">&quot;id: {}&quot;</span>, <span class="token function">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        Thread.currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span>.join<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    public String <span class="token function-name function">makeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n        String destPath <span class="token operator">=</span> createEphemeralSequential<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        if<span class="token punctuation">(</span>destPath <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>\n            int index <span class="token operator">=</span> destPath.lastIndexOf<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            if<span class="token punctuation">(</span>index <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n                index <span class="token operator">+=</span> path.length<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token builtin class-name">return</span> index <span class="token operator">&lt;=</span> destPath.length<span class="token punctuation">(</span><span class="token punctuation">)</span> ? destPath.substring<span class="token punctuation">(</span>index<span class="token punctuation">)</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        <span class="token builtin class-name">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    private String createEphemeralSequential<span class="token punctuation">(</span>String path<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        try <span class="token punctuation">{</span>\n            String destPath <span class="token operator">=</span> zooKeeper.create<span class="token punctuation">(</span>path, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL, null<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            log.info<span class="token punctuation">(</span><span class="token string">&quot;createEphemeralSequential: {}&quot;</span>, destPath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token builtin class-name">return</span> destPath<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>KeeperException  <span class="token operator">|</span> InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token builtin class-name">return</span> null<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n/**\n * IDMaker <span class="token punctuation">[</span>Thread-1<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> createEphemeralSequential: /idmaker/id-0000000000\n * IDMaker <span class="token punctuation">[</span>Thread-1<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> id: 0000000000\n * IDMaker <span class="token punctuation">[</span>Thread-2<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> createEphemeralSequential: /idmaker/id-0000000001\n * IDMaker <span class="token punctuation">[</span>Thread-2<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> id: 0000000001\n * IDMaker <span class="token punctuation">[</span>Thread-3<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> createEphemeralSequential: /idmaker/id-0000000002\n * IDMaker <span class="token punctuation">[</span>Thread-3<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> id: 0000000002\n * IDMaker <span class="token punctuation">[</span>Thread-4<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> createEphemeralSequential: /idmaker/id-0000000003\n * IDMaker <span class="token punctuation">[</span>Thread-4<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> id: 0000000003\n * IDMaker <span class="token punctuation">[</span>Thread-5<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> createEphemeralSequential: /idmaker/id-0000000004\n * IDMaker <span class="token punctuation">[</span>Thread-5<span class="token punctuation">]</span> <span class="token builtin class-name">:</span> id: 0000000004\n */\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h2 id="基于zookeeper实现snowflakeid算法" tabindex="-1"><a class="header-anchor" href="#基于zookeeper实现snowflakeid算法" aria-hidden="true">#</a> 基于Zookeeper实现SnowFlakeID算法</h2><blockquote><p>主要用zk来生成workId，避免自己手动配置workID</p><p>zookeeper产生的序列号，恰好是10位</p><p>snowflake 算法中，第三个部分是工作机器ID，可以结合上面的命名方法,通过Zookeeper管理workId，免去手动频繁修改集群节点，去配置机器ID的麻烦</p></blockquote><p><img src="/images/zk/image-20230428213359950.png" alt="image-20230428213359950"></p><h3 id="实现" tabindex="-1"><a class="header-anchor" href="#实现" aria-hidden="true">#</a> 实现</h3>',5),l={href:"https://github.com/Q10Viking/learncode/tree/main/zookeeper/lock/src/main/java/org/hzz/lock/zk/id",target:"_blank",rel:"noopener noreferrer"},c=(0,p.Fv)('<div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>\n<span class="token doc-comment comment">/**\n * Twitter_Snowflake\n * SnowFlake的结构如下(每部分用-分开):\n * 0 - 0000000000 0000000000 0000000000 0000000000 0 - 00000 - 00000 - 000000000000\n * 1位标识，由于long基本类型在Java中是带符号的，最高位是符号位，正数是0，负数是1，所以id一般是正数，最高位是0\n * 41位时间戳(毫秒级)，注意，41位时间戳不是存储当前时间的时间戳，而是存储时间戳的差值（当前时间戳 - 开始时间戳)\n * 得到的值），这里的的开始时间戳，一般是我们的id生成器开始使用的时间，由我们程序来指定的\n * （如下面程序SnowflakeIdWorker类的startTime属性）。\n * 41位的时间戳，可以使用69年，年T = (1L &lt;&lt; 41) / (1000L * 60 * 60 * 24 * 365) = 69\n * 10位的数据机器位，可以部署在1024个节点，包括5位datacenterId和5位workerId\n * 12位序列，毫秒内的计数，12位的计数顺序号支持每个节点每毫秒(同一机器，同一时间戳)产生4096个ID序号\n * 加起来刚好64位，为一个Long型。\n */</span>\n<span class="token annotation punctuation">@Slf4j</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnowflakeIdWorker</span> <span class="token punctuation">{</span>\n\n    <span class="token doc-comment comment">/**\n     * 数据标识id所占的位数\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> datacenterIdBits <span class="token operator">=</span> <span class="token number">5L</span><span class="token punctuation">;</span>\n\n    <span class="token doc-comment comment">/**\n     * 机器id所占的位数\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> workerIdBits <span class="token operator">=</span> <span class="token number">5L</span><span class="token punctuation">;</span>\n    <span class="token doc-comment comment">/**\n     * 序列在id中占的位数\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequenceBits <span class="token operator">=</span> <span class="token number">12L</span><span class="token punctuation">;</span>\n\n\n    <span class="token doc-comment comment">/**\n     * 时间戳向左移22位(5+5+12)\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timestampLeftShift <span class="token operator">=</span> sequenceBits <span class="token operator">+</span> workerIdBits <span class="token operator">+</span> datacenterIdBits<span class="token punctuation">;</span>\n\n    <span class="token doc-comment comment">/**\n     * 机器ID向左移12位\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> workerIdShift <span class="token operator">=</span> sequenceBits<span class="token punctuation">;</span>\n\n    <span class="token doc-comment comment">/**\n     * 支持的最大机器id\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxWorkerId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>workerIdBits<span class="token operator">+</span>datacenterIdBits<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n\n    <span class="token doc-comment comment">/**\n     * 生成序列的掩码，这里为4095，对应二进制 1111 1111 1111\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequenceMask <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> sequenceBits<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n    <span class="token doc-comment comment">/**\n     * 工作机器ID(0~31)\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> workerId<span class="token punctuation">;</span>\n\n    <span class="token doc-comment comment">/**\n     * 毫秒内序列(0~4095)\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>\n\n    <span class="token doc-comment comment">/**\n     * 上次生成ID的时间戳\n     */</span>\n    <span class="token keyword">private</span> <span class="token keyword">long</span> lastTimestamp <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>\n\n    <span class="token doc-comment comment">/**\n     * 构造函数\n     *\n     * <span class="token keyword">@param</span> <span class="token parameter">workerId</span>     工作ID (0~31)\n     */</span>\n    <span class="token keyword">public</span> <span class="token class-name">SnowflakeIdWorker</span><span class="token punctuation">(</span><span class="token keyword">long</span> workerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>workerId <span class="token operator">&gt;</span> maxWorkerId <span class="token operator">||</span> workerId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;worker Id can&#39;t be greater than %d or less than 0&quot;</span><span class="token punctuation">,</span> maxWorkerId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">this</span><span class="token punctuation">.</span>workerId <span class="token operator">=</span> workerId<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n\n    <span class="token doc-comment comment">/**\n     * 获得下一个ID (该方法是线程安全的)\n     *\n     * <span class="token keyword">@return</span> SnowflakeId\n     */</span>\n    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">//如果当前时间小于上一次ID生成的时间戳，说明系统时钟回退过这个时候应当抛出异常</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>\n                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Clock moved backwards.  Refusing to generate id for %d milliseconds&quot;</span><span class="token punctuation">,</span> lastTimestamp <span class="token operator">-</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">//如果是同一时间生成的，则进行毫秒内序列</span>\n        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTimestamp <span class="token operator">==</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">//当sequence累加到4096，也就是0001000000000000时，和sequenceMask相与后sequence=0</span>\n            sequence <span class="token operator">=</span> <span class="token punctuation">(</span>sequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> sequenceMask<span class="token punctuation">;</span>\n            <span class="token comment">//毫秒内序列溢出</span>\n            <span class="token keyword">if</span> <span class="token punctuation">(</span>sequence <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                <span class="token comment">//阻塞到下一个毫秒,获得新的时间戳</span>\n                timestamp <span class="token operator">=</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span>lastTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n        <span class="token punctuation">}</span>\n        <span class="token comment">//时间戳改变，毫秒内序列重置</span>\n        <span class="token keyword">else</span> <span class="token punctuation">{</span>\n            sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">//上次生成ID的时间戳</span>\n        lastTimestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>\n\n\n        <span class="token comment">//移位并通过或运算拼到一起组成64位的ID</span>\n        <span class="token keyword">return</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;&lt;</span> timestampLeftShift<span class="token punctuation">)</span>       <span class="token comment">// 时间戳左移22位</span>\n                <span class="token operator">|</span> <span class="token punctuation">(</span>workerId <span class="token operator">&lt;&lt;</span> workerIdShift<span class="token punctuation">)</span>          <span class="token comment">//机器id标识左移12位</span>\n                <span class="token operator">|</span> sequence<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token doc-comment comment">/**\n     * 阻塞到下一个毫秒，直到获得新的时间戳\n     *\n     * <span class="token keyword">@param</span> <span class="token parameter">lastTimestamp</span> 上次生成ID的时间戳\n     * <span class="token keyword">@return</span> 当前时间戳\n     */</span>\n    <span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span><span class="token keyword">long</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">while</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;=</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">return</span> timestamp<span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br></div></div><h3 id="测试" tabindex="-1"><a class="header-anchor" href="#测试" aria-hidden="true">#</a> 测试</h3><p><img src="/images/zk/carbonidmarker.png" alt="carbonidmarker"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**\n * 测试使用zk生产雪花算法id\n */</span>\n<span class="token annotation punctuation">@Slf4j</span>\n<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnowflakeIdWorkerTest</span> <span class="token punctuation">{</span>\n    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token class-name">IDMaker</span> idMaker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IDMaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">Executor</span> executor <span class="token operator">=</span> command <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token comment">// 3个线程，每个线程生成3个id</span>\n        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>\n                <span class="token class-name">String</span> workIDStr <span class="token operator">=</span> idMaker<span class="token punctuation">.</span><span class="token function">makeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token class-name">SnowflakeIdWorker</span> snowflakeIdWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SnowflakeIdWorker</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>workIDStr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                    <span class="token keyword">long</span> id <span class="token operator">=</span> snowflakeIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;workdId:{} 生产 id:{}&quot;</span><span class="token punctuation">,</span>workIDStr<span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>\n                <span class="token punctuation">}</span>\n            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n<span class="token doc-comment comment">/**\n * 21:29:05.332 IDMaker [Thread-1] : createEphemeralSequential: /idmaker/id-0000000000\n * 21:29:05.334 SnowflakeIdWorkerTest [Thread-1] : workdId:0000000000 生产 id:7057707296444383232\n * 21:29:05.334 SnowflakeIdWorkerTest [Thread-1] : workdId:0000000000 生产 id:7057707296448577536\n * 21:29:05.334 SnowflakeIdWorkerTest [Thread-1] : workdId:0000000000 生产 id:7057707296448577537\n * 21:29:05.341 IDMaker [Thread-2] : createEphemeralSequential: /idmaker/id-0000000001\n * 21:29:05.345 SnowflakeIdWorkerTest [Thread-2] : workdId:0000000001 生产 id:7057707296477941760\n * 21:29:05.345 SnowflakeIdWorkerTest [Thread-2] : workdId:0000000001 生产 id:7057707296494718976\n * 21:29:05.345 SnowflakeIdWorkerTest [Thread-2] : workdId:0000000001 生产 id:7057707296494718977\n * 21:29:05.349 IDMaker [Thread-3] : createEphemeralSequential: /idmaker/id-0000000002\n * 21:29:05.350 SnowflakeIdWorkerTest [Thread-3] : workdId:0000000002 生产 id:7057707296515694592\n * 21:29:05.350 SnowflakeIdWorkerTest [Thread-3] : workdId:0000000002 生产 id:7057707296515694593\n * 21:29:05.350 SnowflakeIdWorkerTest [Thread-3] : workdId:0000000002 生产 id:7057707296515694594\n */</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div>',4),r={},u=(0,a(66262).A)(r,[["render",function(n,s){const a=(0,p.g2)("OutboundLink");return(0,p.uX)(),(0,p.CE)(p.FK,null,[e,(0,p.Lk)("p",null,[(0,p.Lk)("a",t,[(0,p.eW)("Source Code"),(0,p.bF)(a)])]),o,(0,p.Lk)("p",null,[(0,p.Lk)("a",l,[(0,p.eW)("Source Code"),(0,p.bF)(a)])]),c],64)}]])},66262:(n,s)=>{s.A=(n,s)=>{const a=n.__vccOpts||n;for(const[n,p]of s)a[n]=p;return a}}}]);