<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <link rel="icon" href="/images/favicon-32x32.png"><title>é™é»˜ã®Blog</title><meta name="description" content="é™é»˜çš„Vuepress Blog">
    <link rel="preload" href="/assets/js/runtime~app.2c87fbe0.js" as="script"><link rel="preload" href="/assets/css/styles.b779b927.css" as="style"><link rel="preload" href="/assets/js/95615.aba5921d.js" as="script"><link rel="preload" href="/assets/js/app.4aafd1f6.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.b779b927.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">é™é»˜ã®Blog</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="ğŸ“—Menu"><!--[--><!--]--> ğŸ“—Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/topicNav/" class="nav-link" aria-label="ğŸ“—Menu"><!--[--><!--]--> ğŸ“—Menu <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/aboutme/" class="nav-link" aria-label="AboutMe"><!--[--><!--]--> AboutMe <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/Q10Viking/q10viking.github.io" rel="noopener noreferrer" target="_blank" aria-label="Github"><!--[--><!--]--> Github <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item"></p><ul class=""><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#ä¸šåŠ¡ç³»ç»Ÿå¯¹åˆ†å¸ƒå¼idçš„éœ€æ±‚" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ä¸šåŠ¡ç³»ç»Ÿå¯¹åˆ†å¸ƒå¼IDçš„éœ€æ±‚"><!--[--><!--]--> ä¸šåŠ¡ç³»ç»Ÿå¯¹åˆ†å¸ƒå¼IDçš„éœ€æ±‚ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#uuid" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="UUID"><!--[--><!--]--> UUID <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#ä¼˜ç‚¹" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ä¼˜ç‚¹"><!--[--><!--]--> ä¼˜ç‚¹ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#ç¼ºç‚¹" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ç¼ºç‚¹"><!--[--><!--]--> ç¼ºç‚¹ <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#é›ªèŠ±ç®—æ³•" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="é›ªèŠ±ç®—æ³•"><!--[--><!--]--> é›ªèŠ±ç®—æ³• <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#æ—¶é—´æˆ³ä½æ•°41ä½" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="æ—¶é—´æˆ³ä½æ•°41ä½"><!--[--><!--]--> æ—¶é—´æˆ³ä½æ•°41ä½ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#ä¼˜ç‚¹-1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ä¼˜ç‚¹"><!--[--><!--]--> ä¼˜ç‚¹ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#ç¼ºç‚¹-1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ç¼ºç‚¹"><!--[--><!--]--> ç¼ºç‚¹ <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#mysql" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#ä¼˜ç‚¹-2" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ä¼˜ç‚¹"><!--[--><!--]--> ä¼˜ç‚¹ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#ç¼ºç‚¹-2" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ç¼ºç‚¹"><!--[--><!--]--> ç¼ºç‚¹ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#ä¼˜åŒ–" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ä¼˜åŒ–"><!--[--><!--]--> ä¼˜åŒ– <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#redis" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Redis"><!--[--><!--]--> Redis <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#ç¾å›¢leaf" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="ç¾å›¢Leaf"><!--[--><!--]--> ç¾å›¢Leaf <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#leaf-segmentæ•°æ®åº“æ–¹æ¡ˆ" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Leaf-segmentæ•°æ®åº“æ–¹æ¡ˆ"><!--[--><!--]--> Leaf-segmentæ•°æ®åº“æ–¹æ¡ˆ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#leaf-snowflakeæ–¹æ¡ˆ" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Leaf-snowflakeæ–¹æ¡ˆ"><!--[--><!--]--> Leaf-snowflakeæ–¹æ¡ˆ <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/SpringCloud/11%20%E5%88%86%E5%B8%83%E5%BC%8Fid.html#å‚è€ƒ" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="å‚è€ƒ"><!--[--><!--]--> å‚è€ƒ <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h2 id="ä¸šåŠ¡ç³»ç»Ÿå¯¹åˆ†å¸ƒå¼idçš„éœ€æ±‚" tabindex="-1"><a class="header-anchor" href="#ä¸šåŠ¡ç³»ç»Ÿå¯¹åˆ†å¸ƒå¼idçš„éœ€æ±‚" aria-hidden="true">#</a> ä¸šåŠ¡ç³»ç»Ÿå¯¹åˆ†å¸ƒå¼IDçš„éœ€æ±‚</h2><ul><li><strong>å…¨å±€å”¯ä¸€æ€§</strong>ï¼šä¸èƒ½å‡ºç°é‡å¤çš„IDå·ï¼Œæ—¢ç„¶æ˜¯å”¯ä¸€æ ‡è¯†ï¼Œè¿™æ˜¯æœ€åŸºæœ¬çš„è¦æ±‚ã€‚</li><li><strong>è¶‹åŠ¿é€’å¢</strong>ã€<strong>å•è°ƒé€’å¢</strong>ï¼šä¿è¯ä¸‹ä¸€ä¸ªIDä¸€å®šå¤§äºä¸Šä¸€ä¸ªIDã€‚</li><li><strong>ä¿¡æ¯å®‰å…¨</strong>ï¼šå¦‚æœIDæ˜¯è¿ç»­çš„ï¼Œæ¶æ„ç”¨æˆ·çš„æ‰’å–å·¥ä½œå°±éå¸¸å®¹æ˜“åšäº†ï¼Œç›´æ¥æŒ‰ç…§é¡ºåºä¸‹è½½æŒ‡å®šURLå³å¯ï¼›å¦‚æœæ˜¯è®¢å•å·å°±æ›´å±é™©äº†ï¼Œç«å¯¹å¯ä»¥ç›´æ¥çŸ¥é“æˆ‘ä»¬ä¸€å¤©çš„å•é‡ã€‚æ‰€ä»¥åœ¨ä¸€äº›åº”ç”¨åœºæ™¯ä¸‹ï¼Œä¼šéœ€è¦IDæ— è§„åˆ™ã€ä¸è§„åˆ™ã€‚</li></ul><h2 id="uuid" tabindex="-1"><a class="header-anchor" href="#uuid" aria-hidden="true">#</a> UUID</h2><p><a href="">Source Code</a></p><p>UUID(Universally Unique Identifier)çš„æ ‡å‡†å‹å¼åŒ…å«32ä¸ª16è¿›åˆ¶æ•°å­—ï¼Œä»¥è¿å­—å·åˆ†ä¸ºäº”æ®µï¼Œå½¢å¼ä¸º8-4-4-4-12çš„36ä¸ªå­—ç¬¦</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>hzz</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UUIDDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> uuid <span class="token operator">=</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> minUuid <span class="token operator">=</span> uuid<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>minUuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;------------------------------------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * e3b34629-a9e7-43ad-9eee-4e5b558343c3
 * e3b34629a9e743ad9eee4e5b558343c3
 * ------------------------------------
 * 5d63b7e4-2864-4ae2-91bb-fb4241729704
 * 5d63b7e428644ae291bbfb4241729704
 * ------------------------------------
 * 98d3e5c9-326d-4e7b-ad13-b551ec6e985a
 * 98d3e5c9326d4e7bad13b551ec6e985a
 * ------------------------------------
 * 741b14bb-d4f9-45ae-84bf-8327c321baa0
 * 741b14bbd4f945ae84bf8327c321baa0
 * ------------------------------------
 * 3746e1c8-5ea3-4eaa-aed9-7c99fc44b9fa
 * 3746e1c85ea34eaaaed97c99fc44b9fa
 * ------------------------------------
 */</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="ä¼˜ç‚¹" tabindex="-1"><a class="header-anchor" href="#ä¼˜ç‚¹" aria-hidden="true">#</a> ä¼˜ç‚¹</h3><p>æ€§èƒ½éå¸¸é«˜ï¼šæœ¬åœ°ç”Ÿæˆï¼Œæ²¡æœ‰ç½‘ç»œæ¶ˆè€—ã€‚</p><h3 id="ç¼ºç‚¹" tabindex="-1"><a class="header-anchor" href="#ç¼ºç‚¹" aria-hidden="true">#</a> ç¼ºç‚¹</h3><ol><li>ä¸æ˜“äºå­˜å‚¨ï¼šUUIDå¤ªé•¿ï¼Œ16å­—èŠ‚128ä½ï¼Œé€šå¸¸ä»¥36é•¿åº¦çš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå¾ˆå¤šåœºæ™¯ä¸é€‚ç”¨ã€‚</li><li>ä¿¡æ¯ä¸å®‰å…¨ï¼šåŸºäºMACåœ°å€ç”ŸæˆUUIDçš„ç®—æ³•å¯èƒ½ä¼šé€ æˆMACåœ°å€æ³„éœ²ï¼Œè¿™ä¸ªæ¼æ´æ›¾è¢«ç”¨äºå¯»æ‰¾æ¢…ä¸½èç—…æ¯’çš„åˆ¶ä½œè€…ä½ç½®ã€‚</li><li>IDä½œä¸ºä¸»é”®æ—¶åœ¨ç‰¹å®šçš„ç¯å¢ƒä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚åšDBä¸»é”®çš„åœºæ™¯ä¸‹ï¼ŒUUIDå°±éå¸¸ä¸é€‚ç”¨ï¼š <ol><li>MySQLå®˜æ–¹æœ‰æ˜ç¡®çš„å»ºè®®ä¸»é”®è¦å°½é‡è¶ŠçŸ­è¶Šå¥½[4]ï¼Œ36ä¸ªå­—ç¬¦é•¿åº¦çš„UUIDä¸ç¬¦åˆè¦æ±‚ã€‚</li><li>å¯¹MySQLç´¢å¼•ä¸åˆ©ï¼šå¦‚æœä½œä¸ºæ•°æ®åº“ä¸»é”®ï¼Œåœ¨InnoDBå¼•æ“ä¸‹ï¼ŒUUIDçš„æ— åºæ€§å¯èƒ½ä¼šå¼•èµ·æ•°æ®ä½ç½®é¢‘ç¹å˜åŠ¨ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚åœ¨MySQL InnoDBå¼•æ“ä¸­ä½¿ç”¨çš„æ˜¯èšé›†ç´¢å¼•ï¼Œç”±äºå¤šæ•°RDBMSä½¿ç”¨B-treeçš„æ•°æ®ç»“æ„æ¥å­˜å‚¨ç´¢å¼•æ•°æ®ï¼Œåœ¨ä¸»é”®çš„é€‰æ‹©ä¸Šé¢æˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨æœ‰åºçš„ä¸»é”®ä¿è¯å†™å…¥æ€§èƒ½ã€‚</li></ol></li></ol><h2 id="é›ªèŠ±ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#é›ªèŠ±ç®—æ³•" aria-hidden="true">#</a> <strong>é›ªèŠ±ç®—æ³•</strong></h2><p><img src="/images/springcloud/10299" alt="img"></p><ul><li>ç¬¬ 0 ä½ï¼š ç¬¦å·ä½ï¼ˆæ ‡è¯†æ­£è´Ÿï¼‰ï¼Œå§‹ç»ˆä¸º 0ï¼Œæ²¡æœ‰ç”¨ï¼Œä¸ç”¨ç®¡ã€‚</li><li>ç¬¬ 1~41 ä½ ï¼šä¸€å…± 41 ä½ï¼Œç”¨æ¥è¡¨ç¤ºæ—¶é—´æˆ³ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œå¯ä»¥æ”¯æ’‘ 2 ^41 æ¯«ç§’ï¼ˆçº¦ 69 å¹´ï¼‰</li><li>ç¬¬ 42~52 ä½ ï¼šä¸€å…± 10 ä½ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå‰ 5 ä½è¡¨ç¤ºæœºæˆ¿ IDï¼Œå 5 ä½è¡¨ç¤ºæœºå™¨ IDï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥åŒºåˆ†ä¸åŒé›†ç¾¤/æœºæˆ¿çš„èŠ‚ç‚¹ï¼Œè¿™æ ·å°±å¯ä»¥è¡¨ç¤º32ä¸ªIDCï¼Œæ¯ä¸ªIDCä¸‹å¯ä»¥æœ‰32å°æœºå™¨ã€‚</li><li>ç¬¬ 53~64 ä½ ï¼šä¸€å…± 12 ä½ï¼Œç”¨æ¥è¡¨ç¤ºåºåˆ—å·ã€‚ åºåˆ—å·ä¸ºè‡ªå¢å€¼ï¼Œä»£è¡¨å•å°æœºå™¨æ¯æ¯«ç§’èƒ½å¤Ÿäº§ç”Ÿçš„æœ€å¤§ ID æ•°(2^12 = 4096),ä¹Ÿå°±æ˜¯è¯´å•å°æœºå™¨æ¯æ¯«ç§’æœ€å¤šå¯ä»¥ç”Ÿæˆ 4096 ä¸ª å”¯ä¸€ IDã€‚</li></ul><p><a href="https://github.com/Q10Viking/springcloudalibaba/blob/main/unqid/unqid/src/main/java/org/hzz/SnowflakeIdWorker.java" target="_blank" rel="noopener noreferrer">Source Code<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>hzz</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * Twitter_Snowflake
 * SnowFlakeçš„ç»“æ„å¦‚ä¸‹(æ¯éƒ¨åˆ†ç”¨-åˆ†å¼€):
 * 0 - 0000000000 0000000000 0000000000 0000000000 0 - 00000 - 00000 - 000000000000
 * 1ä½æ ‡è¯†ï¼Œç”±äºlongåŸºæœ¬ç±»å‹åœ¨Javaä¸­æ˜¯å¸¦ç¬¦å·çš„ï¼Œæœ€é«˜ä½æ˜¯ç¬¦å·ä½ï¼Œæ­£æ•°æ˜¯0ï¼Œè´Ÿæ•°æ˜¯1ï¼Œæ‰€ä»¥idä¸€èˆ¬æ˜¯æ­£æ•°ï¼Œæœ€é«˜ä½æ˜¯0
 * 41ä½æ—¶é—´æˆ³(æ¯«ç§’çº§)ï¼Œæ³¨æ„ï¼Œ41ä½æ—¶é—´æˆ³ä¸æ˜¯å­˜å‚¨å½“å‰æ—¶é—´çš„æ—¶é—´æˆ³ï¼Œè€Œæ˜¯å­˜å‚¨æ—¶é—´æˆ³çš„å·®å€¼ï¼ˆå½“å‰æ—¶é—´æˆ³ - å¼€å§‹æ—¶é—´æˆ³)
 * å¾—åˆ°çš„å€¼ï¼‰ï¼Œè¿™é‡Œçš„çš„å¼€å§‹æ—¶é—´æˆ³ï¼Œä¸€èˆ¬æ˜¯æˆ‘ä»¬çš„idç”Ÿæˆå™¨å¼€å§‹ä½¿ç”¨çš„æ—¶é—´ï¼Œç”±æˆ‘ä»¬ç¨‹åºæ¥æŒ‡å®šçš„
 * ï¼ˆå¦‚ä¸‹é¢ç¨‹åºSnowflakeIdWorkerç±»çš„startTimeå±æ€§ï¼‰ã€‚
 * 41ä½çš„æ—¶é—´æˆ³ï¼Œå¯ä»¥ä½¿ç”¨69å¹´ï¼Œå¹´T = (1L &lt;&lt; 41) / (1000L * 60 * 60 * 24 * 365) = 69
 * 10ä½çš„æ•°æ®æœºå™¨ä½ï¼Œå¯ä»¥éƒ¨ç½²åœ¨1024ä¸ªèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬5ä½datacenterIdå’Œ5ä½workerId
 * 12ä½åºåˆ—ï¼Œæ¯«ç§’å†…çš„è®¡æ•°ï¼Œ12ä½çš„è®¡æ•°é¡ºåºå·æ”¯æŒæ¯ä¸ªèŠ‚ç‚¹æ¯æ¯«ç§’(åŒä¸€æœºå™¨ï¼ŒåŒä¸€æ—¶é—´æˆ³)äº§ç”Ÿ4096ä¸ªIDåºå·
 * åŠ èµ·æ¥åˆšå¥½64ä½ï¼Œä¸ºä¸€ä¸ªLongå‹ã€‚
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SnowflakeIdWorker</span> <span class="token punctuation">{</span>

    <span class="token doc-comment comment">/**
     * æ•°æ®æ ‡è¯†idæ‰€å çš„ä½æ•°
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> datacenterIdBits <span class="token operator">=</span> <span class="token number">5L</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æœºå™¨idæ‰€å çš„ä½æ•°
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> workerIdBits <span class="token operator">=</span> <span class="token number">5L</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * åºåˆ—åœ¨idä¸­å çš„ä½æ•°
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequenceBits <span class="token operator">=</span> <span class="token number">12L</span><span class="token punctuation">;</span>


    <span class="token doc-comment comment">/**
     * æ—¶é—´æˆ³å‘å·¦ç§»22ä½(5+5+12)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timestampLeftShift <span class="token operator">=</span> sequenceBits <span class="token operator">+</span> workerIdBits <span class="token operator">+</span> datacenterIdBits<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æœºå™¨IDå‘å·¦ç§»12ä½
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> workerIdShift <span class="token operator">=</span> sequenceBits<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ•°æ®æ ‡è¯†idå‘å·¦ç§»17ä½(12+5)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> datacenterIdShift <span class="token operator">=</span> sequenceBits <span class="token operator">+</span> workerIdBits<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ”¯æŒçš„æœ€å¤§æ•°æ®æ ‡è¯†idï¼Œç»“æœæ˜¯31
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxDatacenterId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> datacenterIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ”¯æŒçš„æœ€å¤§æœºå™¨idï¼Œç»“æœæ˜¯31 (è¿™ä¸ªç§»ä½ç®—æ³•å¯ä»¥å¾ˆå¿«çš„è®¡ç®—å‡ºå‡ ä½äºŒè¿›åˆ¶æ•°æ‰€èƒ½è¡¨ç¤ºçš„æœ€å¤§åè¿›åˆ¶æ•°)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxWorkerId <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> workerIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token doc-comment comment">/**
     * ç”Ÿæˆåºåˆ—çš„æ©ç ï¼Œè¿™é‡Œä¸º4095ï¼Œå¯¹åº”äºŒè¿›åˆ¶ 1111 1111 1111
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequenceMask <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span> <span class="token operator">&lt;&lt;</span> sequenceBits<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * å·¥ä½œæœºå™¨ID(0~31)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> workerId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ•°æ®ä¸­å¿ƒID(0~31)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> datacenterId<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ¯«ç§’å†…åºåˆ—(0~4095)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * ä¸Šæ¬¡ç”ŸæˆIDçš„æ—¶é—´æˆ³
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> lastTimestamp <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * æ„é€ å‡½æ•°
     *
     * <span class="token keyword">@param</span> <span class="token parameter">workerId</span>     å·¥ä½œID (0~31)
     * <span class="token keyword">@param</span> <span class="token parameter">datacenterId</span> æ•°æ®ä¸­å¿ƒID (0~31)
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">SnowflakeIdWorker</span><span class="token punctuation">(</span><span class="token keyword">long</span> workerId<span class="token punctuation">,</span> <span class="token keyword">long</span> datacenterId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workerId <span class="token operator">&gt;</span> maxWorkerId <span class="token operator">||</span> workerId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;worker Id can&#39;t be greater than %d or less than 0&quot;</span><span class="token punctuation">,</span> maxWorkerId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>datacenterId <span class="token operator">&gt;</span> maxDatacenterId <span class="token operator">||</span> datacenterId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;datacenter Id can&#39;t be greater than %d or less than 0&quot;</span><span class="token punctuation">,</span> maxDatacenterId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>workerId <span class="token operator">=</span> workerId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>datacenterId <span class="token operator">=</span> datacenterId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * è·å¾—ä¸‹ä¸€ä¸ªID (è¯¥æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„)
     *
     * <span class="token keyword">@return</span> SnowflakeId
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">long</span> <span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//å¦‚æœå½“å‰æ—¶é—´å°äºä¸Šä¸€æ¬¡IDç”Ÿæˆçš„æ—¶é—´æˆ³ï¼Œè¯´æ˜ç³»ç»Ÿæ—¶é’Ÿå›é€€è¿‡è¿™ä¸ªæ—¶å€™åº”å½“æŠ›å‡ºå¼‚å¸¸</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;Clock moved backwards.  Refusing to generate id for %d milliseconds&quot;</span><span class="token punctuation">,</span> lastTimestamp <span class="token operator">-</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//å¦‚æœæ˜¯åŒä¸€æ—¶é—´ç”Ÿæˆçš„ï¼Œåˆ™è¿›è¡Œæ¯«ç§’å†…åºåˆ—</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTimestamp <span class="token operator">==</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//å½“sequenceç´¯åŠ åˆ°4096ï¼Œä¹Ÿå°±æ˜¯0001000000000000æ—¶ï¼Œå’ŒsequenceMaskç›¸ä¸åsequence=0</span>
            sequence <span class="token operator">=</span> <span class="token punctuation">(</span>sequence <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> sequenceMask<span class="token punctuation">;</span>
            <span class="token comment">//æ¯«ç§’å†…åºåˆ—æº¢å‡º</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sequence <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//é˜»å¡åˆ°ä¸‹ä¸€ä¸ªæ¯«ç§’,è·å¾—æ–°çš„æ—¶é—´æˆ³</span>
                timestamp <span class="token operator">=</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span>lastTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//æ—¶é—´æˆ³æ”¹å˜ï¼Œæ¯«ç§’å†…åºåˆ—é‡ç½®</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            sequence <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//ä¸Šæ¬¡ç”ŸæˆIDçš„æ—¶é—´æˆ³</span>
        lastTimestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>


        <span class="token comment">//ç§»ä½å¹¶é€šè¿‡æˆ–è¿ç®—æ‹¼åˆ°ä¸€èµ·ç»„æˆ64ä½çš„ID</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;&lt;</span> timestampLeftShift<span class="token punctuation">)</span>       <span class="token comment">// æ—¶é—´æˆ³å·¦ç§»22ä½</span>
                <span class="token operator">|</span> <span class="token punctuation">(</span>datacenterId <span class="token operator">&lt;&lt;</span> datacenterIdShift<span class="token punctuation">)</span>  <span class="token comment">//æ•°æ®æ ‡è¯†å·¦ç§»17ä½</span>
                <span class="token operator">|</span> <span class="token punctuation">(</span>workerId <span class="token operator">&lt;&lt;</span> workerIdShift<span class="token punctuation">)</span>          <span class="token comment">//æœºå™¨idæ ‡è¯†å·¦ç§»12ä½</span>
                <span class="token operator">|</span> sequence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * é˜»å¡åˆ°ä¸‹ä¸€ä¸ªæ¯«ç§’ï¼Œç›´åˆ°è·å¾—æ–°çš„æ—¶é—´æˆ³
     *
     * <span class="token keyword">@param</span> <span class="token parameter">lastTimestamp</span> ä¸Šæ¬¡ç”ŸæˆIDçš„æ—¶é—´æˆ³
     * <span class="token keyword">@return</span> å½“å‰æ—¶é—´æˆ³
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">tilNextMillis</span><span class="token punctuation">(</span><span class="token keyword">long</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;=</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> timestamp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SnowflakeIdWorker</span> snowflakeIdWorker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SnowflakeIdWorker</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> id <span class="token operator">=</span> snowflakeIdWorker<span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * 7043602170993840128
 * 7043602170998034432
 * 7043602170998034433
 * 7043602170998034434
 * 7043602170998034435
 */</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br></div></div><h3 id="æ—¶é—´æˆ³ä½æ•°41ä½" tabindex="-1"><a class="header-anchor" href="#æ—¶é—´æˆ³ä½æ•°41ä½" aria-hidden="true">#</a> æ—¶é—´æˆ³ä½æ•°41ä½</h3><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimestampDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> timeMillis <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> bit <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toBinaryString</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bit<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * 11000011011111111100101011110100011100000
 * 41
 */</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="ä¼˜ç‚¹-1" tabindex="-1"><a class="header-anchor" href="#ä¼˜ç‚¹-1" aria-hidden="true">#</a> ä¼˜ç‚¹</h3><ul><li><p>æ¯«ç§’æ•°åœ¨é«˜ä½ï¼Œè‡ªå¢åºåˆ—åœ¨ä½ä½ï¼Œæ•´ä¸ªIDéƒ½æ˜¯è¶‹åŠ¿é€’å¢çš„ã€‚</p></li><li><p>ä¸ä¾èµ–æ•°æ®åº“ç­‰ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼Œä»¥æœåŠ¡çš„æ–¹å¼éƒ¨ç½²ï¼Œç¨³å®šæ€§æ›´é«˜ï¼Œç”ŸæˆIDçš„æ€§èƒ½ä¹Ÿæ˜¯éå¸¸é«˜çš„ã€‚</p></li><li><p>å¯ä»¥æ ¹æ®è‡ªèº«ä¸šåŠ¡ç‰¹æ€§åˆ†é…bitä½ï¼Œéå¸¸çµæ´»ã€‚</p></li></ul><h3 id="ç¼ºç‚¹-1" tabindex="-1"><a class="header-anchor" href="#ç¼ºç‚¹-1" aria-hidden="true">#</a> ç¼ºç‚¹</h3><p>å¼ºä¾èµ–æœºå™¨æ—¶é’Ÿï¼Œå¦‚æœæœºå™¨ä¸Šæ—¶é’Ÿå›æ‹¨ï¼Œä¼šå¯¼è‡´å‘å·é‡å¤æˆ–è€…æœåŠ¡ä¼šå¤„äºä¸å¯ç”¨çŠ¶æ€</p><h2 id="mysql" tabindex="-1"><a class="header-anchor" href="#mysql" aria-hidden="true">#</a> MySQL</h2><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>sequence_id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>stub<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>stub<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>stub<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>stub å­—æ®µæ— æ„ä¹‰ï¼Œåªæ˜¯ä¸ºäº†å ä½ï¼Œä¾¿äºæˆ‘ä»¬æ’å…¥æˆ–è€…ä¿®æ”¹æ•°æ®ã€‚å¹¶ä¸”ï¼Œç»™ stub å­—æ®µåˆ›å»ºäº†å”¯ä¸€ç´¢å¼•ï¼Œä¿è¯å…¶å”¯ä¸€æ€§ã€‚</p><blockquote><p>é€šè¿‡ replace into æ¥æ’å…¥æ•°æ®</p></blockquote><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">REPLACE</span> <span class="token keyword">INTO</span> sequence_id <span class="token punctuation">(</span>stub<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;stub&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> LAST_INSERT_ID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>æ’å…¥æ•°æ®è¿™é‡Œï¼Œæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ insert into è€Œæ˜¯ä½¿ç”¨ replace into æ¥æ’å…¥æ•°æ®ã€‚replaceæ˜¯insertçš„å¢å¼ºç‰ˆï¼Œreplace into é¦–å…ˆå°è¯•æ’å…¥æ•°æ®åˆ°è¡¨ä¸­ï¼Œ1. å¦‚æœå‘ç°è¡¨ä¸­å·²ç»æœ‰æ­¤è¡Œæ•°æ®ï¼ˆæ ¹æ®ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•åˆ¤æ–­ï¼‰åˆ™å…ˆåˆ é™¤æ­¤è¡Œæ•°æ®ï¼Œç„¶åæ’å…¥æ–°çš„æ•°æ®ã€‚ 2. å¦åˆ™ï¼Œç›´æ¥æ’å…¥æ–°æ•°æ®ã€‚</p><h3 id="ä¼˜ç‚¹-2" tabindex="-1"><a class="header-anchor" href="#ä¼˜ç‚¹-2" aria-hidden="true">#</a> ä¼˜ç‚¹</h3><p>éå¸¸ç®€å•ï¼Œåˆ©ç”¨ç°æœ‰æ•°æ®åº“ç³»ç»Ÿçš„åŠŸèƒ½å®ç°ï¼Œæˆæœ¬å°ï¼Œæœ‰DBAä¸“ä¸šç»´æŠ¤ã€‚IDå·å•è°ƒè‡ªå¢ï¼Œå­˜å‚¨æ¶ˆè€—ç©ºé—´å°</p><h3 id="ç¼ºç‚¹-2" tabindex="-1"><a class="header-anchor" href="#ç¼ºç‚¹-2" aria-hidden="true">#</a> ç¼ºç‚¹</h3><p>æ”¯æŒçš„å¹¶å‘é‡ä¸å¤§ã€å­˜åœ¨æ•°æ®åº“å•ç‚¹é—®é¢˜ï¼ˆå¯ä»¥ä½¿ç”¨æ•°æ®åº“é›†ç¾¤è§£å†³ï¼Œä¸è¿‡å¢åŠ äº†å¤æ‚åº¦ï¼‰ã€ID æ²¡æœ‰å…·ä½“ä¸šåŠ¡å«ä¹‰ã€å®‰å…¨é—®é¢˜ï¼ˆæ¯”å¦‚æ ¹æ®è®¢å• ID çš„é€’å¢è§„å¾‹å°±èƒ½æ¨ç®—å‡ºæ¯å¤©çš„è®¢å•é‡ ï¼‰ã€æ¯æ¬¡è·å– ID éƒ½è¦è®¿é—®ä¸€æ¬¡æ•°æ®åº“ï¼ˆå¢åŠ äº†å¯¹æ•°æ®åº“çš„å‹åŠ›ï¼Œè·å–é€Ÿåº¦ä¹Ÿæ…¢ï¼‰</p><h3 id="ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–" aria-hidden="true">#</a> ä¼˜åŒ–</h3><p>å¯¹äºMySQLæ€§èƒ½é—®é¢˜ï¼Œå¯ç”¨å¦‚ä¸‹æ–¹æ¡ˆè§£å†³ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æˆ‘ä»¬å¯ä»¥å¤šéƒ¨ç½²å‡ å°æœºå™¨ï¼Œæ¯å°æœºå™¨è®¾ç½®ä¸åŒçš„åˆå§‹å€¼ï¼Œä¸”æ­¥é•¿å’Œæœºå™¨æ•°ç›¸ç­‰ã€‚æ¯”å¦‚æœ‰ä¸¤å°æœºå™¨ã€‚è®¾ç½®æ­¥é•¿stepä¸º2ï¼ŒTicketServer1çš„åˆå§‹å€¼ä¸º1ï¼ˆ1ï¼Œ3ï¼Œ5ï¼Œ7ï¼Œ9ï¼Œ11â€¦ï¼‰ã€TicketServer2çš„åˆå§‹å€¼ä¸º2ï¼ˆ2ï¼Œ4ï¼Œ6ï¼Œ8ï¼Œ10â€¦ï¼‰</p><p>å‡è®¾æˆ‘ä»¬è¦éƒ¨ç½²Nå°æœºå™¨ï¼Œæ­¥é•¿éœ€è®¾ç½®ä¸ºNï¼Œæ¯å°çš„åˆå§‹å€¼ä¾æ¬¡ä¸º0,1,2â€¦N-1</p><p><img src="/images/springcloud/6d2c9ec8.png" alt="img"></p><p>è¿™ç§æ¶æ„è²Œä¼¼èƒ½å¤Ÿæ»¡è¶³æ€§èƒ½çš„éœ€æ±‚ï¼Œä½†æœ‰ä»¥ä¸‹å‡ ä¸ªç¼ºç‚¹ï¼š</p><p>ç³»ç»Ÿæ°´å¹³æ‰©å±•æ¯”è¾ƒå›°éš¾ï¼Œæ¯”å¦‚å®šä¹‰å¥½äº†æ­¥é•¿å’Œæœºå™¨å°æ•°ä¹‹åï¼Œå¦‚æœè¦æ·»åŠ æœºå™¨è¯¥æ€ä¹ˆåšï¼Ÿå‡è®¾ç°åœ¨åªæœ‰ä¸€å°æœºå™¨å‘å·æ˜¯1,2,3,4,5ï¼ˆæ­¥é•¿æ˜¯1ï¼‰ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æ‰©å®¹æœºå™¨ä¸€å°ã€‚å¯ä»¥è¿™æ ·åšï¼šæŠŠç¬¬äºŒå°æœºå™¨çš„åˆå§‹å€¼è®¾ç½®å¾—æ¯”ç¬¬ä¸€å°è¶…è¿‡å¾ˆå¤šï¼Œæ¯”å¦‚140ï¼ˆå‡è®¾åœ¨æ‰©å®¹æ—¶é—´ä¹‹å†…ç¬¬ä¸€å°ä¸å¯èƒ½å‘åˆ°140ï¼‰ï¼ŒåŒæ—¶è®¾ç½®æ­¥é•¿ä¸º2ï¼Œé‚£ä¹ˆè¿™å°æœºå™¨ä¸‹å‘çš„å·ç éƒ½æ˜¯140ä»¥åçš„å¶æ•°ã€‚ç„¶åæ‘˜æ‰ç¬¬ä¸€å°ï¼ŒæŠŠIDå€¼ä¿ç•™ä¸ºå¥‡æ•°ï¼Œæ¯”å¦‚7ï¼Œç„¶åä¿®æ”¹ç¬¬ä¸€å°çš„æ­¥é•¿ä¸º2ã€‚è®©å®ƒç¬¦åˆæˆ‘ä»¬å®šä¹‰çš„å·æ®µæ ‡å‡†ï¼Œå¯¹äºè¿™ä¸ªä¾‹å­æ¥è¯´å°±æ˜¯è®©ç¬¬ä¸€å°ä»¥ååªèƒ½äº§ç”Ÿå¥‡æ•°ã€‚æ‰©å®¹æ–¹æ¡ˆçœ‹èµ·æ¥å¤æ‚å—ï¼Ÿè²Œä¼¼è¿˜å¥½ï¼Œç°åœ¨æƒ³è±¡ä¸€ä¸‹å¦‚æœæˆ‘ä»¬çº¿ä¸Šæœ‰100å°æœºå™¨ï¼Œè¿™ä¸ªæ—¶å€™è¦æ‰©å®¹è¯¥æ€ä¹ˆåšï¼Ÿç®€ç›´æ˜¯å™©æ¢¦ã€‚æ‰€ä»¥ç³»ç»Ÿæ°´å¹³æ‰©å±•æ–¹æ¡ˆå¤æ‚éš¾ä»¥å®ç°ã€‚</p><p>IDæ²¡æœ‰äº†å•è°ƒé€’å¢çš„ç‰¹æ€§ï¼Œåªèƒ½è¶‹åŠ¿é€’å¢ï¼Œè¿™ä¸ªç¼ºç‚¹å¯¹äºä¸€èˆ¬ä¸šåŠ¡éœ€æ±‚ä¸æ˜¯å¾ˆé‡è¦ï¼Œå¯ä»¥å®¹å¿ã€‚</p><p>æ•°æ®åº“å‹åŠ›è¿˜æ˜¯å¾ˆå¤§ï¼Œæ¯æ¬¡è·å–IDéƒ½å¾—è¯»å†™ä¸€æ¬¡æ•°æ®åº“ï¼Œåªèƒ½é å †æœºå™¨æ¥æé«˜æ€§èƒ½ã€‚</p><h2 id="redis" tabindex="-1"><a class="header-anchor" href="#redis" aria-hidden="true">#</a> Redis</h2><p>é€šè¿‡ Redis çš„ incr å‘½ä»¤å³å¯å®ç°å¯¹ id åŸå­é¡ºåºé€’å¢ï¼Œä¾‹å¦‚ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> incr sequence_id_biz_type

<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>ä¸ºäº†æé«˜å¯ç”¨æ€§å’Œå¹¶å‘ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Redis Clusterã€‚</p><p>é™¤äº†é«˜å¯ç”¨å’Œå¹¶å‘ä¹‹å¤–ï¼Œæˆ‘ä»¬çŸ¥é“ Redis åŸºäºå†…å­˜ï¼Œæˆ‘ä»¬éœ€è¦æŒä¹…åŒ–æ•°æ®ï¼Œé¿å…é‡å¯æœºå™¨æˆ–è€…æœºå™¨æ•…éšœåæ•°æ®ä¸¢å¤±ã€‚å¾ˆæ˜æ˜¾ï¼ŒRedisæ–¹æ¡ˆæ€§èƒ½å¾ˆå¥½å¹¶ä¸”ç”Ÿæˆçš„ ID æ˜¯æœ‰åºé€’å¢çš„ã€‚</p><p>ä¸è¿‡ï¼Œæˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œå³ä½¿Redis å¼€å¯äº†æŒä¹…åŒ–ï¼Œä¸ç®¡æ˜¯å¿«ç…§ï¼ˆsnapshottingï¼ŒRDBï¼‰ã€åªè¿½åŠ æ–‡ä»¶ï¼ˆappend-only file, AOFï¼‰è¿˜æ˜¯ RDB å’Œ AOF çš„æ··åˆæŒä¹…åŒ–ä¾ç„¶å­˜åœ¨ç€ä¸¢å¤±æ•°æ®çš„å¯èƒ½ï¼Œé‚£å°±æ„å‘³ç€äº§ç”Ÿçš„IDå­˜åœ¨ç€é‡å¤çš„æ¦‚ç‡ã€‚</p><h2 id="ç¾å›¢leaf" tabindex="-1"><a class="header-anchor" href="#ç¾å›¢leaf" aria-hidden="true">#</a> ç¾å›¢Leaf</h2><h3 id="leaf-segmentæ•°æ®åº“æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#leaf-segmentæ•°æ®åº“æ–¹æ¡ˆ" aria-hidden="true">#</a> <strong>Leaf-segmentæ•°æ®åº“æ–¹æ¡ˆ</strong></h3><p>åŸMySQLæ–¹æ¡ˆæ¯æ¬¡è·å–IDéƒ½å¾—è¯»å†™ä¸€æ¬¡æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“å‹åŠ›å¤§ã€‚æ”¹ä¸ºæ‰¹é‡è·å–ï¼Œæ¯æ¬¡è·å–ä¸€ä¸ªsegment(stepå†³å®šå¤§å°)å·æ®µçš„å€¼ã€‚ç”¨å®Œä¹‹åå†å»æ•°æ®åº“è·å–æ–°çš„å·æ®µï¼Œå¯ä»¥å¤§å¤§çš„å‡è½»æ•°æ®åº“çš„å‹åŠ›ã€‚</p><p>å„ä¸ªä¸šåŠ¡ä¸åŒçš„å‘å·éœ€æ±‚ç”¨biz_tagå­—æ®µæ¥åŒºåˆ†ï¼Œæ¯ä¸ªbiz-tagçš„IDè·å–ç›¸äº’éš”ç¦»ï¼Œäº’ä¸å½±å“ã€‚å¦‚æœä»¥åæœ‰æ€§èƒ½éœ€æ±‚éœ€è¦å¯¹æ•°æ®åº“æ‰©å®¹ï¼Œä¸éœ€è¦ä¸Šè¿°æè¿°çš„å¤æ‚çš„æ‰©å®¹æ“ä½œï¼Œåªéœ€è¦å¯¹biz_tagåˆ†åº“åˆ†è¡¨å°±è¡Œã€‚</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>leaf_alloc<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>biz_tag<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>max_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">&#39;1&#39;</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>step<span class="token punctuation">`</span></span> <span class="token keyword">int</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>description<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_0900_ai_ci <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>biz_tag<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COLLATE</span><span class="token operator">=</span>utf8mb4_0900_ai_ci ROW_FORMAT<span class="token operator">=</span>DYNAMIC<span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><img src="/images/springcloud/10300" alt="img"></p><ul><li>biz_tagç”¨æ¥åŒºåˆ†ä¸šåŠ¡</li><li>max_idè¡¨ç¤ºè¯¥biz_tagç›®å‰æ‰€è¢«åˆ†é…çš„IDå·æ®µçš„æœ€å¤§å€¼</li><li>stepè¡¨ç¤ºæ¯æ¬¡åˆ†é…çš„å·æ®µé•¿åº¦</li></ul><p>åŸæ¥è·å–IDæ¯æ¬¡éƒ½éœ€è¦å†™æ•°æ®åº“ï¼Œç°åœ¨åªéœ€è¦æŠŠstepè®¾ç½®å¾—è¶³å¤Ÿå¤§ï¼Œæ¯”å¦‚1000ã€‚é‚£ä¹ˆåªæœ‰å½“1000ä¸ªå·è¢«æ¶ˆè€—å®Œäº†ä¹‹åæ‰ä¼šå»é‡æ–°è¯»å†™ä¸€æ¬¡æ•°æ®åº“ã€‚è¯»å†™æ•°æ®åº“çš„é¢‘ç‡ä»1å‡å°åˆ°äº†1/stepã€‚</p><p>ä¾‹å¦‚ç°åœ¨æœ‰3å°æœºå™¨ï¼Œæ¯å°æœºå™¨å„å–1000ä¸ªï¼Œå¾ˆæ˜æ˜¾åœ¨ç¬¬ä¸€å°Leafæœºå™¨ä¸Šæ˜¯1~1000çš„å·æ®µï¼Œå½“è¿™ä¸ªå·æ®µç”¨å®Œæ—¶ï¼Œä¼šå»åŠ è½½å¦ä¸€ä¸ªé•¿åº¦ä¸ºstep=1000çš„å·æ®µï¼Œå‡è®¾å¦å¤–ä¸¤å°å·æ®µéƒ½æ²¡æœ‰æ›´æ–°ï¼Œè¿™ä¸ªæ—¶å€™ç¬¬ä¸€å°æœºå™¨æ–°åŠ è½½çš„å·æ®µå°±åº”è¯¥æ˜¯3001~4000ã€‚åŒæ—¶æ•°æ®åº“å¯¹åº”çš„biz_tagè¿™æ¡æ•°æ®çš„max_idä¼šä»3000è¢«æ›´æ–°æˆ4000ï¼Œæ›´æ–°å·æ®µçš„SQLè¯­å¥å¦‚ä¸‹ï¼š</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">Begin</span>
<span class="token keyword">UPDATE</span> <span class="token keyword">table</span> <span class="token keyword">SET</span> max_id<span class="token operator">=</span>max_id<span class="token operator">+</span>step <span class="token keyword">WHERE</span> biz_tag<span class="token operator">=</span>xxx
<span class="token keyword">SELECT</span> biz_tag<span class="token punctuation">,</span> max_id<span class="token punctuation">,</span> step <span class="token keyword">FROM</span> <span class="token keyword">table</span> <span class="token keyword">WHERE</span> biz_tag<span class="token operator">=</span>xxx
<span class="token keyword">Commit</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="/images/springcloud/image-20230321110636060.png" alt="image-20230321110636060"></p><p><img src="/images/springcloud/5e4ff128.png" alt="img"></p><h4 id="ä¼˜ç‚¹-3" tabindex="-1"><a class="header-anchor" href="#ä¼˜ç‚¹-3" aria-hidden="true">#</a> ä¼˜ç‚¹</h4><ul><li>LeafæœåŠ¡å¯ä»¥å¾ˆæ–¹ä¾¿çš„çº¿æ€§æ‰©å±•ï¼Œæ€§èƒ½å®Œå…¨èƒ½å¤Ÿæ”¯æ’‘å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ã€‚</li><li>IDå·ç æ˜¯è¶‹åŠ¿é€’å¢çš„8byteçš„64ä½æ•°å­—ï¼Œæ»¡è¶³ä¸Šè¿°æ•°æ®åº“å­˜å‚¨çš„ä¸»é”®è¦æ±‚ã€‚</li><li>å®¹ç¾æ€§é«˜ï¼šLeafæœåŠ¡å†…éƒ¨æœ‰å·æ®µç¼“å­˜ï¼Œå³ä½¿DBå®•æœºï¼ŒçŸ­æ—¶é—´å†…Leafä»èƒ½æ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ã€‚</li><li>å¯ä»¥è‡ªå®šä¹‰max_idçš„å¤§å°ï¼Œéå¸¸æ–¹ä¾¿ä¸šåŠ¡ä»åŸæœ‰çš„IDæ–¹å¼ä¸Šè¿ç§»è¿‡æ¥ã€‚</li></ul><h4 id="ç¼ºç‚¹-3" tabindex="-1"><a class="header-anchor" href="#ç¼ºç‚¹-3" aria-hidden="true">#</a> ç¼ºç‚¹</h4><ul><li>IDå·ç ä¸å¤Ÿéšæœºï¼Œèƒ½å¤Ÿæ³„éœ²å‘å·æ•°é‡çš„ä¿¡æ¯ï¼Œä¸å¤ªå®‰å…¨ã€‚</li><li>TP999æ•°æ®æ³¢åŠ¨å¤§ï¼Œå½“å·æ®µä½¿ç”¨å®Œä¹‹åè¿˜æ˜¯ä¼šhangåœ¨æ›´æ–°æ•°æ®åº“çš„I/Oä¸Šï¼Œtg999æ•°æ®ä¼šå‡ºç°å¶å°”çš„å°–åˆºã€‚</li><li>DBå®•æœºä¼šé€ æˆæ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ã€‚</li></ul><h4 id="åŒbufferä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#åŒbufferä¼˜åŒ–" aria-hidden="true">#</a> <strong>åŒbufferä¼˜åŒ–</strong></h4><p>å¯¹äºç¬¬äºŒä¸ªç¼ºç‚¹ï¼ŒLeaf-segmentåšäº†ä¸€äº›ä¼˜åŒ–ï¼Œç®€å•çš„è¯´å°±æ˜¯ï¼š</p><p>Leaf å–å·æ®µçš„æ—¶æœºæ˜¯åœ¨å·æ®µæ¶ˆè€—å®Œçš„æ—¶å€™è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ„å‘³ç€å·æ®µä¸´ç•Œç‚¹çš„IDä¸‹å‘æ—¶é—´å–å†³äºä¸‹ä¸€æ¬¡ä»DBå–å›å·æ®µçš„æ—¶é—´ï¼Œå¹¶ä¸”åœ¨è¿™æœŸé—´è¿›æ¥çš„è¯·æ±‚ä¹Ÿä¼šå› ä¸ºDBå·æ®µæ²¡æœ‰å–å›æ¥ï¼Œå¯¼è‡´çº¿ç¨‹é˜»å¡ã€‚å¦‚æœè¯·æ±‚DBçš„ç½‘ç»œå’ŒDBçš„æ€§èƒ½ç¨³å®šï¼Œè¿™ç§æƒ…å†µå¯¹ç³»ç»Ÿçš„å½±å“æ˜¯ä¸å¤§çš„ï¼Œä½†æ˜¯å‡å¦‚å–DBçš„æ—¶å€™ç½‘ç»œå‘ç”ŸæŠ–åŠ¨ï¼Œæˆ–è€…DBå‘ç”Ÿæ…¢æŸ¥è¯¢å°±ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„å“åº”æ—¶é—´å˜æ…¢ã€‚</p><p>ä¸ºæ­¤ï¼Œå¸Œæœ›DBå–å·æ®µçš„è¿‡ç¨‹èƒ½å¤Ÿåšåˆ°æ— é˜»å¡ï¼Œä¸éœ€è¦åœ¨DBå–å·æ®µçš„æ—¶å€™é˜»å¡è¯·æ±‚çº¿ç¨‹ï¼Œå³å½“å·æ®µæ¶ˆè´¹åˆ°æŸä¸ªç‚¹æ—¶å°±å¼‚æ­¥çš„æŠŠä¸‹ä¸€ä¸ªå·æ®µåŠ è½½åˆ°å†…å­˜ä¸­ã€‚è€Œä¸éœ€è¦ç­‰åˆ°å·æ®µç”¨å°½çš„æ—¶å€™æ‰å»æ›´æ–°å·æ®µã€‚è¿™æ ·åšå°±å¯ä»¥å¾ˆå¤§ç¨‹åº¦ä¸Šçš„é™ä½ç³»ç»Ÿçš„TP999æŒ‡æ ‡ã€‚</p><p>é‡‡ç”¨åŒbufferçš„æ–¹å¼ï¼ŒLeafæœåŠ¡å†…éƒ¨æœ‰ä¸¤ä¸ªå·æ®µç¼“å­˜åŒºsegmentã€‚å½“å‰å·æ®µå·²ä¸‹å‘10%æ—¶ï¼Œå¦‚æœä¸‹ä¸€ä¸ªå·æ®µæœªæ›´æ–°ï¼Œåˆ™å¦å¯ä¸€ä¸ªæ›´æ–°çº¿ç¨‹å»æ›´æ–°ä¸‹ä¸€ä¸ªå·æ®µã€‚å½“å‰å·æ®µå…¨éƒ¨ä¸‹å‘å®Œåï¼Œå¦‚æœä¸‹ä¸ªå·æ®µå‡†å¤‡å¥½äº†åˆ™åˆ‡æ¢åˆ°ä¸‹ä¸ªå·æ®µä¸ºå½“å‰segmentæ¥ç€ä¸‹å‘ï¼Œå¾ªç¯å¾€å¤ã€‚</p><p>é€šå¸¸æ¨èsegmenté•¿åº¦è®¾ç½®ä¸ºæœåŠ¡é«˜å³°æœŸå‘å·QPSçš„600å€ï¼ˆ10åˆ†é’Ÿï¼‰ï¼Œè¿™æ ·å³ä½¿DBå®•æœºï¼ŒLeafä»èƒ½æŒç»­å‘å·10-20åˆ†é’Ÿä¸å—å½±å“ã€‚</p><p>æ¯æ¬¡è¯·æ±‚æ¥ä¸´æ—¶éƒ½ä¼šåˆ¤æ–­ä¸‹ä¸ªå·æ®µçš„çŠ¶æ€ï¼Œä»è€Œæ›´æ–°æ­¤å·æ®µï¼Œæ‰€ä»¥å¶å°”çš„ç½‘ç»œæŠ–åŠ¨ä¸ä¼šå½±å“ä¸‹ä¸ªå·æ®µçš„æ›´æ–°ã€‚</p><h4 id="leafé«˜å¯ç”¨æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#leafé«˜å¯ç”¨æ–¹æ¡ˆ" aria-hidden="true">#</a> Leafé«˜å¯ç”¨æ–¹æ¡ˆ</h4><p>å¯¹äºç¬¬ä¸‰ç‚¹â€œDBå¯ç”¨æ€§â€é—®é¢˜ï¼Œå¯ä»¥é‡‡ç”¨ä¸€ä¸»ä¸¤ä»çš„æ–¹å¼ï¼ŒåŒæ—¶åˆ†æœºæˆ¿éƒ¨ç½²ï¼ŒMasterå’ŒSlaveä¹‹é—´é‡‡ç”¨åŠåŒæ­¥æ–¹å¼åŒæ­¥æ•°æ®ã€‚ç¾å›¢å†…éƒ¨ä½¿ç”¨äº†å¥‡è™360çš„Atlasæ•°æ®åº“ä¸­é—´ä»¶ï¼ˆå·²å¼€æºï¼Œæ”¹åä¸ºDBProxyï¼‰åšä¸»ä»åˆ‡æ¢ã€‚å½“ç„¶è¿™ç§æ–¹æ¡ˆåœ¨ä¸€äº›æƒ…å†µä¼šé€€åŒ–æˆå¼‚æ­¥æ¨¡å¼ï¼Œç”šè‡³åœ¨éå¸¸æç«¯æƒ…å†µä¸‹ä»ç„¶ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä½†æ˜¯å‡ºç°çš„æ¦‚ç‡éå¸¸å°ã€‚å¦‚æœè¦ä¿è¯100%çš„æ•°æ®å¼ºä¸€è‡´ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨â€œç±»Paxosç®—æ³•â€å®ç°çš„å¼ºä¸€è‡´MySQLæ–¹æ¡ˆï¼Œå¦‚MySQL 5.7ä¸­çš„MySQL Group Replicationã€‚ä½†æ˜¯è¿ç»´æˆæœ¬å’Œç²¾åŠ›éƒ½ä¼šç›¸åº”çš„å¢åŠ ï¼Œæ ¹æ®å®é™…æƒ…å†µé€‰å‹å³å¯ã€‚</p><h3 id="leaf-snowflakeæ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#leaf-snowflakeæ–¹æ¡ˆ" aria-hidden="true">#</a> <strong>Leaf-snowflakeæ–¹æ¡ˆ</strong></h3><p>Leaf-segmentæ–¹æ¡ˆå¯ä»¥ç”Ÿæˆè¶‹åŠ¿é€’å¢çš„IDï¼ŒåŒæ—¶IDå·æ˜¯å¯è®¡ç®—çš„ï¼Œä¸é€‚ç”¨äºè®¢å•IDç”Ÿæˆåœºæ™¯ï¼Œæ¯”å¦‚ç«å¯¹åœ¨ä¸¤å¤©ä¸­åˆ12ç‚¹åˆ†åˆ«ä¸‹å•ï¼Œé€šè¿‡è®¢å•idå·ç›¸å‡å°±èƒ½å¤§è‡´è®¡ç®—å‡ºå…¬å¸ä¸€å¤©çš„è®¢å•é‡ï¼Œè¿™ä¸ªæ˜¯ä¸èƒ½å¿å—çš„ã€‚é¢å¯¹è¿™ä¸€é—®é¢˜ï¼Œç¾å›¢æä¾›äº† Leaf-snowflakeæ–¹æ¡ˆã€‚</p><p>Leaf-snowflakeæ–¹æ¡ˆå®Œå…¨æ²¿ç”¨snowflakeæ–¹æ¡ˆçš„bitä½è®¾è®¡ï¼Œå³æ˜¯â€œ1+41+10+12â€çš„æ–¹å¼ç»„è£…IDå·ã€‚å¯¹äºworkerIDçš„åˆ†é…ï¼Œå½“æœåŠ¡é›†ç¾¤æ•°é‡è¾ƒå°çš„æƒ…å†µä¸‹ï¼Œå®Œå…¨å¯ä»¥æ‰‹åŠ¨é…ç½®ã€‚LeafæœåŠ¡è§„æ¨¡è¾ƒå¤§ï¼ŒåŠ¨æ‰‹é…ç½®æˆæœ¬å¤ªé«˜ã€‚æ‰€ä»¥ä½¿ç”¨ZookeeperæŒä¹…é¡ºåºèŠ‚ç‚¹çš„ç‰¹æ€§è‡ªåŠ¨å¯¹snowflakeèŠ‚ç‚¹é…ç½®wokerIDã€‚Leaf-snowflakeæ˜¯æŒ‰ç…§ä¸‹é¢å‡ ä¸ªæ­¥éª¤å¯åŠ¨çš„ï¼š</p><p>å¯åŠ¨Leaf-snowflakeæœåŠ¡ï¼Œè¿æ¥Zookeeperï¼Œåœ¨leaf_foreverçˆ¶èŠ‚ç‚¹ä¸‹æ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»æ³¨å†Œè¿‡ï¼ˆæ˜¯å¦æœ‰è¯¥é¡ºåºå­èŠ‚ç‚¹ï¼‰ã€‚</p><p>å¦‚æœæœ‰æ³¨å†Œè¿‡ç›´æ¥å–å›è‡ªå·±çš„workerIDï¼ˆzké¡ºåºèŠ‚ç‚¹ç”Ÿæˆçš„intç±»å‹IDå·ï¼‰ï¼Œå¯åŠ¨æœåŠ¡ã€‚</p><p>å¦‚æœæ²¡æœ‰æ³¨å†Œè¿‡ï¼Œå°±åœ¨è¯¥çˆ¶èŠ‚ç‚¹ä¸‹é¢åˆ›å»ºä¸€ä¸ªæŒä¹…é¡ºåºèŠ‚ç‚¹ï¼Œåˆ›å»ºæˆåŠŸåå–å›é¡ºåºå·å½“åšè‡ªå·±çš„workerIDå·ï¼Œå¯åŠ¨æœåŠ¡ã€‚</p><h4 id="å¼±ä¾èµ–zookeeper" tabindex="-1"><a class="header-anchor" href="#å¼±ä¾èµ–zookeeper" aria-hidden="true">#</a> <strong>å¼±ä¾èµ–ZooKeeper</strong></h4><p>é™¤äº†æ¯æ¬¡ä¼šå»ZKæ‹¿æ•°æ®ä»¥å¤–ï¼Œä¹Ÿä¼šåœ¨æœ¬æœºæ–‡ä»¶ç³»ç»Ÿä¸Šç¼“å­˜ä¸€ä¸ªworkerIDæ–‡ä»¶ã€‚å½“ZooKeeperå‡ºç°é—®é¢˜ï¼Œæ°å¥½æœºå™¨å‡ºç°é—®é¢˜éœ€è¦é‡å¯æ—¶ï¼Œèƒ½ä¿è¯æœåŠ¡èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ã€‚è¿™æ ·åšåˆ°äº†å¯¹ä¸‰æ–¹ç»„ä»¶çš„å¼±ä¾èµ–ã€‚</p><p>[åŸºäºzookeeperå®ç°é›ªèŠ±ç®—æ³•](https://q10viking.github.io/zk/14 zkå®ç°ç»Ÿä¸€å‘½åæœåŠ¡.html)</p><h4 id="è§£å†³æ—¶é’Ÿé—®é¢˜" tabindex="-1"><a class="header-anchor" href="#è§£å†³æ—¶é’Ÿé—®é¢˜" aria-hidden="true">#</a> <strong>è§£å†³æ—¶é’Ÿé—®é¢˜</strong></h4><p>å› ä¸ºè¿™ç§æ–¹æ¡ˆä¾èµ–æ—¶é—´ï¼Œå¦‚æœæœºå™¨çš„æ—¶é’Ÿå‘ç”Ÿäº†å›æ‹¨ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å¯èƒ½ç”Ÿæˆé‡å¤çš„IDå·ï¼Œéœ€è¦è§£å†³æ—¶é’Ÿå›é€€çš„é—®é¢˜ã€‚</p><p>é¦–å…ˆåœ¨å¯åŠ¨æ—¶ï¼ŒæœåŠ¡ä¼šè¿›è¡Œæ£€æŸ¥ï¼š</p><p>1ã€æ–°èŠ‚ç‚¹é€šè¿‡æ£€æŸ¥ç»¼åˆå¯¹æ¯”å…¶ä½™LeafèŠ‚ç‚¹çš„ç³»ç»Ÿæ—¶é—´æ¥åˆ¤æ–­è‡ªèº«ç³»ç»Ÿæ—¶é—´æ˜¯å¦å‡†ç¡®ï¼Œå…·ä½“åšæ³•æ˜¯å–æ‰€æœ‰è¿è¡Œä¸­çš„Leaf-snowflakeèŠ‚ç‚¹çš„æœåŠ¡IPï¼šPortï¼Œç„¶åé€šè¿‡RPCè¯·æ±‚å¾—åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ç³»ç»Ÿæ—¶é—´ï¼Œè®¡ç®—sum(time)/nodeSizeï¼Œç„¶åçœ‹æœ¬æœºæ—¶é—´ä¸è¿™ä¸ªå¹³å‡å€¼æ˜¯å¦åœ¨é˜ˆå€¼ä¹‹å†…æ¥ç¡®å®šå½“å‰ç³»ç»Ÿæ—¶é—´æ˜¯å¦å‡†ç¡®ï¼Œå‡†ç¡®æ­£å¸¸å¯åŠ¨æœåŠ¡ï¼Œä¸å‡†ç¡®è®¤ä¸ºæœ¬æœºç³»ç»Ÿæ—¶é—´å‘ç”Ÿå¤§æ­¥é•¿åç§»ï¼Œå¯åŠ¨å¤±è´¥å¹¶æŠ¥è­¦ã€‚</p><p>2ã€åœ¨ZooKeeper ä¸­ç™»è®°è¿‡çš„è€èŠ‚ç‚¹ï¼ŒåŒæ ·ä¼šæ¯”è¾ƒè‡ªèº«ç³»ç»Ÿæ—¶é—´å’ŒZooKeeper ä¸Šæœ¬èŠ‚ç‚¹æ›¾ç»çš„è®°å½•æ—¶é—´ä»¥åŠæ‰€æœ‰è¿è¡Œä¸­çš„Leaf-snowflakeèŠ‚ç‚¹çš„æ—¶é—´ï¼Œä¸å‡†ç¡®åŒæ ·å¯åŠ¨å¤±è´¥å¹¶æŠ¥è­¦ã€‚</p><p>å¦å¤–ï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´èŠ‚ç‚¹éƒ½ä¼šä¸ŠæŠ¥è‡ªèº«ç³»ç»Ÿæ—¶é—´å†™å…¥ZooKeeper ã€‚</p><p><img src="/images/springcloud/1453b4e9.png" alt="img"></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//å‘ç”Ÿäº†å›æ‹¨ï¼Œæ­¤åˆ»æ—¶é—´å°äºä¸Šæ¬¡å‘å·æ—¶é—´</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  			  
            <span class="token keyword">long</span> offset <span class="token operator">=</span> lastTimestamp <span class="token operator">-</span> timestamp<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                	<span class="token comment">//æ—¶é—´åå·®å¤§å°å°äº5msï¼Œåˆ™ç­‰å¾…ä¸¤å€æ—¶é—´</span>
                    <span class="token function">wait</span><span class="token punctuation">(</span>offset <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//wait</span>
                    timestamp <span class="token operator">=</span> <span class="token function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       <span class="token comment">//è¿˜æ˜¯å°äºï¼ŒæŠ›å¼‚å¸¸å¹¶ä¸ŠæŠ¥</span>
                        <span class="token function">throwClockBackwardsEx</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span>    
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                   <span class="token keyword">throw</span>  e<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//throw</span>
                <span class="token function">throwClockBackwardsEx</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
 <span class="token comment">//åˆ†é…ID       </span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h2 id="å‚è€ƒ" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒ" aria-hidden="true">#</a> å‚è€ƒ</h2><p><a href="https://tech.meituan.com/2017/04/21/mt-leaf.html" target="_blank" rel="noopener noreferrer">Leafâ€”â€”ç¾å›¢ç‚¹è¯„åˆ†å¸ƒå¼IDç”Ÿæˆç³»ç»Ÿ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ (meituan.com)<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><!--]--></div><footer class="page-meta"><!----><!----><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> â† <a href="/SpringCloud/" class="nav-link router-link-active" aria-label="Back To ç›®å½•"><!--[--><!--]--> Back To ç›®å½• <!--[--><!--]--></a></span><!----></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.2c87fbe0.js" defer></script><script src="/assets/js/95615.aba5921d.js" defer></script><script src="/assets/js/app.4aafd1f6.js" defer></script>
  </body>
</html>
